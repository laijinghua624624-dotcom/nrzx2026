<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>内容中心排班 v2026</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- 添加EmailJS库 -->
    <script src="https://cdn.emailjs.com/dist/email.min.js"></script>
    <style>
        :root {
            --primary-color: #3498db;
            --secondary-color: #2ecc71;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --special-color: #9b59b6;
            --info-color: #1abc9c;
            --light-color: #ecf0f1;
            --dark-color: #34495e;
            --leave-color: #e67e22;
            --morning-color: #f1c40f;
            --evening-color: #8e44ad;
            --off-color: #95a5a6;
            --holiday-color: #f1c40f;
            --travel-color: #17a2b8;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f9fa;
            color: #333;
            padding-bottom: 2rem;
        }
        
        .header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 1.5rem 0;
            margin-bottom: 1.5rem;
            border-radius: 0 0 20px 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .card {
            border-radius: 12px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
            border: none;
            margin-bottom: 1.5rem;
            transition: transform 0.3s, box-shadow 0.3s;
        }
        
        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.1);
        }
        
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background-color: #dee2e6;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .calendar-header {
            background-color: var(--primary-color);
            color: white;
            padding: 0.75rem;
            text-align: center;
            font-weight: 600;
        }
        
        .calendar-day {
            background-color: white;
            padding: 0.75rem;
            min-height: 120px;
            border: 1px solid #e9ecef;
            position: relative;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .calendar-day:hover {
            background-color: #f8f9fa;
            transform: scale(1.02);
            z-index: 1;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .day-number {
            font-weight: bold;
            margin-bottom: 0.5rem;
            font-size: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .today {
            background-color: #e3f2fd;
            border: 2px solid var(--primary-color);
        }
        
        .weekend {
            background-color: #f8f9fa;
        }
        
        .holiday {
            background-color: rgba(241, 196, 15, 0.2) !important;
            border-left: 4px solid var(--holiday-color) !important;
        }
        
        .badge-morning {
            background-color: var(--morning-color);
            color: #333;
        }
        
        .badge-evening {
            background-color: var(--evening-color);
            color: white;
        }
        
        .badge-off {
            background-color: var(--off-color);
            color: #333;
        }
        
        .badge-travel {
            background-color: var(--travel-color);
            color: white;
        }
        
        .badge-holiday {
            background-color: var(--holiday-color);
            color: #333;
        }
        
        .btn-custom {
            border-radius: 8px;
            padding: 0.5rem 1rem;
        }
        
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1055;
        }
        
        .chart-container {
            position: relative;
            height: 300px;
            margin-bottom: 1rem;
        }
        
        .daily-schedule-detail {
            background-color: white;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-left: 4px solid var(--primary-color);
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            display: none;
        }
        
        .group-section {
            margin-bottom: 1.5rem;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .group-header {
            background-color: #f8f9fa;
            padding: 0.75rem 1rem;
            font-weight: 600;
            border-bottom: 1px solid #e9ecef;
        }
        
        /* 组别颜色 */
        .group-leader { background-color: rgba(155, 89, 182, 0.1) !important; border-left: 4px solid #9b59b6 !important; }
        .group-director { background-color: rgba(231, 76, 60, 0.1) !important; border-left: 4px solid #e74c3c !important; }
        .group-editor { background-color: rgba(52, 152, 219, 0.1) !important; border-left: 4px solid #3498db !important; }
        .group-camera { background-color: rgba(46, 204, 113, 0.1) !important; border-left: 4px solid #2ecc71 !important; }
        .group-flexible { background-color: rgba(243, 156, 18, 0.1) !important; border-left: 4px solid #f39c12 !important; }
        .group-design { background-color: rgba(26, 188, 156, 0.1) !important; border-left: 4px solid #1abc9c !important; }
        .group-travel { background-color: rgba(23, 162, 184, 0.1) !important; border-left: 4px solid #17a2b8 !important; }
        .group-custom1 { background-color: rgba(128, 0, 128, 0.1) !important; border-left: 4px solid #800080 !important; }
        .group-custom2 { background-color: rgba(255, 140, 0, 0.1) !important; border-left: 4px solid #FF8C00 !important; }
        
        /* 横向排班布局 */
        .horizontal-schedule {
            display: flex;
            flex-wrap: wrap;
            gap: 1.5rem;
        }
        
        .horizontal-group {
            flex: 1;
            min-width: 300px;
        }
        
        .horizontal-group-header {
            background-color: #f8f9fa;
            padding: 0.75rem;
            font-weight: 600;
            border-radius: 4px;
            margin-bottom: 0.75rem;
        }
        
        .schedule-row {
            display: flex;
            align-items: center;
        }
        
        .schedule-label {
            font-weight: 600;
            width: 80px;
            flex-shrink: 0;
        }
        
        .schedule-names {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }
        
        .schedule-name {
            font-size: 0.85rem;
            padding: 0.2rem 0.4rem;
            border-radius: 3px;
            background-color: white;
            border: 1px solid #e9ecef;
        }
        
        /* 组别配置样式 */
        .group-config-section {
            background-color: #f8f9fa;
            transition: all 0.3s ease;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        
        .group-config-section:hover {
            background-color: #f0f8ff;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .config-validation {
            font-size: 0.8rem;
            padding: 0.25rem 0.5rem;
            border-radius: 3px;
            background-color: rgba(0,0,0,0.02);
            margin-top: 0.5rem;
        }
        
        /* 工作天数指示器 */
        .work-days-indicator {
            font-size: 0.7rem;
            color: #666;
            margin-left: 0.5rem;
        }
        
        /* 紧凑版组别概览 */
        .compact-schedule {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
        }
        
        .compact-group {
            flex: 1;
            min-width: 300px;
        }
        
        .compact-group-header {
            background-color: #f8f9fa;
            padding: 0.5rem 0.75rem;
            font-weight: 600;
            border-radius: 4px;
            margin-bottom: 0.5rem;
        }
        
        .compact-group-members {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }
        
        .compact-member {
            display: flex;
            align-items: center;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            background-color: white;
            border: 1px solid #e9ecef;
        }
        
        /* 日历备注 */
        .calendar-note {
            position: absolute;
            bottom: 0.25rem;
            right: 0.25rem;
            font-size: 0.7rem;
            color: #666;
        }
        
        /* 批量操作区域 */
        .batch-actions {
            background-color: rgba(52, 152, 219, 0.05);
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
        }
        
        /* 详情页操作按钮 */
        .detail-actions {
            display: flex;
            justify-content: flex-end;
            margin-top: 1rem;
            gap: 0.5rem;
        }
        
        /* 统计数据卡片 */
        .stats-card {
            text-align: center;
            padding: 1rem;
        }
        
        .stats-value {
            font-size: 1.8rem;
            font-weight: bold;
            color: var(--primary-color);
        }
        
        .stats-label {
            font-size: 0.9rem;
            color: #666;
        }
        
        /* 节假日样式 */
        .holiday-item {
            background-color: rgba(241, 196, 15, 0.1);
            border-left: 4px solid var(--holiday-color) !important;
        }
        
        .travel-item {
            background-color: rgba(23, 162, 184, 0.1);
            border-left: 4px solid var(--travel-color) !important;
        }
        
        .holiday-calendar-day .day-number {
            color: #d35400;
            font-weight: bold;
        }
        
        /* 节假日设置样式 */
        .holiday-settings-section {
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            background-color: #f8f9fa;
        }
        
        /* 邮件设置样式 */
        .email-settings-section {
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        
        /* 组别概览收起/展开动画 */
        #groupOverviewBody {
            transition: opacity 0.3s ease, max-height 0.3s ease;
        }
        
        /* 成员工作强度指示条 */
        .work-intensity-bar {
            background-color: #e9ecef;
            border-radius: 3px;
            overflow: hidden;
        }
        
        /* 成员状态徽章 */
        .member-status-badge .badge {
            font-size: 0.6rem;
            padding: 0.1rem 0.3rem;
        }
        
        .travel-status-badge {
            font-size: 0.7rem;
            padding: 0.2rem 0.4rem;
        }
        
        /* 紧凑组成员信息 */
        .compact-member {
            padding: 0.5rem 0.75rem;
            border-radius: 6px;
            background-color: white;
            border: 1px solid #e9ecef;
            margin-bottom: 0.5rem;
            transition: all 0.2s ease;
        }
        
        .compact-member:hover {
            background-color: #f8f9fa;
            transform: translateX(2px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        .compact-member-info {
            flex: 1;
        }
        
        .member-name {
            font-weight: 600;
            font-size: 0.9rem;
        }
        
        .member-stats {
            font-size: 0.75rem;
        }
        
        .member-travel-indicator {
            color: #17a2b8;
            font-size: 0.7rem;
        }
        
        .compact-group-header {
            cursor: pointer;
            transition: all 0.2s ease;
            padding: 0.75rem 1rem;
            border-radius: 6px;
        }
        
        .compact-group-header:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .group-stats-badge .badge {
            font-size: 0.7rem;
            padding: 0.2rem 0.4rem;
        }
        
        /* 日历空日期样式 */
        .calendar-day.empty-day {
            background-color: #f8f9fa !important;
            color: #ccc !important;
            cursor: not-allowed !important;
        }
        
        .calendar-day.empty-day:hover {
            transform: none !important;
            box-shadow: none !important;
        }
        
        .calendar-day.empty-day .day-number {
            color: #ccc !important;
        }
        
        .empty-month-message {
            grid-column: 1 / -1;
            text-align: center;
            padding: 2rem;
            background-color: #f8f9fa;
            color: #6c757d;
            font-style: italic;
        }
        
        /* 节假日类型样式 */
        .holiday-public {
            background-color: rgba(231, 76, 60, 0.1) !important;
            border-left: 4px solid #e74c3c !important;
        }
        
        .holiday-company {
            background-color: rgba(52, 152, 219, 0.1) !important;
            border-left: 4px solid #3498db !important;
        }
        
        .holiday-rest {
            background-color: rgba(46, 204, 113, 0.1) !important;
            border-left: 4px solid #2ecc71 !important;
        }
        
        .holiday-event {
            background-color: rgba(155, 89, 182, 0.1) !important;
            border-left: 4px solid #9b59b6 !important;
        }
        
        /* 节假日设置表单样式 */
        .holiday-duty-section {
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 1rem;
            background-color: white;
            margin-top: 1rem;
        }
        
        .duty-employees-container {
            background-color: #f8f9fa;
        }
        
        /* 节假日筛选按钮组 */
        .btn-group .btn.active {
            background-color: #3498db;
            color: white;
            border-color: #3498db;
        }
        
        /* 值班组别选项样式 */
        .duty-group-options, .rotation-group-order {
            max-height: 200px;
            overflow-y: auto;
        }
        
        .rotation-group-item {
            cursor: move;
        }
        
        /* 组别管理样式 */
        .group-management-section {
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            background-color: #f8f9fa;
        }
        
        .group-management-section .card {
            margin-bottom: 0;
        }
        
        .group-management-section .card-header {
            background-color: #e9ecef;
            border-bottom: 1px solid #dee2e6;
        }
        
        /* 响应式设计 */
        @media (max-width: 768px) {
            .calendar-grid {
                grid-template-columns: repeat(1, 1fr);
            }
            
            .calendar-day {
                min-height: 100px;
            }
            
            .horizontal-schedule, .compact-schedule {
                flex-direction: column;
            }
            
            .horizontal-group, .compact-group {
                min-width: 100%;
            }
            
            .detail-actions {
                flex-direction: column;
            }
            
            .header .action-buttons {
                flex-wrap: wrap;
            }
            
            .header .action-buttons .btn {
                margin-bottom: 5px;
            }
            
            .holiday-item .d-flex {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .holiday-item .d-flex > div:last-child {
                margin-top: 0.5rem;
                align-self: flex-end;
            }
            
            .compact-member {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .member-indicators {
                width: 100%;
                margin-top: 0.5rem;
                display: flex;
                justify-content: space-between;
                align-items: center;
            }
            
            .work-intensity-bar {
                width: 100px;
            }
            
            .duty-group-options, .rotation-group-order {
                max-height: 150px;
            }
            
            .group-management-section .row {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <!-- 加载指示器 -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="text-center">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">加载中...</span>
            </div>
            <p class="mt-2">处理中，请稍候...</p>
        </div>
    </div>

    <div class="header">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <h1 class="h3 mb-1">部门智能排班管理系统 v4.2</h1>
                    <p class="mb-0 small opacity-90">自动排班 · 公平分配 · 请假顶班 · 节假日设置 · 出差管理 · 邮件通知 · 组别管理</p>
                </div>
                <div class="col-md-6 text-end">
                    <div class="real-time-clock mb-2">
                        <i class="fas fa-clock me-2"></i>
                        <span id="currentDateTime">正在同步时间...</span>
                    </div>
                    <div class="action-buttons d-flex gap-2 justify-content-end">
                        <button class="btn btn-light btn-custom" id="sendNotificationBtn">
                            <i class="fas fa-paper-plane me-1"></i>发送通知
                        </button>
                        <button class="btn btn-light btn-custom" data-bs-toggle="modal" data-bs-target="#notificationModal">
                            <i class="fas fa-bell me-1"></i>
                            消息 <span class="badge bg-danger" id="notificationCount">0</span>
                        </button>
                        <button class="btn btn-light btn-custom" data-bs-toggle="modal" data-bs-target="#systemConfigModal">
                            <i class="fas fa-cog me-1"></i>系统设置
                        </button>
                        <button class="btn btn-light btn-custom" id="backupDataBtn">
                            <i class="fas fa-save me-1"></i>数据备份
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- 月份导航 -->
        <div class="calendar-controls mb-4">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <div class="month-navigator d-inline-flex align-items-center">
                        <button class="btn btn-sm btn-outline-primary me-3" id="prevMonth">
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        <div class="current-month" id="currentMonth">2026年1月</div>
                        <button class="btn btn-sm btn-outline-primary ms-3" id="nextMonth">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                        <button class="btn btn-sm btn-success quick-schedule-btn" id="quickScheduleBtn">
                            <i class="fas fa-bolt me-1"></i>智能排班
                        </button>
                        <button class="btn btn-sm btn-info ms-2" id="sendEmailScheduleBtn">
                            <i class="fas fa-envelope me-1"></i>邮件通知
                        </button>
                    </div>
                </div>
                <div class="col-md-4 text-end">
                    <button class="btn btn-outline-primary btn-sm" id="sendDailyNotifications">
                        <i class="fas fa-paper-plane me-1"></i>发送今日排班通知
                    </button>
                    <button class="btn btn-outline-warning btn-sm ms-2" id="batchOperationsBtn" data-bs-toggle="modal" data-bs-target="#batchOperationsModal">
                        <i class="fas fa-tasks me-1"></i>批量操作
                    </button>
                </div>
            </div>
        </div>

        <!-- 批量操作区域 -->
        <div class="batch-actions" id="batchActions" style="display: none;">
            <h6 class="mb-3">批量操作</h6>
            <div class="row">
                <div class="col-md-4">
                    <div class="mb-3">
                        <label class="form-label">选择日期范围</label>
                        <div class="input-group">
                            <input type="date" class="form-control" id="batchStartDate">
                            <span class="input-group-text">至</span>
                            <input type="date" class="form-control" id="batchEndDate">
                        </div>
                        <div class="invalid-feedback" id="batchDateError">请选择有效的日期范围</div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="mb-3">
                        <label class="form-label">选择操作</label>
                        <select class="form-select" id="batchAction">
                            <option value="set_off">设为空闲</option>
                            <option value="set_normal">设为正常班</option>
                            <option value="set_evening">设为晚班</option>
                        </select>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="mb-3">
                        <label class="form-label">选择组别</label>
                        <select class="form-select" id="batchGroup">
                            <option value="all">所有组别</option>
                            <option value="leader">负责人组</option>
                            <option value="director">编导组</option>
                            <option value="editor">剪辑组</option>
                            <option value="camera">摄像组</option>
                            <option value="flexible">机动组</option>
                            <option value="design">设计组</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="d-flex justify-content-end">
                <button class="btn btn-secondary btn-sm me-2" id="cancelBatchAction">取消</button>
                <button class="btn btn-primary btn-sm" id="applyBatchAction">应用</button>
            </div>
        </div>

        <!-- 当日排班详情 - 横向排版 -->
        <div class="daily-schedule-detail" id="dailyScheduleDetail" style="display: none;">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 id="dailyScheduleTitle">当日排班详情</h5>
                <div class="detail-actions">
                    <button class="btn btn-sm btn-outline-primary" id="editDailyScheduleBtn">
                        <i class="fas fa-edit me-1"></i>编辑排班
                    </button>
                    <button class="btn btn-sm btn-info" id="sendEmailForDayBtn">
                        <i class="fas fa-envelope me-1"></i>发送邮件
                    </button>
                    <button class="btn btn-sm btn-outline-secondary" id="closeDailyScheduleBtn">
                        <i class="fas fa-times me-1"></i>关闭
                    </button>
                </div>
            </div>
            <div class="horizontal-schedule" id="dailyScheduleContent">
                <!-- 这里将通过JavaScript动态填充 -->
            </div>
        </div>

        <div class="row">
            <div class="col-lg-9">
                <!-- 月度排班日历 -->
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span>月度排班日历</span>
                        <div class="d-flex gap-3">
                            <span class="badge bg-primary">正常班</span>
                            <span class="badge bg-purple">晚班</span>
                            <span class="badge bg-secondary">空闲</span>
                            <span class="badge bg-info">顶班</span>
                            <span class="badge bg-warning">请假</span>
                            <span class="badge bg-travel">出差</span>
                            <span class="badge bg-holiday">节假日</span>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div class="calendar-grid" id="calendarGrid"></div>
                    </div>
                </div>
                
                <!-- 本月排班数据统计 -->
                <div class="row">
                    <div class="col-md-12">
                        <div class="card">
                            <div class="card-header">
                                <i class="fas fa-chart-bar me-2"></i>本月排班数据统计
                            </div>
                            <div class="card-body">
                                <div class="row text-center">
                                    <div class="col-6 col-md-3 mb-3">
                                        <div class="stats-card">
                                            <div class="stats-value" id="totalWorkDays">0</div>
                                            <div class="stats-label">总工作日</div>
                                        </div>
                                    </div>
                                    <div class="col-6 col-md-3 mb-3">
                                        <div class="stats-card">
                                            <div class="stats-value" id="totalReplacements">0</div>
                                            <div class="stats-label">顶班次数</div>
                                        </div>
                                    </div>
                                    <div class="col-6 col-md-3 mb-3">
                                        <div class="stats-card">
                                            <div class="stats-value" id="totalLeaves">0</div>
                                            <div class="stats-label">请假次数</div>
                                        </div>
                                    </div>
                                    <div class="col-6 col-md-3 mb-3">
                                        <div class="stats-card">
                                            <div class="stats-value" id="totalTravels">0</div>
                                            <div class="stats-label">出差人次</div>
                                        </div>
                                    </div>
                                    <div class="col-12">
                                        <div class="stats-card">
                                            <div class="stats-value" id="fairnessScore">0%</div>
                                            <div class="stats-label">排班公平度</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 部门组别概览 - 紧凑版（已添加收起/展开功能） -->
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <div>
                            <i class="fas fa-users me-2"></i>部门组别概览
                            <span class="badge bg-secondary ms-2" id="groupCountBadge">6个组</span>
                        </div>
                        <div class="d-flex gap-2 align-items-center">
                            <button class="btn btn-sm btn-outline-secondary" id="toggleGroupOverview">
                                <i class="fas fa-chevron-up" id="groupOverviewIcon"></i>
                                <span id="groupOverviewText">收起</span>
                            </button>
                            <button class="btn btn-sm btn-outline-primary" id="refreshGroupOverview">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                        </div>
                    </div>
                    <div class="card-body" id="groupOverviewBody">
                        <div class="compact-schedule" id="groupOverviewContainer">
                            <!-- 这里将通过JavaScript动态填充 -->
                        </div>
                    </div>
                </div>
                
                <!-- 排班历史记录 -->
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-history me-2"></i>排班历史记录
                    </div>
                    <div class="card-body">
                        <div id="scheduleHistory">
                            <p class="text-muted small mb-0">暂无历史记录</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-lg-3">
                <!-- 次日排班预览 -->
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-calendar-day me-2"></i>明日排班预览
                    </div>
                    <div class="card-body">
                        <div id="nextDaySchedulePreview">
                            <p class="text-muted small mb-0">加载中...</p>
                        </div>
                    </div>
                </div>
                
                <!-- 最近调整记录 -->
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-sync-alt me-2"></i>最近调整记录
                    </div>
                    <div class="card-body">
                        <div id="adjustmentRecords">
                            <p class="text-muted small mb-0">暂无调整记录</p>
                        </div>
                    </div>
                </div>
                
                <!-- 待发送通知 -->
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-bell me-2"></i>待发送通知
                    </div>
                    <div class="card-body">
                        <div id="pendingNotifications">
                            <p class="text-muted small mb-0">暂无待发送通知</p>
                        </div>
                    </div>
                </div>
                
                <!-- 紧急联系人 -->
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-phone-alt me-2"></i>紧急联系人
                    </div>
                    <div class="card-body">
                        <div id="emergencyContacts">
                            <div class="emergency-contact p-2 border rounded bg-light">
                                <strong>范伟森</strong>
                                <div class="small">电话: 13800138000</div>
                                <div class="small">职责: 负责人组协调</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 系统状态 -->
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-info-circle me-2"></i>系统状态
                    </div>
                    <div class="card-body">
                        <div class="small">
                            <div class="d-flex justify-content-between mb-2">
                                <span>数据完整性:</span>
                                <span class="badge bg-success" id="dataIntegrityStatus">正常</span>
                            </div>
                            <div class="d-flex justify-content-between mb-2">
                                <span>最后备份:</span>
                                <span id="lastBackupTime">从未备份</span>
                            </div>
                            <div class="d-flex justify-content-between mb-2">
                                <span>邮件功能:</span>
                                <span id="emailStatus">未配置</span>
                            </div>
                            <div class="d-flex justify-content-between">
                                <span>系统版本:</span>
                                <span>v4.2</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 日期详情模态框 -->
    <div class="modal fade day-detail-modal" id="dayDetailModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="dayDetailTitle">日期详情</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <h6>基本信息</h6>
                            <p id="dayBasicInfo" class="text-muted"></p>
                        </div>
                        <div class="col-md-6">
                            <h6>顶班情况</h6>
                            <div id="replacementInfo"></div>
                        </div>
                    </div>
                    
                    <!-- 自定义备注 -->
                    <div class="mb-4">
                        <h6>自定义备注</h6>
                        <textarea class="form-control" id="dayNote" rows="2" placeholder="添加备注..."></textarea>
                        <div class="form-text">此备注将显示在日历上</div>
                    </div>
                    
                    <!-- 请假申请表单 -->
                    <div class="leave-form mb-4" id="leaveFormSection" style="display: none;">
                        <h6>请假申请</h6>
                        <div class="mb-3">
                            <label for="leaveReason" class="form-label">请假原因</label>
                            <textarea class="form-control" id="leaveReason" rows="3" placeholder="请输入请假原因..." required></textarea>
                            <div class="invalid-feedback">请输入请假原因</div>
                        </div>
                        <div class="mb-3">
                            <label for="leaveType" class="form-label">请假类型</label>
                            <select class="form-select" id="leaveType" required>
                                <option value="年假">年假</option>
                                <option value="病假">病假</option>
                                <option value="事假">事假</option>
                                <option value="调休">调休</option>
                                <option value="其他">其他</option>
                            </select>
                            <div class="invalid-feedback">请选择请假类型</div>
                        </div>
                        <div class="d-flex justify-content-end">
                            <button type="button" class="btn btn-outline-secondary me-2" id="cancelLeave">取消</button>
                            <button type="button" class="btn btn-warning" id="submitLeave">提交请假申请</button>
                        </div>
                    </div>
                    
                    <h6>部门排班设置</h6>
                    <div id="departmentStatusList"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-outline-primary" id="saveDayChanges">保存</button>
                    <button type="button" class="btn btn-primary" id="saveAndNotifyDayChanges">保存并发送通知</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 系统设置模态框 -->
    <div class="modal fade" id="systemConfigModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">系统设置</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <ul class="nav nav-tabs" id="systemConfigTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="basic-settings-tab" data-bs-toggle="tab" data-bs-target="#basic-settings" type="button" role="tab">基本设置</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="group-settings-tab" data-bs-toggle="tab" data-bs-target="#group-settings" type="button" role="tab">组别排班配置</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="holiday-settings-tab" data-bs-toggle="tab" data-bs-target="#holiday-settings" type="button" role="tab">节假日设置</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="travel-settings-tab" data-bs-toggle="tab" data-bs-target="#travel-settings" type="button" role="tab">出差设置</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="email-settings-tab" data-bs-toggle="tab" data-bs-target="#email-settings" type="button" role="tab">邮件设置</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="employee-management-tab" data-bs-toggle="tab" data-bs-target="#employee-management" type="button" role="tab">人员管理</button>
                        </li>
                    </ul>
                    <div class="tab-content p-3" id="systemConfigTabsContent">
                        <!-- 基本设置 -->
                        <div class="tab-pane fade show active" id="basic-settings" role="tabpanel">
                            <form id="systemConfigForm">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="normalStartTime" class="form-label">正常班开始时间</label>
                                            <input type="time" class="form-control" id="normalStartTime" value="10:00">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="normalEndTime" class="form-label">正常班结束时间</label>
                                            <input type="time" class="form-control" id="normalEndTime" value="19:00">
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="eveningStartTime" class="form-label">晚班开始时间</label>
                                            <input type="time" class="form-control" id="eveningStartTime" value="17:00">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="eveningEndTime" class="form-label">晚班结束时间</label>
                                            <input type="time" class="form-control" id="eveningEndTime" value="00:00">
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="fairnessThreshold" class="form-label">公平度阈值 (%)</label>
                                            <input type="number" class="form-control" id="fairnessThreshold" min="80" max="100" value="90">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3 pt-4">
                                            <div class="form-check">
                                                <input type="checkbox" class="form-check-input" id="autoReplacement" checked>
                                                <label class="form-check-label" for="autoReplacement">自动顶班</label>
                                            </div>
                                            <div class="form-check">
                                                <input type="checkbox" class="form-check-input" id="autoNotifications" checked>
                                                <label class="form-check-label" for="autoNotifications">自动发送通知</label>
                                            </div>
                                            <div class="form-check">
                                                <input type="checkbox" class="form-check-input" id="conflictDetection" checked>
                                                <label class="form-check-label" for="conflictDetection">启用冲突检测</label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- 自动通知设置 -->
                                <div class="auto-notification-section mt-4 border-top pt-3">
                                    <h6>自动通知设置</h6>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3 form-check">
                                                <input type="checkbox" class="form-check-input" id="enableAutoNotifications" checked>
                                                <label class="form-check-label" for="enableAutoNotifications">启用每日自动通知</label>
                                            </div>
                                            <div class="mb-3">
                                                <label for="autoNotificationTime" class="form-label">发送时间</label>
                                                <input type="time" class="form-control" id="autoNotificationTime" value="17:00">
                                                <div class="form-text">每天此时自动发送次日排班安排</div>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="notificationAdvanceDays" class="form-label">提前通知天数</label>
                                                <select class="form-select" id="notificationAdvanceDays">
                                                    <option value="1" selected>提前1天 (次日安排)</option>
                                                    <option value="2">提前2天</option>
                                                    <option value="3">提前3天</option>
                                                </select>
                                            </div>
                                            <div class="form-check">
                                                <input type="checkbox" class="form-check-input" id="sendSMSAuto" checked>
                                                <label class="form-check-label" for="sendSMSAuto">发送短信通知</label>
                                            </div>
                                            <div class="form-check">
                                                <input type="checkbox" class="form-check-input" id="sendEmailAuto" checked>
                                                <label class="form-check-label" for="sendEmailAuto">发送邮件通知</label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- 数据备份和恢复 -->
                                <div class="backup-section mt-4 border-top pt-3">
                                    <h6>数据管理</h6>
                                    <div class="mb-3">
                                        <button type="button" class="btn btn-outline-primary btn-sm w-100 mb-2" id="exportDataBtn">
                                            <i class="fas fa-download me-1"></i>导出数据
                                        </button>
                                        <button type="button" class="btn btn-outline-warning btn-sm w-100" id="importDataBtn">
                                            <i class="fas fa-upload me-1"></i>导入数据
                                        </button>
                                        <input type="file" id="importDataFile" accept=".json" style="display: none;">
                                    </div>
                                </div>
                            </form>
                        </div>
                        
                        <!-- 组别排班配置 -->
                        <div class="tab-pane fade" id="group-settings" role="tabpanel">
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle me-2"></i>
                                调整每个组别每日安排的正常班和晚班人数。保存后，系统将根据新配置重新生成排班。
                            </div>
                            
                            <!-- 组别管理部分 -->
                            <div class="group-management-section mb-4">
                                <h6 class="mb-3">组别管理</h6>
                                
                                <div class="row mb-4">
                                    <div class="col-md-6">
                                        <div class="card">
                                            <div class="card-header">
                                                <i class="fas fa-plus-circle me-2"></i>添加新组别
                                            </div>
                                            <div class="card-body">
                                                <form id="addGroupForm">
                                                    <div class="mb-3">
                                                        <label for="newGroupId" class="form-label">组别ID（英文标识）</label>
                                                        <input type="text" class="form-control" id="newGroupId" 
                                                               placeholder="例如：sound, assistant" required>
                                                        <div class="form-text small">使用英文字母，用于内部标识</div>
                                                    </div>
                                                    <div class="mb-3">
                                                        <label for="newGroupName" class="form-label">组别名称</label>
                                                        <input type="text" class="form-control" id="newGroupName" 
                                                               placeholder="例如：音效组、助理组" required>
                                                    </div>
                                                    <div class="mb-3">
                                                        <label for="newGroupColor" class="form-label">组别颜色</label>
                                                        <select class="form-select" id="newGroupColor" required>
                                                            <option value="group-leader">紫色 (负责人组)</option>
                                                            <option value="group-director">红色 (编导组)</option>
                                                            <option value="group-editor">蓝色 (剪辑组)</option>
                                                            <option value="group-camera">绿色 (摄像组)</option>
                                                            <option value="group-flexible">橙色 (机动组)</option>
                                                            <option value="group-design">青色 (设计组)</option>
                                                            <option value="group-travel">浅蓝 (出差组)</option>
                                                            <option value="group-custom1">深紫色</option>
                                                            <option value="group-custom2">深橙色</option>
                                                        </select>
                                                    </div>
                                                    <div class="row mb-3">
                                                        <div class="col-md-6">
                                                            <label for="newGroupNormalCount" class="form-label">默认正常班人数</label>
                                                            <input type="number" class="form-control" id="newGroupNormalCount" 
                                                                   value="2" min="0" max="10" required>
                                                        </div>
                                                        <div class="col-md-6">
                                                            <label for="newGroupEveningCount" class="form-label">默认晚班人数</label>
                                                            <input type="number" class="form-control" id="newGroupEveningCount" 
                                                                   value="1" min="0" max="10" required>
                                                        </div>
                                                    </div>
                                                    <button type="submit" class="btn btn-success w-100">
                                                        <i class="fas fa-plus me-1"></i>添加组别
                                                    </button>
                                                </form>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-6">
                                        <div class="card">
                                            <div class="card-header">
                                                <i class="fas fa-edit me-2"></i>修改组别名称
                                            </div>
                                            <div class="card-body">
                                                <div class="mb-3">
                                                    <label for="editGroupSelect" class="form-label">选择要修改的组别</label>
                                                    <select class="form-select" id="editGroupSelect">
                                                        <option value="">请选择组别</option>
                                                        <!-- 组别选项将通过JavaScript动态填充 -->
                                                    </select>
                                                </div>
                                                <div class="mb-3">
                                                    <label for="editGroupName" class="form-label">新组别名称</label>
                                                    <input type="text" class="form-control" id="editGroupName" 
                                                           placeholder="输入新组别名称" disabled>
                                                </div>
                                                <div class="mb-3">
                                                    <label for="editGroupColor" class="form-label">修改颜色（可选）</label>
                                                    <select class="form-select" id="editGroupColor" disabled>
                                                        <option value="">保持原颜色</option>
                                                        <option value="group-leader">紫色 (负责人组)</option>
                                                        <option value="group-director">红色 (编导组)</option>
                                                        <option value="group-editor">蓝色 (剪辑组)</option>
                                                        <option value="group-camera">绿色 (摄像组)</option>
                                                        <option value="group-flexible">橙色 (机动组)</option>
                                                        <option value="group-design">青色 (设计组)</option>
                                                        <option value="group-travel">浅蓝 (出差组)</option>
                                                        <option value="group-custom1">深紫色</option>
                                                        <option value="group-custom2">深橙色</option>
                                                    </select>
                                                </div>
                                                <button type="button" class="btn btn-primary w-100" id="saveGroupNameBtn" disabled>
                                                    <i class="fas fa-save me-1"></i>保存修改
                                                </button>
                                                <button type="button" class="btn btn-outline-danger mt-2 w-100" id="removeGroupBtn" disabled>
                                                    <i class="fas fa-trash me-1"></i>删除组别
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 各组排班配置部分 -->
                            <div class="row">
                                <div class="col-md-12">
                                    <h6 class="mb-3">各组排班配置</h6>
                                    
                                    <div id="groupScheduleConfigs">
                                        <!-- 这里将通过JavaScript动态生成配置表单 -->
                                    </div>
                                    
                                    <div class="mt-3">
                                        <button class="btn btn-primary" id="saveGroupConfigs">
                                            <i class="fas fa-save me-1"></i>保存组别配置
                                        </button>
                                        <button class="btn btn-outline-secondary ms-2" id="resetGroupConfigs">
                                            <i class="fas fa-undo me-1"></i>恢复默认
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 节假日设置（更新版） -->
                        <div class="tab-pane fade" id="holiday-settings" role="tabpanel">
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle me-2"></i>
                                设置节假日或集体休息日，系统在这些日期会自动调整排班安排。您还可以为节假日设置值班人员。
                            </div>
                            
                            <div class="row">
                                <div class="col-md-12">
                                    <h6 class="mb-3">节假日管理</h6>
                                    
                                    <!-- 添加节假日表单 -->
                                    <div class="holiday-settings-section">
                                        <div class="d-flex justify-content-between align-items-center mb-3">
                                            <h6 class="mb-0">添加节假日/休息日</h6>
                                            <button class="btn btn-sm btn-success" id="showHolidayFormBtn">
                                                <i class="fas fa-plus me-1"></i>添加
                                            </button>
                                        </div>
                                        
                                        <form id="holidaySettingsForm" class="needs-validation" novalidate style="display: none;">
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <div class="mb-3">
                                                        <label for="holidayName" class="form-label">节假日名称</label>
                                                        <input type="text" class="form-control" id="holidayName" 
                                                               placeholder="例如：春节、国庆节、公司年会" required>
                                                        <div class="invalid-feedback">请输入节假日名称</div>
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    <div class="mb-3">
                                                        <label for="holidayType" class="form-label">类型</label>
                                                        <select class="form-select" id="holidayType" required>
                                                            <option value="public">法定节假日</option>
                                                            <option value="company">公司假日</option>
                                                            <option value="rest">集体休息日</option>
                                                            <option value="event">公司活动</option>
                                                        </select>
                                                        <div class="invalid-feedback">请选择类型</div>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <div class="mb-3">
                                                        <label for="holidayStartDate" class="form-label">开始日期</label>
                                                        <input type="date" class="form-control" id="holidayStartDate" required>
                                                        <div class="invalid-feedback">请选择开始日期</div>
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    <div class="mb-3">
                                                        <label for="holidayEndDate" class="form-label">结束日期</label>
                                                        <input type="date" class="form-control" id="holidayEndDate" required>
                                                        <div class="invalid-feedback">请选择结束日期</div>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <div class="row">
                                                <div class="col-md-12">
                                                    <div class="mb-3">
                                                        <label for="holidayDescription" class="form-label">描述</label>
                                                        <textarea class="form-control" id="holidayDescription" rows="3" 
                                                                  placeholder="节假日的具体说明..."></textarea>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <!-- 节假日值班设置 -->
                                            <div class="holiday-duty-section mb-4">
                                                <h6 class="mb-3">节假日值班设置</h6>
                                                <div class="alert alert-warning small">
                                                    <i class="fas fa-exclamation-circle me-2"></i>
                                                    如需要安排值班人员，请在此设置。不设置则默认全体休息。
                                                </div>
                                                
                                                <div class="row mb-3">
                                                    <div class="col-md-6">
                                                        <div class="form-check mb-2">
                                                            <input class="form-check-input" type="checkbox" id="enableHolidayDuty">
                                                            <label class="form-check-label" for="enableHolidayDuty">
                                                                启用节假日值班
                                                            </label>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-6">
                                                        <div class="form-check mb-2">
                                                            <input class="form-check-input" type="checkbox" id="isRecurringHoliday" checked>
                                                            <label class="form-check-label" for="isRecurringHoliday">
                                                                每年重复
                                                            </label>
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                <!-- 值班人员安排 -->
                                                <div id="holidayDutySelection" style="display: none;">
                                                    <div class="row mb-3">
                                                        <div class="col-md-6">
                                                            <div class="mb-3">
                                                                <label for="dutyGroupType" class="form-label">值班组别类型</label>
                                                                <select class="form-select" id="dutyGroupType">
                                                                    <option value="specific">指定组别值班</option>
                                                                    <option value="all">所有组别值班</option>
                                                                    <option value="rotate">轮换组别值班</option>
                                                                </select>
                                                            </div>
                                                        </div>
                                                        <div class="col-md-6">
                                                            <div class="mb-3 pt-4">
                                                                <div class="form-check">
                                                                    <input type="checkbox" class="form-check-input" id="autoAssignDuty" checked>
                                                                    <label class="form-check-label" for="autoAssignDuty">
                                                                        自动分配值班人员
                                                                    </label>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    
                                                    <!-- 指定组别选择 -->
                                                    <div class="row mb-3" id="dutyGroupSelection" style="display: none;">
                                                        <div class="col-md-12">
                                                            <label class="form-label mb-2">选择值班组别（可多选）</label>
                                                            <div id="dutyGroupOptions" class="duty-group-options border rounded p-3 mb-3">
                                                                <!-- 组别选项将通过JavaScript动态生成 -->
                                                            </div>
                                                        </div>
                                                    </div>
                                                    
                                                    <!-- 轮换组别设置 -->
                                                    <div class="row mb-3" id="rotationGroupSection" style="display: none;">
                                                        <div class="col-md-12">
                                                            <label class="form-label mb-2">设置轮换组别顺序</label>
                                                            <div id="rotationGroupOrder" class="rotation-group-order border rounded p-3">
                                                                <!-- 轮换组别顺序将通过JavaScript动态生成 -->
                                                            </div>
                                                        </div>
                                                    </div>
                                                    
                                                    <!-- 值班人员选择 -->
                                                    <div class="row mb-3" id="dutyEmployeeSelection">
                                                        <div class="col-md-12">
                                                            <div class="d-flex justify-content-between align-items-center mb-2">
                                                                <label class="form-label mb-0">选择值班人员（可多选）</label>
                                                                <button type="button" class="btn btn-sm btn-outline-secondary" id="selectAllDutyEmployees">
                                                                    全选
                                                                </button>
                                                            </div>
                                                            <div class="duty-employees-container border rounded p-3" 
                                                                 style="max-height: 200px; overflow-y: auto;">
                                                                <!-- 这里将通过JavaScript动态生成员工选择列表 -->
                                                                <p class="text-muted small mb-0">请先选择值班组别类型</p>
                                                            </div>
                                                            <div class="form-text">值班人员将在节假日期间正常工作，其他人员休息</div>
                                                        </div>
                                                    </div>
                                                    
                                                    <!-- 值班班次设置 -->
                                                    <div class="row mt-3">
                                                        <div class="col-md-6">
                                                            <div class="mb-3">
                                                                <label for="dutyShiftType" class="form-label">值班班次</label>
                                                                <select class="form-select" id="dutyShiftType">
                                                                    <option value="normal">正常班</option>
                                                                    <option value="evening">晚班</option>
                                                                    <option value="flexible">弹性值班</option>
                                                                </select>
                                                            </div>
                                                        </div>
                                                        <div class="col-md-6">
                                                            <div class="mb-3">
                                                                <label for="dutyHours" class="form-label">值班时长</label>
                                                                <select class="form-select" id="dutyHours">
                                                                    <option value="full">全天</option>
                                                                    <option value="half">半天</option>
                                                                    <option value="flexible">弹性时间</option>
                                                                </select>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    
                                                    <!-- 值班备注 -->
                                                    <div class="row">
                                                        <div class="col-md-12">
                                                            <div class="mb-3">
                                                                <label for="dutyNotes" class="form-label">值班说明</label>
                                                                <textarea class="form-control" id="dutyNotes" rows="2" 
                                                                          placeholder="值班人员的特殊要求或说明..."></textarea>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <div class="d-flex justify-content-end">
                                                <button type="button" class="btn btn-secondary me-2" id="cancelHolidayForm">取消</button>
                                                <button type="submit" class="btn btn-primary">保存节假日</button>
                                            </div>
                                        </form>
                                    </div>
                                    
                                    <!-- 节假日列表 -->
                                    <div class="mt-4">
                                        <div class="d-flex justify-content-between align-items-center mb-3">
                                            <h6 class="mb-0">已设置的节假日</h6>
                                            <div class="btn-group">
                                                <button type="button" class="btn btn-sm btn-outline-secondary active" id="filterAllHolidays">
                                                    全部
                                                </button>
                                                <button type="button" class="btn btn-sm btn-outline-secondary" id="filterUpcomingHolidays">
                                                    即将到来
                                                </button>
                                                <button type="button" class="btn btn-sm btn-outline-secondary" id="filterPastHolidays">
                                                    已过去
                                                </button>
                                            </div>
                                        </div>
                                        
                                        <div id="holidaySettingsList" style="max-height: 400px; overflow-y: auto;">
                                            <!-- 节假日列表将在这里动态生成 -->
                                            <p class="text-muted small mb-0">暂无节假日设置</p>
                                        </div>
                                    </div>
                                    
                                    <!-- 节假日排班规则 -->
                                    <div class="border-top pt-3 mt-4">
                                        <h6 class="mb-3">节假日排班规则</h6>
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label for="holidayScheduleMode" class="form-label">默认排班模式</label>
                                                    <select class="form-select" id="holidayScheduleMode">
                                                        <option value="minimal">最小值班模式（只安排值班人员）</option>
                                                        <option value="custom">自定义值班（按设置的排班）</option>
                                                        <option value="off">全体休息（不安排任何人）</option>
                                                        <option value="normal">正常排班（按日常配置）</option>
                                                    </select>
                                                    <div class="form-text">设置没有特定值班安排的节假日的默认排班方式</div>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="mb-3 pt-4">
                                                    <div class="form-check">
                                                        <input type="checkbox" class="form-check-input" id="autoGenerateHolidaySchedule" checked>
                                                        <label class="form-check-label" for="autoGenerateHolidaySchedule">
                                                            自动生成节假日排班
                                                        </label>
                                                    </div>
                                                    <div class="form-check">
                                                        <input type="checkbox" class="form-check-input" id="excludeHolidayFromFairness" checked>
                                                        <label class="form-check-label" for="excludeHolidayFromFairness">
                                                            节假日不计入公平度计算
                                                        </label>
                                                    </div>
                                                    <div class="form-check">
                                                        <input type="checkbox" class="form-check-input" id="sendHolidayNotifications" checked>
                                                        <label class="form-check-label" for="sendHolidayNotifications">
                                                            发送节假日通知
                                                        </label>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 出差设置 -->
                        <div class="tab-pane fade" id="travel-settings" role="tabpanel">
                            <div class="alert alert-info">
                                <i class="fas fa-plane me-2"></i>
                                设置员工出差信息，出差期间员工不参与正常排班。系统会自动重新调整受影响日期的排班。
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <h6 class="mb-3">添加出差安排</h6>
                                    <form id="travelForm" class="needs-validation" novalidate>
                                        <div class="mb-3">
                                            <label for="travelEmployee" class="form-label">选择员工</label>
                                            <select class="form-select" id="travelEmployee" required>
                                                <option value="">请选择员工</option>
                                                <!-- 员工选项将通过JavaScript动态填充 -->
                                            </select>
                                            <div class="invalid-feedback">请选择员工</div>
                                        </div>
                                        
                                        <div class="row mb-3">
                                            <div class="col-md-6">
                                                <label for="travelStartDate" class="form-label">开始日期</label>
                                                <input type="date" class="form-control" id="travelStartDate" required>
                                                <div class="invalid-feedback">请选择开始日期</div>
                                            </div>
                                            <div class="col-md-6">
                                                <label for="travelEndDate" class="form-label">结束日期</label>
                                                <input type="date" class="form-control" id="travelEndDate" required>
                                                <div class="invalid-feedback">请选择结束日期</div>
                                            </div>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label for="travelReason" class="form-label">出差事由</label>
                                            <textarea class="form-control" id="travelReason" rows="3" placeholder="请输入出差事由..." required></textarea>
                                            <div class="invalid-feedback">请输入出差事由</div>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label for="travelDestination" class="form-label">出差地点</label>
                                            <input type="text" class="form-control" id="travelDestination" placeholder="例如：北京、上海等">
                                        </div>
                                        
                                        <div class="mb-3">
                                            <div class="form-check">
                                                <input type="checkbox" class="form-check-input" id="travelEmergencyContact" checked>
                                                <label class="form-check-label" for="travelEmergencyContact">提供紧急联系方式</label>
                                            </div>
                                            <div class="form-text">出差期间需要提供紧急联系方式</div>
                                        </div>
                                        
                                        <button type="submit" class="btn btn-primary">
                                            <i class="fas fa-plus me-1"></i>添加出差安排
                                        </button>
                                    </form>
                                </div>
                                
                                <div class="col-md-6">
                                    <h6 class="mb-3">出差记录管理</h6>
                                    
                                    <div class="mb-3">
                                        <label for="travelFilterStatus" class="form-label">筛选状态</label>
                                        <select class="form-select" id="travelFilterStatus">
                                            <option value="all">全部</option>
                                            <option value="active">进行中</option>
                                            <option value="upcoming">即将开始</option>
                                            <option value="completed">已结束</option>
                                        </select>
                                    </div>
                                    
                                    <div id="travelList" style="max-height: 400px; overflow-y: auto;">
                                        <!-- 出差记录将在这里动态生成 -->
                                        <p class="text-muted small mb-0">暂无出差记录</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 邮件设置 -->
                        <div class="tab-pane fade" id="email-settings" role="tabpanel">
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle me-2"></i>
                                使用EmailJS服务发送邮件，需要先注册 <a href="https://www.emailjs.com" target="_blank">EmailJS</a> 账号并配置邮件模板。
                            </div>
                            
                            <form id="emailConfigForm">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="emailServiceId" class="form-label">Service ID</label>
                                            <input type="text" class="form-control" id="emailServiceId" 
                                                   placeholder="在EmailJS控制台中获取">
                                            <div class="form-text">EmailJS服务ID</div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="emailTemplateId" class="form-label">Template ID</label>
                                            <input type="text" class="form-control" id="emailTemplateId" 
                                                   placeholder="邮件模板ID">
                                            <div class="form-text">排班通知邮件模板ID</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="emailUserId" class="form-label">User ID / Public Key</label>
                                            <input type="text" class="form-control" id="emailUserId" 
                                                   placeholder="EmailJS用户ID">
                                            <div class="form-text">在Account → API Keys中查看</div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3 pt-4">
                                            <div class="form-check">
                                                <input type="checkbox" class="form-check-input" id="emailEnabled">
                                                <label class="form-check-label" for="emailEnabled">启用邮件通知</label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">测试邮件功能</label>
                                    <div class="d-grid gap-2">
                                        <button type="button" class="btn btn-outline-primary" id="testEmailBtn">
                                            <i class="fas fa-paper-plane me-1"></i>发送测试邮件
                                        </button>
                                    </div>
                                    <div class="form-text">向系统管理员发送测试邮件</div>
                                </div>
                                
                                <div class="alert alert-warning">
                                    <i class="fas fa-exclamation-triangle me-2"></i>
                                    <strong>重要提示：</strong><br>
                                    1. EmailJS免费版每月200封邮件<br>
                                    2. 建议使用公司邮箱作为发件人<br>
                                    3. 邮件发送记录保存在EmailJS控制台
                                </div>
                            </form>
                        </div>
                        
                        <!-- 人员管理 -->
                        <div class="tab-pane fade" id="employee-management" role="tabpanel">
                            <div class="row">
                                <div class="col-md-6">
                                    <h6>添加人员</h6>
                                    <form id="employeeForm" class="needs-validation" novalidate>
                                        <div class="mb-3">
                                            <label for="employeeName" class="form-label">姓名</label>
                                            <input type="text" class="form-control" id="employeeName" required>
                                            <div class="invalid-feedback">请输入员工姓名</div>
                                        </div>
                                        <div class="mb-3">
                                            <label for="employeeGroup" class="form-label">所属组别</label>
                                            <select class="form-select" id="employeeGroup" required>
                                                <option value="leader">负责人组</option>
                                                <option value="director">编导组</option>
                                                <option value="editor">剪辑组</option>
                                                <option value="camera">摄像组</option>
                                                <option value="flexible">机动组</option>
                                                <option value="design">设计组</option>
                                                <!-- 自定义组别将通过JavaScript动态添加 -->
                                            </select>
                                            <div class="invalid-feedback">请选择组别</div>
                                        </div>
                                        <div class="mb-3">
                                            <label for="employeePhone" class="form-label">电话</label>
                                            <input type="tel" class="form-control" id="employeePhone" pattern="[0-9]{11}" required>
                                            <div class="invalid-feedback">请输入11位手机号码</div>
                                        </div>
                                        <div class="mb-3">
                                            <label for="employeeEmail" class="form-label">邮箱</label>
                                            <input type="email" class="form-control" id="employeeEmail" required>
                                            <div class="invalid-feedback">请输入有效的邮箱地址</div>
                                        </div>
                                        <div class="mb-3 form-check">
                                            <input type="checkbox" class="form-check-input" id="employeeActive" checked>
                                            <label class="form-check-label" for="employeeActive">激活状态</label>
                                        </div>
                                        <button type="submit" class="btn btn-primary">添加员工</button>
                                    </form>
                                </div>
                                <div class="col-md-6">
                                    <h6>管理现有人员</h6>
                                    <div class="mb-3">
                                        <label for="employeeFilterGroup" class="form-label">筛选组别</label>
                                        <select class="form-select" id="employeeFilterGroup">
                                            <option value="all">所有组别</option>
                                            <option value="leader">负责人组</option>
                                            <option value="director">编导组</option>
                                            <option value="editor">剪辑组</option>
                                            <option value="camera">摄像组</option>
                                            <option value="flexible">机动组</option>
                                            <option value="design">设计组</option>
                                            <!-- 自定义组别将通过JavaScript动态添加 -->
                                        </select>
                                    </div>
                                    <div id="employeeList" style="max-height: 400px; overflow-y: auto;">
                                        <!-- 员工列表将通过JavaScript动态填充 -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" id="saveSystemSettings">保存设置</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 发送通知模态框 -->
    <div class="modal fade" id="sendNotificationModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">发送通知</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="notificationForm" class="needs-validation" novalidate>
                        <div class="mb-3">
                            <label for="notificationType" class="form-label">通知类型</label>
                            <select class="form-select" id="notificationType">
                                <option value="daily">日常通知</option>
                                <option value="schedule_change">排班变更</option>
                                <option value="emergency">紧急通知</option>
                                <option value="reminder">提醒</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="notificationRecipients" class="form-label">接收人</label>
                            <select class="form-select" id="notificationRecipients">
                                <option value="all">全体员工</option>
                                <option value="leader">负责人组</option>
                                <option value="director">编导组</option>
                                <option value="editor">剪辑组</option>
                                <option value="camera">摄像组</option>
                                <option value="flexible">机动组</option>
                                <option value="design">设计组</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="notificationMessage" class="form-label">消息内容</label>
                            <textarea class="form-control" id="notificationMessage" rows="4" placeholder="请输入通知内容..." required></textarea>
                            <div class="invalid-feedback">请输入通知内容</div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">发送方式</label>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="sendSMS" checked>
                                <label class="form-check-label" for="sendSMS">短信</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="sendEmail" checked>
                                <label class="form-check-label" for="sendEmail">邮件</label>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" id="confirmSendNotification">发送通知</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 消息中心模态框 -->
    <div class="modal fade" id="notificationModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">消息中心</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="d-flex justify-content-between mb-3">
                        <div class="btn-group" role="group">
                            <button type="button" class="btn btn-outline-primary active" data-filter="all">全部</button>
                            <button type="button" class="btn btn-outline-primary" data-filter="unread">未读</button>
                            <button type="button" class="btn btn-outline-primary" data-filter="read">已读</button>
                        </div>
                        <button type="button" class="btn btn-outline-danger btn-sm" id="clearNotifications">
                            <i class="fas fa-trash me-1"></i>清空消息
                        </button>
                    </div>
                    <div id="notificationList"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- 确认操作模态框 -->
    <div class="modal fade" id="confirmModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="confirmModalTitle">确认操作</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p id="confirmModalMessage">确定要执行此操作吗？</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" id="confirmAction">确定</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 批量操作模态框 -->
    <div class="modal fade" id="batchOperationsModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">批量操作</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>批量操作功能允许您对多个日期和组别进行统一设置。</p>
                    <p>请在上方的批量操作区域设置日期范围、操作类型和组别，然后点击"应用"按钮。</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 通知提示容器 -->
    <div class="toast-container"></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // 系统状态
        let currentDate = new Date(2026, 0, 15); // 修改：设置初始日期为2026年1月15日
        let selectedDay = null;
        let selectedEmployeeForLeave = null;
        let monthlySchedule = {};
        let replacementRecords = [];
        let leaveRecords = [];
        let travelRecords = []; // 出差记录
        let notifications = [];
        let pendingAction = null;
        let isGroupOverviewExpanded = true; // 组别概览收起/展开状态
        
        // 系统配置
        let systemConfig = {
            normalStartTime: "10:00",
            normalEndTime: "19:00",
            eveningStartTime: "17:00",
            eveningEndTime: "00:00",
            fairnessThreshold: 90,
            autoReplacement: true,
            autoNotifications: true,
            conflictDetection: true,
            lastBackupTime: null,
            
            // 自动通知配置
            enableAutoNotifications: true,
            autoNotificationTime: "17:00",
            notificationAdvanceDays: 1,
            sendSMSAuto: true,
            sendEmailAuto: true,
            
            // 组别排班配置
            groupConfigs: {
                leader: { normalCount: 1, eveningCount: 1 },
                director: { normalCount: 2, eveningCount: 3 },
                editor: { normalCount: 3, eveningCount: 5 },
                camera: { normalCount: 3, eveningCount: 3 },
                flexible: { normalCount: 3, eveningCount: 4 },
                design: { normalCount: 2, eveningCount: 2 }
            },
            
            // 自定义组别（新增字段）
            customGroups: {}, // 格式: { groupKey: { name: "组名", color: "group-custom1", normalCount: 2, eveningCount: 1 } }
            
            // 节假日配置
            holidays: {}, // 格式: { "2026-01-01": { name: "元旦", type: "public", startDate: "2026-01-01", endDate: "2026-01-01", description: "", dutyEmployees: [], dutyGroups: [], dutyEmployeesByGroup: {}, shiftType: "normal", dutyHours: "full", notes: "", isRecurring: true } }
            holidayScheduleMode: "minimal",
            autoGenerateHolidaySchedule: true,
            excludeHolidayFromFairness: true,
            sendHolidayNotifications: true,
            
            // 邮件配置
            emailConfig: {
                serviceId: '',
                templateId: '',
                userId: '',
                enabled: false
            },
            
            // 邮件通知模板
            emailTemplates: {
                schedule: {
                    id: 'schedule_template',
                    subject: '{{date}} 排班安排',
                    content: `尊敬的 {{name}}：<br><br>
                            这是您 {{date}} 的排班安排：<br>
                            部门：{{group}}<br>
                            班次：{{shift}}<br>
                            时间：{{time}}<br><br>
                            请按时到岗，如有问题请及时联系管理员。<br><br>
                            部门排班管理系统`
                },
                change: {
                    id: 'change_template',
                    subject: '排班变更通知',
                    content: `尊敬的 {{name}}：<br><br>
                            您的排班已发生变更：<br>
                            日期：{{date}}<br>
                            原安排：{{oldSchedule}}<br>
                            新安排：{{newSchedule}}<br><br>
                            请留意变更信息。<br><br>
                            部门排班管理系统`
                },
                leave: {
                    id: 'leave_template',
                    subject: '请假申请通知',
                    content: `管理员您好：<br><br>
                            {{name}} 提交了请假申请：<br>
                            日期：{{date}}<br>
                            请假类型：{{type}}<br>
                            原因：{{reason}}<br><br>
                            请及时处理。<br><br>
                            部门排班管理系统`
                }
            }
        };

        // 部门人员数据
        const groups = {
            leader: {
                name: "负责人组",
                color: "group-leader",
                members: [
                    { id: 1, name: "范伟森", avatar: "范", active: true, phone: "13800138001", email: "fan@company.com", workDays: 0, leaveDays: 0, travelDays: 0, lastShift: null },
                    { id: 2, name: "曹安", avatar: "曹", active: true, phone: "13800138002", email: "cao@company.com", workDays: 0, leaveDays: 0, travelDays: 0, lastShift: null },
                    { id: 3, name: "歪歪", avatar: "歪", active: true, phone: "13800138003", email: "wai@company.com", workDays: 0, leaveDays: 0, travelDays: 0, lastShift: null }
                ]
            },
            director: {
                name: "编导组",
                color: "group-director",
                members: [
                    { id: 4, name: "刘文兴", avatar: "刘", active: true, phone: "13800138004", email: "liu@company.com", workDays: 0, leaveDays: 0, travelDays: 0, lastShift: null },
                    { id: 5, name: "裴萌", avatar: "裴", active: true, phone: "13800138005", email: "pei@company.com", workDays: 0, leaveDays: 0, travelDays: 0, lastShift: null },
                    { id: 6, name: "曾柏辉", avatar: "曾", active: true, phone: "13800138006", email: "zeng@company.com", workDays: 0, leaveDays: 0, travelDays: 0, lastShift: null },
                    { id: 7, name: "宋永勇", avatar: "宋", active: true, phone: "13800138007", email: "song@company.com", workDays: 0, leaveDays: 0, travelDays: 0, lastShift: null },
                    { id: 8, name: "钟婷婷", avatar: "钟", active: true, phone: "13800138008", email: "zhong@company.com", workDays: 0, leaveDays: 0, travelDays: 0, lastShift: null }
                ]
            },
            editor: {
                name: "剪辑组",
                color: "group-editor",
                members: [
                    { id: 9, name: "何泽华", avatar: "何", active: true, phone: "13800138009", email: "he@company.com", workDays: 0, leaveDays: 0, travelDays: 0, lastShift: null },
                    { id: 10, name: "沈勇泉", avatar: "沈", active: true, phone: "13800138010", email: "shen@company.com", workDays: 0, leaveDays: 0, travelDays: 0, lastShift: null },
                    { id: 11, name: "黄权敬", avatar: "黄", active: true, phone: "13800138011", email: "huang@company.com", workDays: 0, leaveDays: 0, travelDays: 0, lastShift: null },
                    { id: 12, name: "朱雪丽", avatar: "朱", active: true, phone: "13800138012", email: "zhu@company.com", workDays: 0, leaveDays: 0, travelDays: 0, lastShift: null },
                    { id: 13, name: "夏陆明", avatar: "夏", active: true, phone: "13800138013", email: "xia@company.com", workDays: 0, leaveDays: 0, travelDays: 0, lastShift: null },
                    { id: 14, name: "胡俊", avatar: "胡", active: true, phone: "13800138014", email: "hu@company.com", workDays: 0, leaveDays: 0, travelDays: 0, lastShift: null },
                    { id: 15, name: "赵浩锋", avatar: "赵", active: true, phone: "13800138015", email: "zhao@company.com", workDays: 0, leaveDays: 0, travelDays: 0, lastShift: null },
                    { id: 16, name: "曾正源", avatar: "曾", active: true, phone: "13800138016", email: "zengzy@company.com", workDays: 0, leaveDays: 0, travelDays: 0, lastShift: null }
                ]
            },
            camera: {
                name: "摄像组",
                color: "group-camera",
                members: [
                    { id: 17, name: "赖京华", avatar: "赖", active: true, phone: "13800138017", email: "lai@company.com", workDays: 0, leaveDays: 0, travelDays: 0, lastShift: null },
                    { id: 18, name: "冯健材", avatar: "冯", active: true, phone: "13800138018", email: "feng@company.com", workDays: 0, leaveDays: 0, travelDays: 0, lastShift: null },
                    { id: 19, name: "孔令彪", avatar: "孔", active: true, phone: "13800138019", email: "kong@company.com", workDays: 0, leaveDays: 0, travelDays: 0, lastShift: null },
                    { id: 20, name: "钟豪昌", avatar: "钟", active: true, phone: "13800138020", email: "zhonghc@company.com", workDays: 0, leaveDays: 0, travelDays: 0, lastShift: null },
                    { id: 21, name: "颜世才", avatar: "颜", active: true, phone: "13800138021", email: "yan@company.com", workDays: 0, leaveDays: 0, travelDays: 0, lastShift: null },
                    { id: 22, name: "尚永华", avatar: "尚", active: true, phone: "13800138022", email: "shang@company.com", workDays: 0, leaveDays: 0, travelDays: 0, lastShift: null }
                ]
            },
            flexible: {
                name: "机动组",
                color: "group-flexible",
                members: [
                    { id: 23, name: "乔乔", avatar: "乔", active: true, phone: "13800138023", email: "qiao@company.com", workDays: 0, leaveDays: 0, travelDays: 0, lastShift: null },
                    { id: 24, name: "赵哥", avatar: "赵", active: true, phone: "13800138024", email: "zhaog@company.com", workDays: 0, leaveDays: 0, travelDays: 0, lastShift: null },
                    { id: 25, name: "段文博", avatar: "段", active: true, phone: "13800138025", email: "duan@company.com", workDays: 0, leaveDays: 0, travelDays: 0, lastShift: null },
                    { id: 26, name: "大荒", avatar: "大", active: true, phone: "13800138026", email: "dahuang@company.com", workDays: 0, leaveDays: 0, travelDays: 0, lastShift: null },
                    { id: 27, name: "汤醒", avatar: "汤", active: true, phone: "13800138027", email: "tang@company.com", workDays: 0, leaveDays: 0, travelDays: 0, lastShift: null },
                    { id: 28, name: "黎健鸿", avatar: "黎", active: true, phone: "13800138028", email: "li@company.com", workDays: 0, leaveDays: 0, travelDays: 0, lastShift: null },
                    { id: 29, name: "陈嘉祥", avatar: "陈", active: true, phone: "13800138029", email: "chen@company.com", workDays: 0, leaveDays: 0, travelDays: 0, lastShift: null }
                ]
            },
            design: {
                name: "设计组",
                color: "group-design",
                members: [
                    { id: 30, name: "刘立文", avatar: "刘", active: true, phone: "13800138030", email: "liulw@company.com", workDays: 0, leaveDays: 0, travelDays: 0, lastShift: null },
                    { id: 31, name: "司徒淇", avatar: "司", active: true, phone: "13800138031", email: "situ@company.com", workDays: 0, leaveDays: 0, travelDays: 0, lastShift: null },
                    { id: 32, name: "张雨晨", avatar: "张", active: true, phone: "13800138032", email: "zhang@company.com", workDays: 0, leaveDays: 0, travelDays: 0, lastShift: null },
                    { id: 33, name: "林琪", avatar: "林", active: true, phone: "13800138033", email: "lin@company.com", workDays: 0, leaveDays: 0, travelDays: 0, lastShift: null }
                ]
            }
        };

        // 初始化组别人数配置
        Object.keys(groups).forEach(groupKey => {
            if (systemConfig.groupConfigs[groupKey]) {
                groups[groupKey].normalCount = systemConfig.groupConfigs[groupKey].normalCount;
                groups[groupKey].eveningCount = systemConfig.groupConfigs[groupKey].eveningCount;
            }
        });

        // 排班历史记录
        let scheduleHistory = [];

        // 初始化系统
        document.addEventListener('DOMContentLoaded', function() {
            initializeSystem();
            setupEventListeners();
            startRealTimeUpdates();
            
            // 修改：自动显示当天的排班详情
            setTimeout(() => {
                const today = new Date();
                const todayKey = `${today.getFullYear()}-${today.getMonth() + 1}-${today.getDate()}`;
                if (monthlySchedule[todayKey]) {
                    selectedDay = todayKey;
                    showDailyScheduleDetail(todayKey);
                }
            }, 500);
        });

        function initializeSystem() {
            // 修改：确保使用当前日期作为起始日期
            currentDate = new Date(); // 使用当前日期
            
            // 如果当前日期早于2026年1月15日，则使用2026年1月15日
            const startDate = new Date(2026, 0, 15); // 2026年1月15日
            if (currentDate < startDate) {
                currentDate = new Date(2026, 0, 15);
            }
            
            loadSystemConfig();
            loadAllData();
            loadCustomGroups(); // 加载自定义组别
            generateMonthlySchedule();
            renderCalendar();
            renderGroupOverview();
            renderAdjustmentRecords();
            renderPendingNotifications();
            updateNotificationCount();
            updateStatistics();
            renderScheduleHistory();
            updateSystemStatus();
            renderNextDaySchedulePreview();
            renderEmployeeList();
            updateGroupCount();
            
            // 初始化节假日设置
            initHolidaySettings();
            
            // 修改：自动显示当天的排班详情
            const today = new Date();
            const todayKey = `${today.getFullYear()}-${today.getMonth() + 1}-${today.getDate()}`;
            if (monthlySchedule[todayKey]) {
                selectedDay = todayKey;
                showDailyScheduleDetail(todayKey);
            }
        }

        function setupEventListeners() {
            // 月份导航
            document.getElementById('prevMonth').addEventListener('click', previousMonth);
            document.getElementById('nextMonth').addEventListener('click', nextMonth);
            
            // 邮件通知按钮
            document.getElementById('sendEmailScheduleBtn').addEventListener('click', sendTodayScheduleEmails);
            document.getElementById('sendEmailForDayBtn').addEventListener('click', sendEmailForSelectedDay);
            
            // 日期详情操作
            document.getElementById('saveDayChanges').addEventListener('click', saveDayChanges);
            document.getElementById('saveAndNotifyDayChanges').addEventListener('click', saveAndNotifyDayChanges);
            document.getElementById('sendDailyNotifications').addEventListener('click', sendDailyNotifications);
            document.getElementById('cancelLeave').addEventListener('click', cancelLeave);
            document.getElementById('submitLeave').addEventListener('click', submitLeave);
            
            // 系统设置
            document.getElementById('saveSystemSettings').addEventListener('click', saveSystemSettings);
            document.getElementById('saveGroupConfigs').addEventListener('click', saveGroupConfigs);
            document.getElementById('resetGroupConfigs').addEventListener('click', resetGroupConfigs);
            
            // 节假日设置
            document.getElementById('holiday-settings-tab').addEventListener('click', function() {
                initHolidaySettings();
            });
            
            // 出差设置
            document.getElementById('travel-settings-tab').addEventListener('click', initTravelSettingsTab);
            document.getElementById('travelForm').addEventListener('submit', addTravelRecord);
            document.getElementById('travelFilterStatus').addEventListener('change', renderTravelList);
            
            // 邮件设置
            document.getElementById('email-settings-tab').addEventListener('click', function() {
                loadEmailConfig();
            });
            
            document.getElementById('testEmailBtn').addEventListener('click', sendTestEmail);
            
            // 通知系统
            document.getElementById('sendNotificationBtn').addEventListener('click', openSendNotificationModal);
            document.getElementById('confirmSendNotification').addEventListener('click', confirmSendNotification);
            document.getElementById('clearNotifications').addEventListener('click', clearNotifications);
            
            // 确认操作
            document.getElementById('confirmAction').addEventListener('click', executePendingAction);
            
            // 消息筛选
            document.querySelectorAll('[data-filter]').forEach(btn => {
                btn.addEventListener('click', function() {
                    const filter = this.getAttribute('data-filter');
                    filterNotifications(filter);
                    
                    document.querySelectorAll('[data-filter]').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                });
            });
            
            // 智能排班按钮
            document.getElementById('quickScheduleBtn').addEventListener('click', quickSchedule);
            
            // 批量操作按钮
            document.getElementById('batchOperationsBtn').addEventListener('click', toggleBatchActions);
            document.getElementById('cancelBatchAction').addEventListener('click', cancelBatchAction);
            document.getElementById('applyBatchAction').addEventListener('click', applyBatchAction);
            
            // 数据备份按钮
            document.getElementById('backupDataBtn').addEventListener('click', backupAllData);
            document.getElementById('exportDataBtn').addEventListener('click', exportData);
            document.getElementById('importDataBtn').addEventListener('click', triggerImportData);
            document.getElementById('importDataFile').addEventListener('change', importData);
            
            // 人员管理
            document.getElementById('employeeForm').addEventListener('submit', addEmployee);
            document.getElementById('employeeFilterGroup').addEventListener('change', renderEmployeeList);
            
            // 当日排班详情操作按钮
            document.getElementById('editDailyScheduleBtn').addEventListener('click', function() {
                if (selectedDay) {
                    openDayDetail(selectedDay);
                }
            });
            
            document.getElementById('closeDailyScheduleBtn').addEventListener('click', function() {
                document.getElementById('dailyScheduleDetail').style.display = 'none';
            });
            
            // 日历编辑按钮事件委托
            document.getElementById('calendarGrid').addEventListener('click', function(e) {
                if (e.target.closest('.edit-day-btn')) {
                    const dayElement = e.target.closest('.calendar-day');
                    if (dayElement) {
                        const dateKey = dayElement.getAttribute('data-date');
                        e.stopPropagation();
                        openDayDetail(dateKey);
                    }
                }
            });
            
            // 组别设置选项卡点击事件
            document.getElementById('group-settings-tab').addEventListener('click', function() {
                renderGroupScheduleConfigs();
                renderGroupManagementForms();
            });
            
            // 组别概览收起/展开功能
            document.getElementById('toggleGroupOverview').addEventListener('click', toggleGroupOverview);
            document.getElementById('refreshGroupOverview').addEventListener('click', refreshGroupOverview);
            
            // 组别管理事件监听
            setupGroupManagementEventListeners();
        }

        // 组别管理相关功能
        function loadCustomGroups() {
            if (systemConfig.customGroups) {
                Object.keys(systemConfig.customGroups).forEach(groupKey => {
                    const customGroup = systemConfig.customGroups[groupKey];
                    if (!groups[groupKey]) { // 防止覆盖现有组别
                        groups[groupKey] = {
                            name: customGroup.name,
                            color: customGroup.color,
                            normalCount: customGroup.normalCount || 2,
                            eveningCount: customGroup.eveningCount || 1,
                            members: []
                        };
                        
                        // 添加到组别配置
                        if (!systemConfig.groupConfigs[groupKey]) {
                            systemConfig.groupConfigs[groupKey] = {
                                normalCount: customGroup.normalCount || 2,
                                eveningCount: customGroup.eveningCount || 1
                            };
                        }
                    }
                });
            }
        }

        function renderGroupManagementForms() {
            // 填充编辑组别选择框
            const editGroupSelect = document.getElementById('editGroupSelect');
            if (editGroupSelect) {
                editGroupSelect.innerHTML = '<option value="">请选择组别</option>';
                
                Object.keys(groups).forEach(groupKey => {
                    const group = groups[groupKey];
                    const option = document.createElement('option');
                    option.value = groupKey;
                    option.textContent = `${group.name} (${groupKey})`;
                    editGroupSelect.appendChild(option);
                });
            }
            
            // 更新批量操作中的组别选项
            updateBatchGroupOptions();
            
            // 更新人员管理中的组别选项
            updateEmployeeGroupOptions();
        }

        function setupGroupManagementEventListeners() {
            // 添加组别表单提交
            const addGroupForm = document.getElementById('addGroupForm');
            if (addGroupForm) {
                addGroupForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    const groupId = document.getElementById('newGroupId').value.trim();
                    const groupName = document.getElementById('newGroupName').value.trim();
                    const groupColor = document.getElementById('newGroupColor').value;
                    const normalCount = document.getElementById('newGroupNormalCount').value;
                    const eveningCount = document.getElementById('newGroupEveningCount').value;
                    
                    // 验证输入
                    if (!groupId || !groupName) {
                        showNotification('请填写完整的组别信息', 'warning');
                        return;
                    }
                    
                    // 验证组别ID格式（只允许英文字母、数字和下划线）
                    if (!/^[a-zA-Z][a-zA-Z0-9_]*$/.test(groupId)) {
                        showNotification('组别ID只能包含英文字母、数字和下划线，且必须以字母开头', 'warning');
                        return;
                    }
                    
                    if (addNewGroup(groupId, groupName, groupColor, normalCount, eveningCount)) {
                        // 重置表单
                        addGroupForm.reset();
                        document.getElementById('newGroupNormalCount').value = '2';
                        document.getElementById('newGroupEveningCount').value = '1';
                        
                        showNotification(`组别 "${groupName}" 添加成功`, 'success');
                    }
                });
            }
            
            // 编辑组别选择变化
            const editGroupSelect = document.getElementById('editGroupSelect');
            if (editGroupSelect) {
                editGroupSelect.addEventListener('change', function() {
                    const groupKey = this.value;
                    const groupNameInput = document.getElementById('editGroupName');
                    const groupColorSelect = document.getElementById('editGroupColor');
                    const saveBtn = document.getElementById('saveGroupNameBtn');
                    const removeBtn = document.getElementById('removeGroupBtn');
                    
                    if (groupKey && groups[groupKey]) {
                        const group = groups[groupKey];
                        
                        groupNameInput.value = group.name;
                        groupNameInput.disabled = false;
                        
                        groupColorSelect.disabled = false;
                        
                        saveBtn.disabled = false;
                        removeBtn.disabled = false;
                        
                        // 检查是否为默认组别（不允许删除）
                        const defaultGroups = ['leader', 'director', 'editor', 'camera', 'flexible', 'design'];
                        if (defaultGroups.includes(groupKey)) {
                            removeBtn.disabled = true;
                            removeBtn.title = '默认组别不允许删除';
                        } else {
                            removeBtn.disabled = false;
                            removeBtn.title = '';
                        }
                    } else {
                        groupNameInput.value = '';
                        groupNameInput.disabled = true;
                        groupColorSelect.disabled = true;
                        saveBtn.disabled = true;
                        removeBtn.disabled = true;
                    }
                });
            }
            
            // 保存组别修改
            const saveGroupNameBtn = document.getElementById('saveGroupNameBtn');
            if (saveGroupNameBtn) {
                saveGroupNameBtn.addEventListener('click', function() {
                    const groupKey = document.getElementById('editGroupSelect').value;
                    const newName = document.getElementById('editGroupName').value.trim();
                    const newColor = document.getElementById('editGroupColor').value;
                    
                    if (!groupKey || !newName) {
                        showNotification('请选择组别并输入新名称', 'warning');
                        return;
                    }
                    
                    if (editGroupName(groupKey, newName, newColor)) {
                        // 重置表单
                        document.getElementById('editGroupSelect').value = '';
                        document.getElementById('editGroupName').value = '';
                        document.getElementById('editGroupName').disabled = true;
                        document.getElementById('editGroupColor').value = '';
                        document.getElementById('editGroupColor').disabled = true;
                        this.disabled = true;
                        document.getElementById('removeGroupBtn').disabled = true;
                        
                        showNotification('组别信息已更新', 'success');
                    }
                });
            }
            
            // 删除组别
            const removeGroupBtn = document.getElementById('removeGroupBtn');
            if (removeGroupBtn) {
                removeGroupBtn.addEventListener('click', function() {
                    const groupKey = document.getElementById('editGroupSelect').value;
                    
                    if (!groupKey) {
                        showNotification('请选择要删除的组别', 'warning');
                        return;
                    }
                    
                    const group = groups[groupKey];
                    if (!group) return;
                    
                    showConfirmModal(
                        '删除组别',
                        `确定要删除组别 "${group.name}" 吗？此操作不可恢复，且会删除该组别的所有排班配置。`,
                        function() {
                            if (removeGroup(groupKey)) {
                                // 重置表单
                                document.getElementById('editGroupSelect').value = '';
                                document.getElementById('editGroupName').value = '';
                                document.getElementById('editGroupName').disabled = true;
                                document.getElementById('editGroupColor').value = '';
                                document.getElementById('editGroupColor').disabled = true;
                                document.getElementById('saveGroupNameBtn').disabled = true;
                                document.getElementById('removeGroupBtn').disabled = true;
                                
                                showNotification('组别已删除', 'success');
                            }
                        }
                    );
                });
            }
        }

        function addNewGroup(groupId, groupName, groupColor, normalCount, eveningCount) {
            // 验证组别ID是否已存在
            if (groups[groupId]) {
                showNotification(`组别ID "${groupId}" 已存在`, 'error');
                return false;
            }
            
            // 验证组别名称是否已存在
            const existingGroup = Object.values(groups).find(g => g.name === groupName);
            if (existingGroup) {
                showNotification(`组别名称 "${groupName}" 已存在`, 'error');
                return false;
            }
            
            // 创建新组别
            groups[groupId] = {
                name: groupName,
                color: groupColor,
                normalCount: parseInt(normalCount) || 2,
                eveningCount: parseInt(eveningCount) || 1,
                members: []
            };
            
            // 保存到系统配置
            if (!systemConfig.customGroups) {
                systemConfig.customGroups = {};
            }
            
            systemConfig.customGroups[groupId] = {
                name: groupName,
                color: groupColor,
                normalCount: parseInt(normalCount) || 2,
                eveningCount: parseInt(eveningCount) || 1,
                createdAt: new Date().toISOString()
            };
            
            // 添加到组别配置
            systemConfig.groupConfigs[groupId] = {
                normalCount: parseInt(normalCount) || 2,
                eveningCount: parseInt(eveningCount) || 1
            };
            
            // 保存配置
            saveSystemConfig();
            
            // 重新渲染相关界面
            renderGroupScheduleConfigs();
            renderGroupManagementForms();
            renderGroupOverview();
            updateGroupCount();
            
            // 重新生成今日及往后的排班
            updateFutureSchedules();
            
            // 更新人员管理中的组别选项
            updateEmployeeGroupOptions();
            
            // 更新批量操作中的组别选项
            updateBatchGroupOptions();
            
            // 如果当前有选中的日期，重新显示排班详情
            if (selectedDay) {
                showDailyScheduleDetail(selectedDay);
            }
            
            return true;
        }

        function editGroupName(groupKey, newName, newColor = null) {
            if (!groups[groupKey]) {
                showNotification(`组别不存在`, 'error');
                return false;
            }
            
            // 验证新名称是否已存在（排除当前组别）
            const existingGroup = Object.entries(groups).find(([key, group]) => 
                key !== groupKey && group.name === newName
            );
            
            if (existingGroup) {
                showNotification(`组别名称 "${newName}" 已存在`, 'error');
                return false;
            }
            
            // 更新组别名称
            const oldName = groups[groupKey].name;
            groups[groupKey].name = newName;
            
            // 更新颜色（如果提供）
            if (newColor && newColor !== '') {
                groups[groupKey].color = newColor;
            }
            
            // 如果是自定义组别，更新系统配置
            if (systemConfig.customGroups && systemConfig.customGroups[groupKey]) {
                systemConfig.customGroups[groupKey].name = newName;
                if (newColor && newColor !== '') {
                    systemConfig.customGroups[groupKey].color = newColor;
                }
            }
            
            // 保存配置
            saveSystemConfig();
            
            // 重新渲染相关界面
            renderGroupScheduleConfigs();
            renderGroupManagementForms();
            renderGroupOverview();
            updateGroupCount();
            
            // 更新人员管理中的组别选项
            updateEmployeeGroupOptions();
            
            // 更新批量操作中的组别选项
            updateBatchGroupOptions();
            
            // 如果当前有选中的日期，重新显示排班详情
            if (selectedDay) {
                showDailyScheduleDetail(selectedDay);
            }
            
            // 记录历史
            scheduleHistory.push({
                action: '修改组别名称',
                timestamp: new Date(),
                details: `组别 "${oldName}" 更名为 "${newName}"`
            });
            
            renderScheduleHistory();
            
            return true;
        }

        function removeGroup(groupKey) {
            // 检查是否为默认组别（不允许删除）
            const defaultGroups = ['leader', 'director', 'editor', 'camera', 'flexible', 'design'];
            if (defaultGroups.includes(groupKey)) {
                showNotification('默认组别不允许删除', 'error');
                return false;
            }
            
            // 检查组别中是否有成员
            if (groups[groupKey].members.length > 0) {
                showNotification(`该组别中还有 ${groups[groupKey].members.length} 名成员，请先将成员转移到其他组别`, 'error');
                return false;
            }
            
            // 从groups中删除
            const groupName = groups[groupKey].name;
            delete groups[groupKey];
            
            // 从系统配置中删除
            if (systemConfig.customGroups && systemConfig.customGroups[groupKey]) {
                delete systemConfig.customGroups[groupKey];
            }
            
            if (systemConfig.groupConfigs && systemConfig.groupConfigs[groupKey]) {
                delete systemConfig.groupConfigs[groupKey];
            }
            
            // 保存配置
            saveSystemConfig();
            
            // 重新渲染相关界面
            renderGroupScheduleConfigs();
            renderGroupManagementForms();
            renderGroupOverview();
            updateGroupCount();
            
            // 重新生成今日及往后的排班
            updateFutureSchedules();
            
            // 更新人员管理中的组别选项
            updateEmployeeGroupOptions();
            
            // 更新批量操作中的组别选项
            updateBatchGroupOptions();
            
            // 如果当前有选中的日期，重新显示排班详情
            if (selectedDay) {
                showDailyScheduleDetail(selectedDay);
            }
            
            // 记录历史
            scheduleHistory.push({
                action: '删除组别',
                timestamp: new Date(),
                details: `删除组别 "${groupName}"`
            });
            
            renderScheduleHistory();
            
            return true;
        }

        function updateEmployeeGroupOptions() {
            const employeeGroupSelect = document.getElementById('employeeGroup');
            const employeeFilterGroup = document.getElementById('employeeFilterGroup');
            
            if (employeeGroupSelect) {
                // 保存当前选中的值
                const currentValue = employeeGroupSelect.value;
                
                // 清空并重新填充选项
                employeeGroupSelect.innerHTML = '';
                
                Object.keys(groups).forEach(groupKey => {
                    const option = document.createElement('option');
                    option.value = groupKey;
                    option.textContent = groups[groupKey].name;
                    employeeGroupSelect.appendChild(option);
                });
                
                // 恢复选中的值（如果还存在）
                if (groups[currentValue]) {
                    employeeGroupSelect.value = currentValue;
                }
            }
            
            if (employeeFilterGroup) {
                // 保存当前选中的值
                const currentValue = employeeFilterGroup.value;
                
                // 清空并重新填充选项
                employeeFilterGroup.innerHTML = '';
                
                const allOption = document.createElement('option');
                allOption.value = 'all';
                allOption.textContent = '所有组别';
                employeeFilterGroup.appendChild(allOption);
                
                Object.keys(groups).forEach(groupKey => {
                    const option = document.createElement('option');
                    option.value = groupKey;
                    option.textContent = groups[groupKey].name;
                    employeeFilterGroup.appendChild(option);
                });
                
                // 恢复选中的值
                if (currentValue === 'all' || groups[currentValue]) {
                    employeeFilterGroup.value = currentValue;
                }
            }
        }

        function updateBatchGroupOptions() {
            const batchGroupSelect = document.getElementById('batchGroup');
            if (batchGroupSelect) {
                // 保存当前选中的值
                const currentValue = batchGroupSelect.value;
                
                // 清空并重新填充选项
                batchGroupSelect.innerHTML = '';
                
                const allOption = document.createElement('option');
                allOption.value = 'all';
                allOption.textContent = '所有组别';
                batchGroupSelect.appendChild(allOption);
                
                Object.keys(groups).forEach(groupKey => {
                    const option = document.createElement('option');
                    option.value = groupKey;
                    option.textContent = groups[groupKey].name;
                    batchGroupSelect.appendChild(option);
                });
                
                // 恢复选中的值
                if (currentValue === 'all' || groups[currentValue]) {
                    batchGroupSelect.value = currentValue;
                }
            }
        }

        // 节假日管理相关函数
        function initHolidaySettings() {
            renderHolidaySettingsList();
            setupHolidayEventListeners();
            loadHolidayConfigToForm();
        }

        function setupHolidayEventListeners() {
            // 显示/隐藏节假日表单
            document.getElementById('showHolidayFormBtn').addEventListener('click', function() {
                const form = document.getElementById('holidaySettingsForm');
                if (form.style.display === 'none' || form.style.display === '') {
                    form.style.display = 'block';
                    resetHolidayForm();
                } else {
                    form.style.display = 'none';
                }
            });
            
            document.getElementById('cancelHolidayForm').addEventListener('click', function() {
                document.getElementById('holidaySettingsForm').style.display = 'none';
            });
            
            // 节假日表单提交
            document.getElementById('holidaySettingsForm').addEventListener('submit', function(e) {
                e.preventDefault();
                saveHolidaySetting();
            });
            
            // 启用节假日值班复选框
            document.getElementById('enableHolidayDuty').addEventListener('change', function() {
                const dutySection = document.getElementById('holidayDutySelection');
                dutySection.style.display = this.checked ? 'block' : 'none';
                
                if (this.checked) {
                    updateDutyGroupSelection();
                }
            });
            
            // 值班组别类型变化
            document.getElementById('dutyGroupType').addEventListener('change', function() {
                updateDutyGroupSelection();
            });
            
            // 全选/取消全选值班人员
            document.getElementById('selectAllDutyEmployees').addEventListener('click', function() {
                const checkboxes = document.querySelectorAll('.duty-employee-check');
                if (checkboxes.length === 0) return;
                
                const allChecked = Array.from(checkboxes).every(cb => cb.checked);
                
                checkboxes.forEach(cb => {
                    cb.checked = !allChecked;
                });
                
                this.textContent = allChecked ? '全选' : '取消全选';
            });
            
            // 节假日列表筛选
            document.getElementById('filterAllHolidays').addEventListener('click', function() {
                renderHolidaySettingsList('all');
                updateFilterButtonStates('all');
            });
            
            document.getElementById('filterUpcomingHolidays').addEventListener('click', function() {
                renderHolidaySettingsList('upcoming');
                updateFilterButtonStates('upcoming');
            });
            
            document.getElementById('filterPastHolidays').addEventListener('click', function() {
                renderHolidaySettingsList('past');
                updateFilterButtonStates('past');
            });
            
            // 节假日规则设置
            document.getElementById('holidayScheduleMode').addEventListener('change', function() {
                systemConfig.holidayScheduleMode = this.value;
            });
            
            document.getElementById('autoGenerateHolidaySchedule').addEventListener('change', function() {
                systemConfig.autoGenerateHolidaySchedule = this.checked;
            });
            
            document.getElementById('excludeHolidayFromFairness').addEventListener('change', function() {
                systemConfig.excludeHolidayFromFairness = this.checked;
            });
            
            document.getElementById('sendHolidayNotifications').addEventListener('change', function() {
                systemConfig.sendHolidayNotifications = this.checked;
            });
        }

        function loadHolidayConfigToForm() {
            // 加载节假日规则设置
            if (systemConfig.holidayScheduleMode) {
                document.getElementById('holidayScheduleMode').value = systemConfig.holidayScheduleMode;
            }
            
            if (systemConfig.autoGenerateHolidaySchedule !== undefined) {
                document.getElementById('autoGenerateHolidaySchedule').checked = systemConfig.autoGenerateHolidaySchedule;
            }
            
            if (systemConfig.excludeHolidayFromFairness !== undefined) {
                document.getElementById('excludeHolidayFromFairness').checked = systemConfig.excludeHolidayFromFairness;
            }
            
            if (systemConfig.sendHolidayNotifications !== undefined) {
                document.getElementById('sendHolidayNotifications').checked = systemConfig.sendHolidayNotifications;
            }
        }

        function resetHolidayForm() {
            document.getElementById('holidaySettingsForm').reset();
            const today = new Date();
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);
            document.getElementById('holidayStartDate').value = today.toISOString().split('T')[0];
            document.getElementById('holidayEndDate').value = tomorrow.toISOString().split('T')[0];
            document.getElementById('enableHolidayDuty').checked = false;
            document.getElementById('holidayDutySelection').style.display = 'none';
        }

        function updateDutyGroupSelection() {
            const dutyGroupType = document.getElementById('dutyGroupType').value;
            const groupSelectionSection = document.getElementById('dutyGroupSelection');
            const rotationSection = document.getElementById('rotationGroupSection');
            const employeeSelectionSection = document.getElementById('dutyEmployeeSelection');
            
            if (dutyGroupType === 'specific') {
                groupSelectionSection.style.display = 'block';
                rotationSection.style.display = 'none';
                employeeSelectionSection.style.display = 'block';
                renderDutyGroupOptions();
                updateDutyEmployeesByGroup();
            } else if (dutyGroupType === 'all') {
                groupSelectionSection.style.display = 'none';
                rotationSection.style.display = 'none';
                employeeSelectionSection.style.display = 'block';
                renderAllDutyEmployees();
            } else if (dutyGroupType === 'rotate') {
                groupSelectionSection.style.display = 'none';
                rotationSection.style.display = 'block';
                employeeSelectionSection.style.display = 'none';
                renderRotationGroupOptions();
            }
        }

        function renderDutyGroupOptions() {
            const container = document.getElementById('dutyGroupOptions');
            let html = '';
            
            Object.keys(groups).forEach(groupKey => {
                const group = groups[groupKey];
                html += `
                    <div class="form-check form-check-inline">
                        <input class="form-check-input duty-group-check" 
                               type="checkbox" 
                               id="duty_group_${groupKey}" 
                               value="${groupKey}">
                        <label class="form-check-label" for="duty_group_${groupKey}">
                            ${group.name}
                        </label>
                    </div>
                `;
            });
            
            container.innerHTML = html;
            
            // 添加组别选择变化事件
            document.querySelectorAll('.duty-group-check').forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    updateDutyEmployeesByGroup();
                });
            });
        }

        function updateDutyEmployeesByGroup() {
            const dutyGroupType = document.getElementById('dutyGroupType').value;
            const employeeContainer = document.querySelector('.duty-employees-container');
            
            if (dutyGroupType === 'specific') {
                // 获取选中的组别
                const selectedGroups = Array.from(document.querySelectorAll('.duty-group-check:checked'))
                    .map(cb => cb.value);
                
                if (selectedGroups.length === 0) {
                    employeeContainer.innerHTML = '<p class="text-muted small mb-0">请先选择值班组别</p>';
                    return;
                }
                
                // 渲染选中组别的员工
                let html = '';
                selectedGroups.forEach(groupKey => {
                    const group = groups[groupKey];
                    const activeMembers = group.members.filter(m => m.active);
                    
                    if (activeMembers.length > 0) {
                        html += `<div class="mb-2"><strong>${group.name}</strong></div>`;
                        html += `<div class="d-flex flex-wrap gap-2 mb-3">`;
                        
                        activeMembers.forEach(member => {
                            html += `
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input duty-employee-check" 
                                           type="checkbox" 
                                           id="duty_emp_${member.id}" 
                                           value="${member.id}"
                                           data-group="${groupKey}">
                                    <label class="form-check-label small" for="duty_emp_${member.id}">
                                        ${member.name}
                                    </label>
                                </div>
                            `;
                        });
                        
                        html += `</div>`;
                    }
                });
                
                employeeContainer.innerHTML = html || '<p class="text-muted small mb-0">暂无活跃员工</p>';
            }
        }

        function renderAllDutyEmployees() {
            const container = document.querySelector('.duty-employees-container');
            let html = '';
            
            Object.keys(groups).forEach(groupKey => {
                const group = groups[groupKey];
                const activeMembers = group.members.filter(m => m.active);
                
                if (activeMembers.length > 0) {
                    html += `<div class="mb-2"><strong>${group.name}</strong></div>`;
                    html += `<div class="d-flex flex-wrap gap-2 mb-3">`;
                    
                    activeMembers.forEach(member => {
                        html += `
                            <div class="form-check form-check-inline">
                                <input class="form-check-input duty-employee-check" 
                                       type="checkbox" 
                                       id="duty_emp_${member.id}" 
                                       value="${member.id}"
                                       data-group="${groupKey}">
                                <label class="form-check-label small" for="duty_emp_${member.id}">
                                    ${member.name}
                                </label>
                            </div>
                        `;
                    });
                    
                    html += `</div>`;
                }
            });
            
            container.innerHTML = html || '<p class="text-muted small mb-0">暂无活跃员工</p>';
        }

        function renderRotationGroupOptions() {
            const container = document.getElementById('rotationGroupOrder');
            let html = '<div class="alert alert-info small mb-3">选择轮换顺序，系统会自动按顺序安排值班组别</div>';
            
            Object.keys(groups).forEach(groupKey => {
                const group = groups[groupKey];
                html += `
                    <div class="rotation-group-item d-flex align-items-center mb-2 p-2 border rounded">
                        <div class="form-check me-3">
                            <input class="form-check-input rotation-group-check" 
                                   type="checkbox" 
                                   id="rotation_group_${groupKey}" 
                                   value="${groupKey}">
                            <label class="form-check-label" for="rotation_group_${groupKey}">
                                ${group.name}
                            </label>
                        </div>
                        <div class="ms-auto">
                            <button type="button" class="btn btn-sm btn-outline-secondary move-up" data-group="${groupKey}">
                                <i class="fas fa-arrow-up"></i>
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-secondary ms-1 move-down" data-group="${groupKey}">
                                <i class="fas fa-arrow-down"></i>
                            </button>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
            
            // 添加轮换组别选择变化事件
            document.querySelectorAll('.rotation-group-check').forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    updateRotationOrder();
                });
            });
            
            // 添加上下移动按钮事件
            document.querySelectorAll('.move-up').forEach(btn => {
                btn.addEventListener('click', function() {
                    const groupKey = this.getAttribute('data-group');
                    moveRotationGroupUp(groupKey);
                });
            });
            
            document.querySelectorAll('.move-down').forEach(btn => {
                btn.addEventListener('click', function() {
                    const groupKey = this.getAttribute('data-group');
                    moveRotationGroupDown(groupKey);
                });
            });
        }

        function updateRotationOrder() {
            const selectedGroups = Array.from(document.querySelectorAll('.rotation-group-check:checked'))
                .map(cb => cb.value);
            
            // 这里可以保存到系统配置
            // systemConfig.dutyGroupConfig.rotationOrder = selectedGroups;
        }

        function moveRotationGroupUp(groupKey) {
            // 实现组别顺序上移逻辑
            const item = document.querySelector(`#rotation_group_${groupKey}`).closest('.rotation-group-item');
            const prevItem = item.previousElementSibling;
            if (prevItem) {
                item.parentNode.insertBefore(item, prevItem);
            }
        }

        function moveRotationGroupDown(groupKey) {
            // 实现组别顺序下移逻辑
            const item = document.querySelector(`#rotation_group_${groupKey}`).closest('.rotation-group-item');
            const nextItem = item.nextElementSibling;
            if (nextItem) {
                item.parentNode.insertBefore(nextItem, item);
            }
        }

        function saveHolidaySetting() {
            const name = document.getElementById('holidayName').value.trim();
            const type = document.getElementById('holidayType').value;
            const startDate = document.getElementById('holidayStartDate').value;
            const endDate = document.getElementById('holidayEndDate').value;
            const description = document.getElementById('holidayDescription').value.trim();
            const enableDuty = document.getElementById('enableHolidayDuty').checked;
            const isRecurring = document.getElementById('isRecurringHoliday').checked;
            const dutyGroupType = document.getElementById('dutyGroupType').value;
            const autoAssignDuty = document.getElementById('autoAssignDuty').checked;
            
            if (!name || !startDate || !endDate) {
                showNotification('请填写完整信息', 'warning');
                return;
            }
            
            const start = new Date(startDate);
            const end = new Date(endDate);
            
            if (start > end) {
                showNotification('开始日期不能晚于结束日期', 'warning');
                return;
            }
            
            // 收集值班人员信息
            let dutyEmployees = [];
            let dutyGroups = [];
            let dutyEmployeesByGroup = {};
            let shiftType = 'normal';
            let dutyHours = 'full';
            let dutyNotes = '';
            
            if (enableDuty) {
                // 获取值班设置
                shiftType = document.getElementById('dutyShiftType').value;
                dutyHours = document.getElementById('dutyHours').value;
                dutyNotes = document.getElementById('dutyNotes').value.trim();
                
                // 根据值班组别类型收集信息
                if (dutyGroupType === 'specific') {
                    // 获取选中的组别
                    dutyGroups = Array.from(document.querySelectorAll('.duty-group-check:checked'))
                        .map(cb => cb.value);
                    
                    // 获取选中的员工（按组别分类）
                    dutyGroups.forEach(groupKey => {
                        const groupEmployees = Array.from(document.querySelectorAll(`.duty-employee-check[data-group="${groupKey}"]:checked`))
                            .map(input => parseInt(input.value));
                        
                        if (groupEmployees.length > 0) {
                            dutyEmployeesByGroup[groupKey] = groupEmployees;
                            dutyEmployees = dutyEmployees.concat(groupEmployees);
                        }
                    });
                } else if (dutyGroupType === 'all') {
                    // 所有组别，获取所有选中的员工
                    const selectedEmployees = document.querySelectorAll('.duty-employee-check:checked');
                    dutyEmployees = Array.from(selectedEmployees).map(input => parseInt(input.value));
                    
                    // 按组别分类
                    dutyEmployees.forEach(employeeId => {
                        const employee = getEmployeeById(employeeId);
                        if (employee) {
                            // 查找员工所在的组
                            for (const groupKey in groups) {
                                if (groups[groupKey].members.some(m => m.id === employeeId)) {
                                    if (!dutyEmployeesByGroup[groupKey]) {
                                        dutyEmployeesByGroup[groupKey] = [];
                                        dutyGroups.push(groupKey);
                                    }
                                    dutyEmployeesByGroup[groupKey].push(employeeId);
                                    break;
                                }
                            }
                        }
                    });
                } else if (dutyGroupType === 'rotate') {
                    // 轮换组别，获取选择的组别顺序
                    const rotationItems = document.querySelectorAll('.rotation-group-item');
                    dutyGroups = Array.from(rotationItems)
                        .map(item => {
                            const checkbox = item.querySelector('.rotation-group-check');
                            return checkbox.checked ? checkbox.value : null;
                        })
                        .filter(groupKey => groupKey !== null);
                    
                    dutyNotes = '轮换组别值班' + (dutyNotes ? ` - ${dutyNotes}` : '');
                }
            }
            
            // 为日期范围内的每一天创建节假日记录
            const holidayRecords = {};
            for (let date = new Date(start); date <= end; date.setDate(date.getDate() + 1)) {
                const dateKey = date.toISOString().split('T')[0];
                
                holidayRecords[dateKey] = {
                    name: name,
                    type: type,
                    startDate: startDate,
                    endDate: endDate,
                    description: description,
                    dutyEmployees: enableDuty ? dutyEmployees : [],
                    dutyGroups: enableDuty ? dutyGroups : [],
                    dutyEmployeesByGroup: enableDuty ? dutyEmployeesByGroup : {},
                    shiftType: shiftType,
                    dutyHours: dutyHours,
                    dutyNotes: dutyNotes,
                    isRecurring: isRecurring,
                    enableDuty: enableDuty,
                    dutyGroupType: dutyGroupType,
                    autoAssignDuty: autoAssignDuty,
                    createdAt: new Date().toISOString()
                };
            }
            
            // 合并到系统配置中
            systemConfig.holidays = { ...systemConfig.holidays, ...holidayRecords };
            
            // 保存系统配置
            saveSystemConfig();
            
            // 重新生成受影响日期的排班
            Object.keys(holidayRecords).forEach(dateKey => {
                updateHolidaySchedule(dateKey);
            });
            
            // 重置表单
            document.getElementById('holidaySettingsForm').style.display = 'none';
            document.getElementById('holidaySettingsForm').reset();
            
            // 更新显示
            renderHolidaySettingsList();
            
            // 发送通知
            if (systemConfig.sendHolidayNotifications) {
                sendHolidayNotification(name, startDate, endDate, enableDuty, dutyEmployees.length, dutyGroups);
            }
            
            showNotification('节假日设置已保存，排班已更新', 'success');
        }

        function renderHolidaySettingsList(filter = 'all') {
            const container = document.getElementById('holidaySettingsList');
            const holidays = systemConfig.holidays || {};
            
            if (Object.keys(holidays).length === 0) {
                container.innerHTML = '<p class="text-muted small mb-0">暂无节假日设置</p>';
                return;
            }
            
            // 按开始日期分组节假日
            const holidayGroups = {};
            Object.keys(holidays).forEach(dateKey => {
                const holiday = holidays[dateKey];
                const groupKey = holiday.startDate;
                
                if (!holidayGroups[groupKey]) {
                    holidayGroups[groupKey] = {
                        ...holiday,
                        dateKeys: [dateKey]
                    };
                } else {
                    holidayGroups[groupKey].dateKeys.push(dateKey);
                }
            });
            
            // 按开始日期排序
            const sortedGroups = Object.values(holidayGroups).sort((a, b) => 
                new Date(a.startDate) - new Date(b.startDate)
            );
            
            // 筛选
            let filteredGroups = sortedGroups;
            const today = new Date();
            
            if (filter === 'upcoming') {
                filteredGroups = sortedGroups.filter(group => new Date(group.endDate) >= today);
            } else if (filter === 'past') {
                filteredGroups = sortedGroups.filter(group => new Date(group.endDate) < today);
            }
            
            if (filteredGroups.length === 0) {
                container.innerHTML = `<div class="text-center py-4">
                    <i class="fas fa-calendar-times text-muted fa-2x mb-2"></i>
                    <p class="text-muted small">没有符合条件的节假日</p>
                </div>`;
                return;
            }
            
            let html = '';
            filteredGroups.forEach(group => {
                const startDate = new Date(group.startDate);
                const endDate = new Date(group.endDate);
                const duration = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24)) + 1;
                
                let typeBadge = '';
                let typeClass = '';
                
                switch(group.type) {
                    case 'public':
                        typeBadge = '<span class="badge bg-danger me-2">法定</span>';
                        typeClass = 'holiday-public';
                        break;
                    case 'company':
                        typeBadge = '<span class="badge bg-warning me-2">公司</span>';
                        typeClass = 'holiday-company';
                        break;
                    case 'rest':
                        typeBadge = '<span class="badge bg-success me-2">休息</span>';
                        typeClass = 'holiday-rest';
                        break;
                    case 'event':
                        typeBadge = '<span class="badge bg-info me-2">活动</span>';
                        typeClass = 'holiday-event';
                        break;
                }
                
                const dateStr = duration === 1 
                    ? startDate.toLocaleDateString('zh-CN', { month: 'long', day: 'numeric' })
                    : `${startDate.toLocaleDateString('zh-CN', { month: 'long', day: 'numeric' })} 至 ${endDate.toLocaleDateString('zh-CN', { month: 'long', day: 'numeric' })}`;
                
                const dutyInfo = group.enableDuty && group.dutyEmployees.length > 0
                    ? `<div class="small text-info mt-1">
                          <i class="fas fa-user-clock me-1"></i>
                          值班人员: ${group.dutyEmployees.length}人
                          ${group.dutyGroups && group.dutyGroups.length > 0 ? 
                            `| 值班组别: ${group.dutyGroups.map(g => groups[g]?.name || g).join('、')}` : ''}
                          ${group.shiftType ? `| 班次: ${getShiftTypeText(group.shiftType)}` : ''}
                       </div>`
                    : '<div class="small text-muted mt-1"><i class="fas fa-bed me-1"></i>全体休息</div>';
                
                html += `
                    <div class="holiday-item border rounded p-3 mb-2 ${typeClass}">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <div class="d-flex align-items-center mb-2">
                                    ${typeBadge}
                                    <strong>${group.name}</strong>
                                    <span class="badge bg-secondary ms-2">${duration}天</span>
                                    ${group.isRecurring ? '<span class="badge bg-success ms-2">每年重复</span>' : ''}
                                </div>
                                <div class="small text-muted mb-1">
                                    <i class="fas fa-calendar-alt me-1"></i>
                                    ${dateStr}
                                </div>
                                ${group.description ? `<div class="small mb-2">${group.description}</div>` : ''}
                                ${dutyInfo}
                            </div>
                            <div class="ms-2">
                                <button class="btn btn-sm btn-outline-danger delete-holiday-setting" 
                                        data-start="${group.startDate}" 
                                        title="删除节假日">
                                    <i class="fas fa-trash"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-primary mt-1 edit-holiday-setting" 
                                        data-start="${group.startDate}" 
                                        title="编辑节假日">
                                    <i class="fas fa-edit"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
            
            // 添加删除按钮事件
            document.querySelectorAll('.delete-holiday-setting').forEach(btn => {
                btn.addEventListener('click', function() {
                    const startDate = this.getAttribute('data-start');
                    deleteHolidaySetting(startDate);
                });
            });
            
            // 添加编辑按钮事件
            document.querySelectorAll('.edit-holiday-setting').forEach(btn => {
                btn.addEventListener('click', function() {
                    const startDate = this.getAttribute('data-start');
                    editHolidaySetting(startDate);
                });
            });
        }

        function updateFilterButtonStates(activeFilter) {
            document.getElementById('filterAllHolidays').classList.remove('active');
            document.getElementById('filterUpcomingHolidays').classList.remove('active');
            document.getElementById('filterPastHolidays').classList.remove('active');
            
            const activeButton = document.getElementById(`filter${activeFilter.charAt(0).toUpperCase() + activeFilter.slice(1)}Holidays`);
            if (activeButton) {
                activeButton.classList.add('active');
            }
        }

        function deleteHolidaySetting(startDate) {
            showConfirmModal(
                '删除节假日',
                `确定要删除 ${startDate} 开始的节假日设置吗？系统将重新生成受影响日期的排班。`,
                function() {
                    // 查找并删除所有相关日期
                    const datesToRemove = [];
                    Object.keys(systemConfig.holidays).forEach(dateKey => {
                        if (systemConfig.holidays[dateKey].startDate === startDate) {
                            datesToRemove.push(dateKey);
                        }
                    });
                    
                    // 删除节假日记录
                    datesToRemove.forEach(dateKey => {
                        delete systemConfig.holidays[dateKey];
                    });
                    
                    // 保存系统配置
                    saveSystemConfig();
                    
                    // 重新生成受影响日期的排班
                    datesToRemove.forEach(dateKey => {
                        updateHolidaySchedule(dateKey);
                    });
                    
                    // 更新显示
                    renderHolidaySettingsList();
                    
                    showNotification('节假日已删除，排班已更新', 'success');
                }
            );
        }

        function editHolidaySetting(startDate) {
            // 查找节假日记录
            const holiday = Object.values(systemConfig.holidays).find(h => h.startDate === startDate);
            if (!holiday) return;
            
            // 填充表单
            document.getElementById('holidayName').value = holiday.name;
            document.getElementById('holidayType').value = holiday.type;
            document.getElementById('holidayStartDate').value = holiday.startDate;
            document.getElementById('holidayEndDate').value = holiday.endDate;
            document.getElementById('holidayDescription').value = holiday.description || '';
            document.getElementById('enableHolidayDuty').checked = holiday.enableDuty || false;
            document.getElementById('isRecurringHoliday').checked = holiday.isRecurring || false;
            
            if (holiday.enableDuty) {
                document.getElementById('holidayDutySelection').style.display = 'block';
                document.getElementById('dutyGroupType').value = holiday.dutyGroupType || 'specific';
                document.getElementById('autoAssignDuty').checked = holiday.autoAssignDuty || false;
                document.getElementById('dutyShiftType').value = holiday.shiftType || 'normal';
                document.getElementById('dutyHours').value = holiday.dutyHours || 'full';
                document.getElementById('dutyNotes').value = holiday.dutyNotes || '';
                
                // 更新UI显示
                updateDutyGroupSelection();
                
                // 延时设置选中的组别和员工
                setTimeout(() => {
                    if (holiday.dutyGroupType === 'specific' || holiday.dutyGroupType === 'all') {
                        // 设置选中的组别
                        if (holiday.dutyGroups && holiday.dutyGroupType === 'specific') {
                            holiday.dutyGroups.forEach(groupKey => {
                                const checkbox = document.querySelector(`#duty_group_${groupKey}`);
                                if (checkbox) checkbox.checked = true;
                            });
                        }
                        
                        // 设置选中的员工
                        if (holiday.dutyEmployees && holiday.dutyEmployees.length > 0) {
                            holiday.dutyEmployees.forEach(empId => {
                                const checkbox = document.querySelector(`#duty_emp_${empId}`);
                                if (checkbox) checkbox.checked = true;
                            });
                        }
                    } else if (holiday.dutyGroupType === 'rotate') {
                        // 设置轮换组别
                        if (holiday.dutyGroups && holiday.dutyGroups.length > 0) {
                            holiday.dutyGroups.forEach(groupKey => {
                                const checkbox = document.querySelector(`#rotation_group_${groupKey}`);
                                if (checkbox) checkbox.checked = true;
                            });
                        }
                    }
                }, 100);
            }
            
            // 显示表单
            document.getElementById('holidaySettingsForm').style.display = 'block';
            
            // 滚动到表单位置
            document.getElementById('holidaySettingsForm').scrollIntoView({ behavior: 'smooth' });
        }

        function updateHolidaySchedule(dateKey) {
            if (monthlySchedule[dateKey]) {
                const dateObj = new Date(dateKey);
                
                // 检查是否为节假日
                const holiday = systemConfig.holidays[dateKey];
                
                if (holiday && systemConfig.autoGenerateHolidaySchedule) {
                    // 根据节假日设置重新生成排班
                    generateCustomHolidaySchedule(dateKey, dateObj, holiday);
                } else if (!holiday && monthlySchedule[dateKey].isSpecial) {
                    // 如果取消了节假日，恢复为正常排班
                    const existingLeaves = {};
                    Object.keys(groups).forEach(groupKey => {
                        existingLeaves[groupKey] = [...monthlySchedule[dateKey].groups[groupKey].leave];
                    });
                    
                    monthlySchedule[dateKey].isSpecial = false;
                    generateDailyScheduleForDate(dateKey, dateObj, existingLeaves, monthlySchedule[dateKey].note || "");
                }
                
                renderCalendar();
                updateStatistics();
            }
        }

        function generateCustomHolidaySchedule(dateKey, dateObj, holiday) {
            const dayData = monthlySchedule[dateKey];
            dayData.isSpecial = true;
            dayData.note = holiday.name + (holiday.description ? ` (${holiday.description})` : '');
            
            // 重置所有组别的排班
            Object.keys(groups).forEach(groupKey => {
                const groupSchedule = dayData.groups[groupKey];
                
                // 保留原有的请假和出差人员
                const leaves = [...groupSchedule.leave];
                const travels = [...groupSchedule.travel];
                
                // 重置其他排班
                groupSchedule.normal = [];
                groupSchedule.evening = [];
                groupSchedule.off = [];
                groupSchedule.originalNormal = [];
                groupSchedule.originalEvening = [];
                groupSchedule.leave = leaves;
                groupSchedule.travel = travels;
                
                // 获取该组的所有活跃员工（排除请假和出差）
                const activeMembers = groups[groupKey].members.filter(m => 
                    m.active && 
                    !leaves.includes(m.id) && 
                    !travels.includes(m.id)
                );
                
                if (holiday.enableDuty && holiday.dutyEmployees.length > 0) {
                    // 有值班安排的情况
                    // 找出该组的值班人员
                    const groupDutyEmployees = activeMembers.filter(m => 
                        holiday.dutyEmployees.includes(m.id)
                    );
                    
                    // 安排值班人员
                    if (groupDutyEmployees.length > 0) {
                        groupDutyEmployees.forEach(member => {
                            if (holiday.shiftType === 'evening') {
                                groupSchedule.evening.push(member.id);
                                member.workDays++;
                                member.lastShift = 'evening';
                            } else {
                                groupSchedule.normal.push(member.id);
                                member.workDays++;
                                member.lastShift = 'normal';
                            }
                        });
                        
                        // 记录原始安排
                        if (holiday.shiftType === 'evening') {
                            groupSchedule.originalEvening = [...groupSchedule.evening];
                        } else {
                            groupSchedule.originalNormal = [...groupSchedule.normal];
                        }
                    }
                    
                    // 非值班人员设为空闲
                    activeMembers.forEach(member => {
                        if (!groupDutyEmployees.includes(member) && 
                            !leaves.includes(member.id) && 
                            !travels.includes(member.id)) {
                            groupSchedule.off.push(member.id);
                        }
                    });
                } else {
                    // 无值班安排，全体休息
                    activeMembers.forEach(member => {
                        if (!leaves.includes(member.id) && !travels.includes(member.id)) {
                            groupSchedule.off.push(member.id);
                        }
                    });
                }
                
                // 保留请假人员
                groupSchedule.leave = leaves;
            });
        }

        function sendHolidayNotification(name, startDate, endDate, hasDuty, dutyCount, dutyGroups) {
            const start = new Date(startDate);
            const end = new Date(endDate);
            const duration = Math.ceil((end - start) / (1000 * 60 * 60 * 24)) + 1;
            
            let message = `节假日通知: ${name}\n`;
            message += `时间: ${startDate} 至 ${endDate} (共${duration}天)\n`;
            if (hasDuty) {
                message += `值班安排: 已安排 ${dutyCount} 名值班人员\n`;
                if (dutyGroups && dutyGroups.length > 0) {
                    const groupNames = dutyGroups.map(groupKey => groups[groupKey]?.name || groupKey).join('、');
                    message += `值班组别: ${groupNames}\n`;
                }
            } else {
                message += '值班安排: 全体休息\n';
            }
            message += '请查看详细排班安排。';
            
            addNotification('节假日设置', message, 'holiday');
        }

        function getShiftTypeText(shiftType) {
            const shiftTypes = {
                'normal': '正常班',
                'evening': '晚班',
                'flexible': '弹性班'
            };
            return shiftTypes[shiftType] || shiftType;
        }

        // 出差相关功能
        function initTravelSettingsTab() {
            renderTravelEmployeeOptions();
            renderTravelList();
        }

        function renderTravelEmployeeOptions() {
            const select = document.getElementById('travelEmployee');
            select.innerHTML = '<option value="">请选择员工</option>';
            
            Object.keys(groups).forEach(groupKey => {
                const group = groups[groupKey];
                group.members.forEach(member => {
                    if (member.active) {
                        const option = document.createElement('option');
                        option.value = member.id;
                        option.textContent = `${member.name} (${group.name})`;
                        select.appendChild(option);
                    }
                });
            });
        }

        function renderTravelList() {
            const container = document.getElementById('travelList');
            const filterStatus = document.getElementById('travelFilterStatus').value;
            
            if (travelRecords.length === 0) {
                container.innerHTML = '<p class="text-muted small mb-0">暂无出差记录</p>';
                return;
            }
            
            let filteredRecords = travelRecords;
            
            if (filterStatus !== 'all') {
                const today = new Date();
                filteredRecords = travelRecords.filter(record => {
                    const startDate = new Date(record.startDate);
                    const endDate = new Date(record.endDate);
                    
                    if (filterStatus === 'active') {
                        return today >= startDate && today <= endDate;
                    } else if (filterStatus === 'upcoming') {
                        return today < startDate;
                    } else if (filterStatus === 'completed') {
                        return today > endDate;
                    }
                    return true;
                });
            }
            
            if (filteredRecords.length === 0) {
                container.innerHTML = `<p class="text-muted small mb-0">没有${getTravelFilterStatusText(filterStatus)}的出差记录</p>`;
                return;
            }
            
            let html = '';
            filteredRecords.sort((a, b) => new Date(b.startDate) - new Date(a.startDate)).forEach(record => {
                const employee = getEmployeeById(record.employeeId);
                if (!employee) return;
                
                const startDate = new Date(record.startDate);
                const endDate = new Date(record.endDate);
                const today = new Date();
                const status = getTravelStatus(record);
                
                let statusBadge = '';
                switch(status) {
                    case 'active':
                        statusBadge = '<span class="badge bg-success">进行中</span>';
                        break;
                    case 'upcoming':
                        statusBadge = '<span class="badge bg-warning">即将开始</span>';
                        break;
                    case 'completed':
                        statusBadge = '<span class="badge bg-secondary">已结束</span>';
                        break;
                }
                
                html += `
                    <div class="travel-item border rounded p-3 mb-2">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <div class="d-flex align-items-center mb-2">
                                    <strong>${employee.name}</strong>
                                    <div class="ms-2">${statusBadge}</div>
                                </div>
                                <div class="small text-muted mb-1">
                                    <i class="fas fa-calendar-alt me-1"></i>
                                    ${startDate.toLocaleDateString()} 至 ${endDate.toLocaleDateString()}
                                </div>
                                <div class="small mb-1">
                                    <i class="fas fa-map-marker-alt me-1"></i>
                                    地点：${record.destination || '未指定'}
                                </div>
                                <div class="small mb-2">
                                    <i class="fas fa-file-alt me-1"></i>
                                    事由：${record.reason}
                                </div>
                                ${record.emergencyContact ? 
                                    '<div class="small text-info"><i class="fas fa-phone me-1"></i>已提供紧急联系方式</div>' : ''}
                            </div>
                            <div>
                                <button class="btn btn-sm btn-outline-danger delete-travel" data-id="${record.id}">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
            
            // 添加删除按钮事件
            document.querySelectorAll('.delete-travel').forEach(btn => {
                btn.addEventListener('click', function() {
                    const travelId = parseInt(this.getAttribute('data-id'));
                    deleteTravelRecord(travelId);
                });
            });
        }

        function getTravelFilterStatusText(status) {
            switch(status) {
                case 'active': return '进行中';
                case 'upcoming': return '即将开始';
                case 'completed': return '已结束';
                default: return '';
            }
        }

        function getTravelStatus(record) {
            const today = new Date();
            const startDate = new Date(record.startDate);
            const endDate = new Date(record.endDate);
            
            if (today < startDate) return 'upcoming';
            if (today > endDate) return 'completed';
            return 'active';
        }

        function addTravelRecord(e) {
            e.preventDefault();
            
            const employeeId = parseInt(document.getElementById('travelEmployee').value);
            const startDate = document.getElementById('travelStartDate').value;
            const endDate = document.getElementById('travelEndDate').value;
            const reason = document.getElementById('travelReason').value.trim();
            const destination = document.getElementById('travelDestination').value.trim();
            const emergencyContact = document.getElementById('travelEmergencyContact').checked;
            
            if (!employeeId || !startDate || !endDate || !reason) {
                showNotification('请填写完整信息', 'warning');
                return;
            }
            
            const start = new Date(startDate);
            const end = new Date(endDate);
            
            if (start > end) {
                showNotification('开始日期不能晚于结束日期', 'warning');
                return;
            }
            
            const employee = getEmployeeById(employeeId);
            if (!employee) {
                showNotification('员工不存在', 'error');
                return;
            }
            
            // 检查是否有冲突的出差记录
            const conflictingTravel = travelRecords.find(record => {
                if (record.employeeId !== employeeId) return false;
                
                const recordStart = new Date(record.startDate);
                const recordEnd = new Date(record.endDate);
                
                return (start >= recordStart && start <= recordEnd) ||
                       (end >= recordStart && end <= recordEnd) ||
                       (start <= recordStart && end >= recordEnd);
            });
            
            if (conflictingTravel) {
                showNotification('该员工在所选时间段内已有出差安排', 'warning');
                return;
            }
            
            // 添加出差记录
            const newRecord = {
                id: Date.now(),
                employeeId: employeeId,
                startDate: startDate,
                endDate: endDate,
                reason: reason,
                destination: destination,
                emergencyContact: emergencyContact,
                createdAt: new Date().toISOString()
            };
            
            travelRecords.push(newRecord);
            
            // 重新生成受影响日期的排班
            updateTravelSchedules(startDate, endDate, employeeId);
            
            // 重置表单
            document.getElementById('travelForm').reset();
            document.getElementById('travelStartDate').value = '';
            document.getElementById('travelEndDate').value = '';
            
            // 更新显示
            renderTravelList();
            renderGroupOverview();
            updateStatistics();
            
            // 发送通知
            addNotification('出差安排', `${employee.name} 已安排出差：${startDate} 至 ${endDate}，事由：${reason}`, 'travel');
            
            showNotification('出差安排已添加', 'success');
        }

        function deleteTravelRecord(travelId) {
            showConfirmModal(
                '删除出差记录',
                '确定要删除此出差记录吗？删除后将重新生成受影响日期的排班。',
                function() {
                    const index = travelRecords.findIndex(record => record.id === travelId);
                    if (index !== -1) {
                        const record = travelRecords[index];
                        travelRecords.splice(index, 1);
                        
                        // 重新生成受影响日期的排班
                        updateTravelSchedules(record.startDate, record.endDate, record.employeeId);
                        
                        // 更新显示
                        renderTravelList();
                        renderGroupOverview();
                        updateStatistics();
                        
                        showNotification('出差记录已删除', 'success');
                    }
                }
            );
        }

        function updateTravelSchedules(startDate, endDate, employeeId) {
            const start = new Date(startDate);
            const end = new Date(endDate);
            
            // 更新所有受影响日期的排班
            for (let date = new Date(start); date <= end; date.setDate(date.getDate() + 1)) {
                const dateKey = `${date.getFullYear()}-${date.getMonth() + 1}-${date.getDate()}`;
                if (monthlySchedule[dateKey]) {
                    // 重新生成该日期的排班
                    const dayData = monthlySchedule[dateKey];
                    const existingLeaves = {};
                    Object.keys(groups).forEach(groupKey => {
                        existingLeaves[groupKey] = [...dayData.groups[groupKey].leave];
                    });
                    
                    // 检查是否为节假日
                    const dateStr = date.toISOString().split('T')[0];
                    const isHoliday = systemConfig.holidays && systemConfig.holidays[dateStr];
                    
                    if (isHoliday && systemConfig.autoGenerateHolidaySchedule) {
                        // 节假日，重新生成节假日排班
                        dayData.isSpecial = true;
                        generateHolidayScheduleForDate(dateKey, date);
                    } else {
                        // 非节假日，重新生成正常排班
                        dayData.isSpecial = false;
                        generateDailyScheduleForDate(dateKey, date, existingLeaves, dayData.note || "");
                    }
                }
            }
            
            renderCalendar();
            if (selectedDay) {
                showDailyScheduleDetail(selectedDay);
            }
        }

        function isEmployeeOnTravel(employeeId, date) {
            if (!travelRecords.length) return false;
            
            const dateObj = typeof date === 'string' ? new Date(date) : date;
            const dateStr = dateObj.toISOString().split('T')[0];
            
            return travelRecords.some(record => {
                if (record.employeeId !== employeeId) return false;
                
                const startDate = new Date(record.startDate);
                const endDate = new Date(record.endDate);
                
                return dateObj >= startDate && dateObj <= endDate;
            });
        }

        function getEmployeeTravelInfo(employeeId, date) {
            if (!travelRecords.length) return null;
            
            const dateObj = typeof date === 'string' ? new Date(date) : date;
            
            for (const record of travelRecords) {
                if (record.employeeId !== employeeId) continue;
                
                const startDate = new Date(record.startDate);
                const endDate = new Date(record.endDate);
                
                if (dateObj >= startDate && dateObj <= endDate) {
                    return {
                        reason: record.reason,
                        destination: record.destination,
                        startDate: record.startDate,
                        endDate: record.endDate
                    };
                }
            }
            
            return null;
        }

        // 显示加载指示器
        function showLoading() {
            document.getElementById('loadingOverlay').style.display = 'flex';
        }

        // 隐藏加载指示器
        function hideLoading() {
            document.getElementById('loadingOverlay').style.display = 'none';
        }

        // 加载所有数据
        function loadAllData() {
            try {
                const savedData = localStorage.getItem('departmentScheduleData');
                if (savedData) {
                    const data = JSON.parse(savedData);
                    monthlySchedule = data.monthlySchedule || monthlySchedule;
                    replacementRecords = data.replacementRecords || replacementRecords;
                    leaveRecords = data.leaveRecords || leaveRecords;
                    travelRecords = data.travelRecords || travelRecords;
                    notifications = data.notifications || notifications;
                    scheduleHistory = data.scheduleHistory || scheduleHistory;
                    
                    // 更新员工工作天数
                    Object.keys(groups).forEach(groupKey => {
                        groups[groupKey].members.forEach(member => {
                            const savedMember = data.employees && data.employees.find(e => e.id === member.id);
                            if (savedMember) {
                                member.workDays = savedMember.workDays || 0;
                                member.leaveDays = savedMember.leaveDays || 0;
                                member.travelDays = savedMember.travelDays || 0;
                                member.lastShift = savedMember.lastShift || null;
                            }
                        });
                    });
                }
            } catch (error) {
                console.error('加载数据失败:', error);
                showNotification('加载数据失败，使用默认数据', 'warning');
            }
        }

        // 保存所有数据
        function saveAllData() {
            const employees = [];
            Object.keys(groups).forEach(groupKey => {
                employees.push(...groups[groupKey].members);
            });
            
            const dataToSave = {
                employees: employees,
                monthlySchedule: monthlySchedule,
                replacementRecords: replacementRecords,
                leaveRecords: leaveRecords,
                travelRecords: travelRecords,
                notifications: notifications,
                scheduleHistory: scheduleHistory
            };
            
            try {
                localStorage.setItem('departmentScheduleData', JSON.stringify(dataToSave));
                return true;
            } catch (error) {
                console.error('保存数据失败:', error);
                showNotification('保存数据失败', 'error');
                return false;
            }
        }

        // 加载系统配置
        function loadSystemConfig() {
            try {
                const savedConfig = localStorage.getItem('departmentSystemConfig');
                if (savedConfig) {
                    const parsedConfig = JSON.parse(savedConfig);
                    systemConfig = { ...systemConfig, ...parsedConfig };
                    
                    // 确保groupConfigs存在
                    if (parsedConfig.groupConfigs) {
                        systemConfig.groupConfigs = parsedConfig.groupConfigs;
                        
                        // 更新groups对象中的配置
                        Object.keys(groups).forEach(groupKey => {
                            if (systemConfig.groupConfigs[groupKey]) {
                                groups[groupKey].normalCount = systemConfig.groupConfigs[groupKey].normalCount;
                                groups[groupKey].eveningCount = systemConfig.groupConfigs[groupKey].eveningCount;
                            }
                        });
                    }
                    
                    // 确保customGroups存在
                    if (parsedConfig.customGroups) {
                        systemConfig.customGroups = parsedConfig.customGroups;
                    } else {
                        systemConfig.customGroups = {};
                    }
                    
                    // 确保各个配置字段都存在
                    if (!systemConfig.holidays) systemConfig.holidays = {};
                    if (!systemConfig.holidayScheduleMode) systemConfig.holidayScheduleMode = 'minimal';
                    if (!systemConfig.autoGenerateHolidaySchedule !== undefined) systemConfig.autoGenerateHolidaySchedule = true;
                    if (!systemConfig.excludeHolidayFromFairness !== undefined) systemConfig.excludeHolidayFromFairness = true;
                    if (!systemConfig.sendHolidayNotifications !== undefined) systemConfig.sendHolidayNotifications = true;
                    
                    // 确保邮件配置存在
                    if (!systemConfig.emailConfig) {
                        systemConfig.emailConfig = {
                            serviceId: '',
                            templateId: '',
                            userId: '',
                            enabled: false
                        };
                    }
                }
                
                // 加载到表单
                document.getElementById('normalStartTime').value = systemConfig.normalStartTime;
                document.getElementById('normalEndTime').value = systemConfig.normalEndTime;
                document.getElementById('eveningStartTime').value = systemConfig.eveningStartTime;
                document.getElementById('eveningEndTime').value = systemConfig.eveningEndTime;
                document.getElementById('fairnessThreshold').value = systemConfig.fairnessThreshold;
                document.getElementById('autoReplacement').checked = systemConfig.autoReplacement;
                document.getElementById('autoNotifications').checked = systemConfig.autoNotifications;
                document.getElementById('conflictDetection').checked = systemConfig.conflictDetection;
                
                // 加载自动通知设置
                document.getElementById('enableAutoNotifications').checked = systemConfig.enableAutoNotifications;
                document.getElementById('autoNotificationTime').value = systemConfig.autoNotificationTime;
                document.getElementById('notificationAdvanceDays').value = systemConfig.notificationAdvanceDays;
                document.getElementById('sendSMSAuto').checked = systemConfig.sendSMSAuto;
                document.getElementById('sendEmailAuto').checked = systemConfig.sendEmailAuto;
                
                // 加载邮件配置
                loadEmailConfig();
            } catch (error) {
                console.error('加载系统配置失败:', error);
                showNotification('加载系统配置失败，使用默认设置', 'warning');
            }
        }

        // 保存系统配置到本地存储
        function saveSystemConfig() {
            try {
                localStorage.setItem('departmentSystemConfig', JSON.stringify(systemConfig));
                return true;
            } catch (error) {
                console.error('保存系统配置失败:', error);
                return false;
            }
        }

        // 智能排班功能
        function quickSchedule() {
            showConfirmModal(
                '智能排班',
                '确定要为整个月重新生成排班吗？这将覆盖所有手动调整。',
                function() {
                    showLoading();
                    setTimeout(() => {
                        generateMonthlySchedule();
                        renderCalendar();
                        updateStatistics();
                        
                        // 记录历史
                        scheduleHistory.push({
                            action: '智能排班',
                            timestamp: new Date(),
                            details: '为整个月重新生成排班'
                        });
                        
                        renderScheduleHistory();
                        saveAllData();
                        
                        hideLoading();
                        showNotification('智能排班已完成', 'success');
                    }, 100);
                }
            );
        }

        // 生成月度排班（包含节假日和出差处理）
        function generateMonthlySchedule() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            
            monthlySchedule = {};
            
            // 重置所有组别的员工工作天数（包括自定义组别）
            Object.keys(groups).forEach(groupKey => {
                groups[groupKey].members.forEach(member => {
                    member.workDays = 0;
                    member.travelDays = 0;
                });
            });
            
            // 修改：对于2026年1月，从15号开始排班
            let startDay = 1;
            if (year === 2026 && month === 0) { // 2026年1月
                startDay = 15;
            }
            
            for (let day = startDay; day <= daysInMonth; day++) {
                const dateKey = `${year}-${month + 1}-${day}`;
                const dateObj = new Date(year, month, day);
                const dayOfWeek = dateObj.getDay();
                
                monthlySchedule[dateKey] = {
                    date: dateObj,
                    dayOfWeek: dayOfWeek,
                    isWeekend: dayOfWeek === 0 || dayOfWeek === 6,
                    isSpecial: false,
                    note: "",
                    groups: {}
                };
                
                // 检查是否为节假日
                const dateStr = dateObj.toISOString().split('T')[0];
                const isHoliday = systemConfig.holidays && systemConfig.holidays[dateStr];
                
                if (isHoliday) {
                    monthlySchedule[dateKey].isSpecial = true;
                    monthlySchedule[dateKey].note = isHoliday.name + " (节假日)";
                    
                    // 根据节假日模式生成排班
                    if (systemConfig.autoGenerateHolidaySchedule) {
                        generateHolidayScheduleForDate(dateKey, dateObj);
                        continue;
                    }
                }
                
                // 正常生成排班（包含所有组别，包括自定义组别）
                generateNormalScheduleForDate(dateKey, dateObj);
            }
            
            updateCurrentMonthDisplay();
        }

        // 生成正常排班（考虑出差）
        function generateNormalScheduleForDate(dateKey, dateObj) {
            const dayOfWeek = dateObj.getDay();
            
            monthlySchedule[dateKey].isSpecial = false;
            
            // 为每个组别生成排班（包括自定义组别）
            Object.keys(groups).forEach(groupKey => {
                const group = groups[groupKey];
                monthlySchedule[dateKey].groups[groupKey] = {
                    normal: [],
                    evening: [],
                    off: [],
                    leave: [],
                    travel: [], // 出差人员
                    replacements: [],
                    originalNormal: [],
                    originalEvening: []
                };
                
                // 获取活跃员工（排除出差员工）
                const activeMembers = group.members.filter(m => {
                    if (!m.active) return false;
                    
                    // 检查是否出差
                    if (isEmployeeOnTravel(m.id, dateObj)) {
                        monthlySchedule[dateKey].groups[groupKey].travel.push(m.id);
                        m.travelDays++;
                        return false;
                    }
                    
                    return true;
                });
                
                // 正常班安排
                const normalCount = Math.min(group.normalCount, activeMembers.length);
                if (normalCount > 0) {
                    // 按工作天数排序，优先安排工作天数少的员工
                    const sortedMembers = [...activeMembers].sort((a, b) => {
                        // 避免前一天晚班的人员第二天过多需要上白班
                        const aPenalty = a.lastShift === 'evening' ? 1 : 0;
                        const bPenalty = b.lastShift === 'evening' ? 1 : 0;
                        return (a.workDays + aPenalty) - (b.workDays + bPenalty);
                    });
                    
                    for (let i = 0; i < normalCount; i++) {
                        const member = sortedMembers[i];
                        monthlySchedule[dateKey].groups[groupKey].normal.push(member.id);
                        member.workDays++;
                        member.lastShift = 'normal';
                    }
                    
                    // 记录原始安排
                    monthlySchedule[dateKey].groups[groupKey].originalNormal = [...monthlySchedule[dateKey].groups[groupKey].normal];
                }
                
                // 晚班安排
                const eveningCount = Math.min(group.eveningCount, activeMembers.length);
                if (eveningCount > 0) {
                    // 排除已经安排正常班的员工
                    const availableMembers = activeMembers.filter(m => 
                        !monthlySchedule[dateKey].groups[groupKey].normal.includes(m.id)
                    );
                    
                    // 按工作天数排序，优先安排工作天数少的员工
                    const sortedMembers = [...availableMembers].sort((a, b) => {
                        return a.workDays - b.workDays;
                    });
                    
                    for (let i = 0; i < eveningCount && i < sortedMembers.length; i++) {
                        const member = sortedMembers[i];
                        monthlySchedule[dateKey].groups[groupKey].evening.push(member.id);
                        member.workDays++;
                        member.lastShift = 'evening';
                    }
                    
                    // 记录原始安排
                    monthlySchedule[dateKey].groups[groupKey].originalEvening = [...monthlySchedule[dateKey].groups[groupKey].evening];
                }
                
                // 空闲人员
                activeMembers.forEach(member => {
                    if (!monthlySchedule[dateKey].groups[groupKey].normal.includes(member.id) &&
                        !monthlySchedule[dateKey].groups[groupKey].evening.includes(member.id)) {
                        monthlySchedule[dateKey].groups[groupKey].off.push(member.id);
                    }
                });
            });
        }

        // 为节假日生成排班
        function generateHolidayScheduleForDate(dateKey, dateObj) {
            const dayData = monthlySchedule[dateKey];
            const holiday = systemConfig.holidays[dateObj.toISOString().split('T')[0]];
            
            if (!holiday) return;
            
            // 根据节假日模式生成排班
            switch(systemConfig.holidayScheduleMode) {
                case 'minimal':
                    generateMinimalSchedule(dateKey);
                    break;
                case 'off':
                    generateDayOffSchedule(dateKey);
                    break;
                case 'normal':
                    generateNormalScheduleForDate(dateKey, dateObj);
                    break;
                case 'custom':
                    generateCustomHolidaySchedule(dateKey, dateObj, holiday);
                    break;
            }
        }

        // 最小值班模式
        function generateMinimalSchedule(date) {
            const dayData = monthlySchedule[date];
            
            Object.keys(groups).forEach(groupKey => {
                const group = groups[groupKey];
                const groupSchedule = dayData.groups[groupKey];
                
                // 保留请假和出差人员
                const leaves = [...groupSchedule.leave];
                const travels = [...groupSchedule.travel];
                
                // 重置其他排班
                groupSchedule.normal = [];
                groupSchedule.evening = [];
                groupSchedule.off = [];
                groupSchedule.originalNormal = [];
                groupSchedule.originalEvening = [];
                groupSchedule.travel = travels;
                
                // 每个组只安排1人值班（正常班），排除出差员工
                const activeMembers = group.members.filter(m => 
                    m.active && 
                    !leaves.includes(m.id) && 
                    !travels.includes(m.id)
                );
                
                if (activeMembers.length > 0) {
                    // 选择最近值班天数最少的人
                    const member = activeMembers.reduce((prev, curr) => 
                        (prev.workDays < curr.workDays) ? prev : curr
                    );
                    
                    groupSchedule.normal.push(member.id);
                    groupSchedule.originalNormal.push(member.id);
                    member.workDays++;
                    member.lastShift = 'normal';
                }
                
                // 其他人都为空闲
                activeMembers.forEach(member => {
                    if (!groupSchedule.normal.includes(member.id) && 
                        !leaves.includes(member.id) && 
                        !travels.includes(member.id)) {
                        groupSchedule.off.push(member.id);
                    }
                });
                
                // 保留请假人员
                groupSchedule.leave = leaves;
            });
        }

        // 全体休息模式
        function generateDayOffSchedule(date) {
            const dayData = monthlySchedule[date];
            
            Object.keys(groups).forEach(groupKey => {
                const group = groups[groupKey];
                const groupSchedule = dayData.groups[groupKey];
                
                // 保留请假和出差人员
                const leaves = [...groupSchedule.leave];
                const travels = [...groupSchedule.travel];
                
                // 所有人都设为空闲，除了请假和出差人员
                groupSchedule.normal = [];
                groupSchedule.evening = [];
                groupSchedule.off = group.members.filter(m => 
                    m.active && 
                    !leaves.includes(m.id) && 
                    !travels.includes(m.id)
                ).map(m => m.id);
                groupSchedule.originalNormal = [];
                groupSchedule.originalEvening = [];
                groupSchedule.leave = leaves;
                groupSchedule.travel = travels;
            });
        }

        // 渲染日历
        function renderCalendar() {
            const calendarGrid = document.getElementById('calendarGrid');
            calendarGrid.innerHTML = '';
            
            // 添加星期标题
            const weekdays = ['周日', '周一', '周二', '周三', '周四', '周五', '周六'];
            weekdays.forEach(day => {
                const header = document.createElement('div');
                header.className = 'calendar-header';
                header.textContent = day;
                calendarGrid.appendChild(header);
            });
            
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const today = new Date();
            const todayKey = `${today.getFullYear()}-${today.getMonth() + 1}-${today.getDate()}`;
            
            // 修改：对于2026年1月，从15号开始显示
            let startDay = 1;
            if (year === 2026 && month === 0) { // 2026年1月
                startDay = 15;
                // 添加额外的空白格子，使15号落在正确的位置
                for (let i = 0; i < firstDay + 14; i++) { // 14是因为15号是第15天，前面有14天
                    const emptyDay = document.createElement('div');
                    emptyDay.className = 'calendar-day empty-day';
                    emptyDay.style.backgroundColor = '#f8f9fa';
                    emptyDay.style.color = '#ccc';
                    const dayNum = i - firstDay + 1;
                    if (dayNum >= 1 && dayNum < 15) {
                        emptyDay.innerHTML = `<div class="day-number"><span>${dayNum}</span></div>`;
                    } else {
                        emptyDay.innerHTML = '<div class="day-number"><span></span></div>';
                    }
                    calendarGrid.appendChild(emptyDay);
                }
            } else if (year < 2026 || (year === 2026 && month < 0)) {
                // 对于2026年1月之前的月份，显示空日历
                const emptyDays = 42; // 6行 * 7天
                for (let i = 0; i < emptyDays; i++) {
                    const emptyDay = document.createElement('div');
                    emptyDay.className = 'calendar-day empty-day';
                    emptyDay.style.backgroundColor = '#f8f9fa';
                    emptyDay.style.color = '#ccc';
                    emptyDay.innerHTML = '<div class="day-number"><span></span></div>';
                    calendarGrid.appendChild(emptyDay);
                }
                // 添加提示信息
                const messageDiv = document.createElement('div');
                messageDiv.className = 'empty-month-message';
                messageDiv.innerHTML = '排班系统从2026年1月15日开始';
                calendarGrid.appendChild(messageDiv);
                return;
            } else {
                // 其他月份正常显示
                for (let i = 0; i < firstDay; i++) {
                    const emptyDay = document.createElement('div');
                    emptyDay.className = 'calendar-day';
                    calendarGrid.appendChild(emptyDay);
                }
            }
            
            // 添加日期格子
            for (let day = startDay; day <= daysInMonth; day++) {
                const dateKey = `${year}-${month + 1}-${day}`;
                const dateObj = new Date(year, month, day);
                const dayOfWeek = dateObj.getDay();
                const isToday = dateKey === todayKey;
                const schedule = monthlySchedule[dateKey];
                
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day';
                dayElement.setAttribute('data-date', dateKey);
                
                if (isToday) {
                    dayElement.classList.add('today');
                }
                if (dayOfWeek === 0 || dayOfWeek === 6) {
                    dayElement.classList.add('weekend');
                }
                if (schedule && schedule.isSpecial) {
                    dayElement.classList.add('holiday');
                }
                
                let content = `
                    <div class="day-number">
                        <span>${day}</span>
                        <button class="btn btn-sm btn-outline-primary edit-day-btn" title="编辑">
                            <i class="fas fa-edit"></i>
                        </button>
                    </div>
                `;
                
                if (schedule && schedule.note) {
                    content += `<div class="calendar-note">${schedule.note}</div>`;
                }
                
                dayElement.innerHTML = content;
                
                // 点击日期格子只显示排班详情
                dayElement.addEventListener('click', function(e) {
                    if (!e.target.closest('.edit-day-btn')) {
                        showDailyScheduleDetail(dateKey);
                    }
                });
                
                calendarGrid.appendChild(dayElement);
            }
        }

        // 显示当日排班详情 - 横向排版（包含出差信息）
        function showDailyScheduleDetail(dateKey) {
            selectedDay = dateKey;
            const detailContainer = document.getElementById('dailyScheduleDetail');
            const schedule = monthlySchedule[dateKey];
            const dateObj = new Date(schedule.date);
            const dateStr = `${dateObj.getFullYear()}年${dateObj.getMonth() + 1}月${dateObj.getDate()}日`;
            
            document.getElementById('dailyScheduleTitle').textContent = `${dateStr} 排班详情`;
            
            const contentContainer = document.getElementById('dailyScheduleContent');
            contentContainer.innerHTML = '';
            
            // 为每个组别创建横向排班的排班详情
            Object.keys(groups).forEach(groupKey => {
                const group = groups[groupKey];
                const groupSchedule = schedule.groups[groupKey];
                
                const groupDiv = document.createElement('div');
                groupDiv.className = 'horizontal-group';
                
                let groupContent = `
                    <div class="horizontal-group-header ${group.color}">${group.name}</div>
                    <div class="horizontal-group-content">
                `;
                
                // 正常班人员
                if (groupSchedule.normal.length > 0) {
                    const normalNames = groupSchedule.normal.map(memberId => {
                        const member = getEmployeeById(memberId);
                        const isReplacement = !groupSchedule.originalNormal.includes(memberId);
                        return `<span class="schedule-name">${member.name}${isReplacement ? ' <span class="text-danger">(顶)</span>' : ''}</span>`;
                    }).join('');
                    
                    groupContent += `
                        <div class="schedule-row">
                            <div class="schedule-label">正常班:</div>
                            <div class="schedule-names">${normalNames}</div>
                        </div>
                    `;
                }
                
                // 晚班人员
                if (groupSchedule.evening.length > 0) {
                    const eveningNames = groupSchedule.evening.map(memberId => {
                        const member = getEmployeeById(memberId);
                        const isReplacement = !groupSchedule.originalEvening.includes(memberId);
                        return `<span class="schedule-name">${member.name}${isReplacement ? ' <span class="text-danger">(顶)</span>' : ''}</span>`;
                    }).join('');
                    
                    groupContent += `
                        <div class="schedule-row">
                            <div class="schedule-label">晚班:</div>
                            <div class="schedule-names">${eveningNames}</div>
                        </div>
                    `;
                }
                
                // 请假人员
                if (groupSchedule.leave.length > 0) {
                    const leaveNames = groupSchedule.leave.map(memberId => {
                        const member = getEmployeeById(memberId);
                        return `<span class="schedule-name">${member.name}</span>`;
                    }).join('');
                    
                    groupContent += `
                        <div class="schedule-row">
                            <div class="schedule-label">请假:</div>
                            <div class="schedule-names">${leaveNames}</div>
                        </div>
                    `;
                }
                
                // 出差人员
                if (groupSchedule.travel.length > 0) {
                    const travelNames = groupSchedule.travel.map(memberId => {
                        const member = getEmployeeById(memberId);
                        const travelInfo = getEmployeeTravelInfo(memberId, dateObj);
                        const travelText = travelInfo ? ` (${travelInfo.destination || '出差'})` : ' (出差)';
                        return `<span class="schedule-name">${member.name}${travelText}</span>`;
                    }).join('');
                    
                    groupContent += `
                        <div class="schedule-row">
                            <div class="schedule-label">出差:</div>
                            <div class="schedule-names">${travelNames}</div>
                        </div>
                    `;
                }
                
                // 空闲人员
                if (groupSchedule.off.length > 0) {
                    const offNames = groupSchedule.off.map(memberId => {
                        const member = getEmployeeById(memberId);
                        return `<span class="schedule-name">${member.name}</span>`;
                    }).join('');
                    
                    groupContent += `
                        <div class="schedule-row">
                            <div class="schedule-label">空闲:</div>
                            <div class="schedule-names">${offNames}</div>
                        </div>
                    `;
                }
                
                groupContent += `</div>`;
                groupDiv.innerHTML = groupContent;
                contentContainer.appendChild(groupDiv);
            });
            
            // 显示详情区域
            detailContainer.style.display = 'block';
            
            // 滚动到详情区域
            detailContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        // 渲染部门组别概览 - 紧凑版（包含出差状态）
        function renderGroupOverview() {
            const container = document.getElementById('groupOverviewContainer');
            container.innerHTML = '';
            
            Object.keys(groups).forEach(groupKey => {
                const group = groups[groupKey];
                const activeMembers = group.members.filter(m => m.active);
                
                if (activeMembers.length === 0) return;
                
                const groupDiv = document.createElement('div');
                groupDiv.className = 'compact-group';
                
                // 计算组内统计数据
                const totalWorkDays = activeMembers.reduce((sum, member) => sum + member.workDays, 0);
                const totalTravelDays = activeMembers.reduce((sum, member) => sum + member.travelDays, 0);
                const avgWorkDays = activeMembers.length > 0 ? Math.round(totalWorkDays / activeMembers.length) : 0;
                const maxWorkDays = Math.max(...activeMembers.map(m => m.workDays));
                
                // 检查是否为自定义组别
                const isCustomGroup = systemConfig.customGroups && systemConfig.customGroups[groupKey];
                
                let groupContent = `
                    <div class="compact-group-header d-flex justify-content-between align-items-center ${group.color}">
                        <div class="flex-grow-1">
                            <div class="d-flex align-items-center">
                                <strong>${group.name}</strong>
                                ${isCustomGroup ? 
                                    '<span class="badge bg-info ms-2" style="font-size: 0.6rem;">自定义</span>' : 
                                    '<span class="badge bg-light text-dark ms-2" style="font-size: 0.6rem;">默认</span>'
                                }
                            </div>
                            <div class="small text-muted mt-1">
                                成员: ${activeMembers.length}人 | 
                                总工时: ${totalWorkDays}天 | 
                                出差: ${totalTravelDays}天 | 
                                人均: ${avgWorkDays}天
                            </div>
                        </div>
                        <div class="group-stats-badge">
                            <span class="badge ${maxWorkDays > avgWorkDays + 3 ? 'bg-warning' : 'bg-primary'}">
                                最高${maxWorkDays}天
                            </span>
                        </div>
                    </div>
                    <div class="compact-group-members">
                `;
                
                // 按工作天数排序
                const sortedMembers = [...activeMembers].sort((a, b) => b.workDays - a.workDays);
                
                sortedMembers.forEach(member => {
                    const workRatio = member.workDays / (maxWorkDays || 1) * 100;
                    const intensityColor = workRatio > 90 ? 'danger' : 
                                         workRatio > 70 ? 'warning' : 
                                         workRatio > 50 ? 'primary' : 'success';
                    
                    // 检查员工是否正在出差
                    const isTraveling = isEmployeeOnTravel(member.id, new Date());
                    const travelInfo = getEmployeeTravelInfo(member.id, new Date());
                    
                    groupContent += `
                        <div class="compact-member d-flex justify-content-between align-items-center">
                            <div class="compact-member-info">
                                <span class="member-name">${member.name}</span>
                                <div class="member-stats">
                                    <small class="text-muted">
                                        <i class="fas fa-calendar-day me-1"></i>工作${member.workDays}天
                                        ${member.leaveDays > 0 ? 
                                            `<span class="text-warning ms-2">
                                                <i class="fas fa-umbrella-beach me-1"></i>请假${member.leaveDays}天
                                            </span>` : ''
                                        }
                                        ${member.travelDays > 0 ? 
                                            `<span class="text-info ms-2">
                                                <i class="fas fa-plane me-1"></i>出差${member.travelDays}天
                                            </span>` : ''
                                        }
                                    </small>
                                    ${isTraveling && travelInfo ? 
                                        `<div class="member-travel-indicator mt-1">
                                            <i class="fas fa-map-marker-alt me-1"></i>
                                            ${travelInfo.destination || '出差中'}
                                        </div>` : ''
                                    }
                                </div>
                            </div>
                            <div class="member-indicators">
                                <div class="progress work-intensity-bar" style="width: 60px; height: 6px;">
                                    <div class="progress-bar bg-${intensityColor}" 
                                         role="progressbar" 
                                         style="width: ${workRatio}%"
                                         aria-valuenow="${workRatio}" 
                                         aria-valuemin="0" 
                                         aria-valuemax="100">
                                    </div>
                                </div>
                                <div class="member-status-badge mt-1">
                                    ${isTraveling ? 
                                        `<span class="badge bg-travel travel-status-badge">
                                            <i class="fas fa-plane me-1"></i>出差
                                        </span>` : 
                                        member.lastShift ? 
                                            `<span class="badge ${member.lastShift === 'normal' ? 'bg-primary' : 'bg-purple'}">
                                                ${member.lastShift === 'normal' ? '白班' : '晚班'}
                                            </span>` : 
                                            '<span class="badge bg-secondary">未排</span>'
                                    }
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                groupContent += `</div>`;
                groupDiv.innerHTML = groupContent;
                container.appendChild(groupDiv);
            });
        }

        // 组别概览收起/展开功能
        function toggleGroupOverview() {
            const body = document.getElementById('groupOverviewBody');
            const icon = document.getElementById('groupOverviewIcon');
            const text = document.getElementById('groupOverviewText');
            
            isGroupOverviewExpanded = !isGroupOverviewExpanded;
            
            if (isGroupOverviewExpanded) {
                body.style.display = 'block';
                icon.className = 'fas fa-chevron-up';
                text.textContent = '收起';
                
                // 添加展开动画
                body.style.opacity = '0';
                setTimeout(() => {
                    body.style.opacity = '1';
                    body.style.transition = 'opacity 0.3s ease';
                }, 10);
            } else {
                icon.className = 'fas fa-chevron-down';
                text.textContent = '展开';
                
                // 添加收起动画
                body.style.opacity = '0';
                body.style.transition = 'opacity 0.3s ease';
                setTimeout(() => {
                    body.style.display = 'none';
                }, 300);
            }
        }

        // 刷新组别概览
        function refreshGroupOverview() {
            const refreshBtn = document.getElementById('refreshGroupOverview');
            
            // 添加旋转动画
            refreshBtn.querySelector('i').className = 'fas fa-spinner fa-spin';
            
            setTimeout(() => {
                renderGroupOverview();
                updateGroupCount();
                
                // 恢复图标
                refreshBtn.querySelector('i').className = 'fas fa-sync-alt';
                
                showNotification('组别概览已刷新', 'success');
            }, 500);
        }

        // 更新组别数量显示
        function updateGroupCount() {
            const activeGroups = Object.keys(groups).filter(groupKey => {
                const group = groups[groupKey];
                return group.members.some(member => member.active);
            }).length;
            
            document.getElementById('groupCountBadge').textContent = `${activeGroups}个组`;
        }

        // 渲染组别排班配置表单
        function renderGroupScheduleConfigs() {
            const container = document.getElementById('groupScheduleConfigs');
            container.innerHTML = '';
            
            Object.keys(groups).forEach(groupKey => {
                const group = groups[groupKey];
                const config = systemConfig.groupConfigs[groupKey] || { normalCount: 0, eveningCount: 0 };
                
                const memberCount = group.members.filter(m => m.active).length;
                
                // 检查是否为自定义组别
                const isCustomGroup = systemConfig.customGroups && systemConfig.customGroups[groupKey];
                
                const groupDiv = document.createElement('div');
                groupDiv.className = 'group-config-section';
                
                groupDiv.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <div>
                            <h6 class="mb-0 ${group.color}">
                                ${group.name}
                                ${isCustomGroup ? '<span class="badge bg-secondary ms-2">自定义</span>' : ''}
                            </h6>
                            <div class="small text-muted">ID: ${groupKey}</div>
                        </div>
                        <div>
                            <span class="badge bg-secondary">活跃成员: ${memberCount}人</span>
                            ${isCustomGroup ? 
                                `<span class="badge bg-info ms-1">自定义组别</span>` : 
                                `<span class="badge bg-light text-dark ms-1">默认组别</span>`
                            }
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-2">
                            <label for="config_${groupKey}_normal" class="form-label small">每日正常班人数</label>
                            <div class="input-group input-group-sm">
                                <input type="number" 
                                       class="form-control" 
                                       id="config_${groupKey}_normal" 
                                       value="${config.normalCount}" 
                                       min="0" 
                                       max="${memberCount}">
                                <span class="input-group-text">人</span>
                            </div>
                            <div class="form-text small">最大: ${memberCount}人</div>
                        </div>
                        
                        <div class="col-md-6 mb-2">
                            <label for="config_${groupKey}_evening" class="form-label small">每日晚班人数</label>
                            <div class="input-group input-group-sm">
                                <input type="number" 
                                       class="form-control" 
                                       id="config_${groupKey}_evening" 
                                       value="${config.eveningCount}" 
                                       min="0" 
                                       max="${memberCount}">
                                <span class="input-group-text">人</span>
                            </div>
                            <div class="form-text small">最大: ${memberCount}人</div>
                        </div>
                    </div>
                    
                    <div class="small text-muted mt-2">
                        每日排班总数: <span id="total_${groupKey}">${config.normalCount + config.eveningCount}</span>人 
                        (空闲: ${memberCount - (config.normalCount + config.eveningCount)}人)
                    </div>
                    
                    <div class="config-validation mt-2" id="validation_${groupKey}"></div>
                `;
                
                container.appendChild(groupDiv);
                
                // 添加输入变化监听
                const normalInput = document.getElementById(`config_${groupKey}_normal`);
                const eveningInput = document.getElementById(`config_${groupKey}_evening`);
                
                const updateValidation = () => {
                    const normal = parseInt(normalInput.value) || 0;
                    const evening = parseInt(eveningInput.value) || 0;
                    const total = normal + evening;
                    
                    // 更新总数显示
                    document.getElementById(`total_${groupKey}`).textContent = total;
                    
                    // 显示验证信息
                    const validationDiv = document.getElementById(`validation_${groupKey}`);
                    
                    if (total > memberCount) {
                        validationDiv.innerHTML = `<span class="text-danger small"><i class="fas fa-exclamation-triangle me-1"></i>排班总数超过活跃成员数</span>`;
                        validationDiv.className = 'config-validation text-danger';
                    } else if (total === 0) {
                        validationDiv.innerHTML = `<span class="text-warning small"><i class="fas fa-info-circle me-1"></i>该组当日无排班</span>`;
                        validationDiv.className = 'config-validation text-warning';
                    } else {
                        validationDiv.innerHTML = `<span class="text-success small"><i class="fas fa-check-circle me-1"></i>配置有效</span>`;
                        validationDiv.className = 'config-validation text-success';
                    }
                };
                
                normalInput.addEventListener('input', updateValidation);
                eveningInput.addEventListener('input', updateValidation);
                
                // 初始验证
                updateValidation();
            });
        }

        // 保存组别配置（只更新当日及往后的排班）
        function saveGroupConfigs() {
            let hasError = false;
            
            // 验证所有配置
            Object.keys(groups).forEach(groupKey => {
                const memberCount = groups[groupKey].members.filter(m => m.active).length;
                const normalInput = document.getElementById(`config_${groupKey}_normal`);
                const eveningInput = document.getElementById(`config_${groupKey}_evening`);
                
                const normal = parseInt(normalInput.value) || 0;
                const evening = parseInt(eveningInput.value) || 0;
                const total = normal + evening;
                
                if (total > memberCount) {
                    hasError = true;
                    const validationDiv = document.getElementById(`validation_${groupKey}`);
                    validationDiv.innerHTML = `<span class="text-danger small"><i class="fas fa-exclamation-circle me-1"></i>错误：排班总数超过活跃成员数</span>`;
                    validationDiv.className = 'config-validation text-danger';
                }
            });
            
            if (hasError) {
                showNotification('部分配置存在错误，请检查', 'error');
                return;
            }
            
            // 保存配置到系统配置
            Object.keys(groups).forEach(groupKey => {
                const normalInput = document.getElementById(`config_${groupKey}_normal`);
                const eveningInput = document.getElementById(`config_${groupKey}_evening`);
                
                if (!systemConfig.groupConfigs[groupKey]) {
                    systemConfig.groupConfigs[groupKey] = { normalCount: 0, eveningCount: 0 };
                }
                
                systemConfig.groupConfigs[groupKey].normalCount = parseInt(normalInput.value) || 0;
                systemConfig.groupConfigs[groupKey].eveningCount = parseInt(eveningInput.value) || 0;
                
                // 更新groups对象
                groups[groupKey].normalCount = systemConfig.groupConfigs[groupKey].normalCount;
                groups[groupKey].eveningCount = systemConfig.groupConfigs[groupKey].eveningCount;
            });
            
            // 保存到本地存储
            saveSystemConfig();
            
            // 只重新生成今日及往后的排班
            updateFutureSchedules();
            
            showNotification('组别配置已保存，今日及往后的排班已更新', 'success');
        }

        // 只更新今日及往后的排班
        function updateFutureSchedules() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const today = new Date();
            
            // 计算当前月份的今天日期
            const todayDay = today.getDate();
            
            for (let day = todayDay; day <= daysInMonth; day++) {
                const dateKey = `${year}-${month + 1}-${day}`;
                const dateObj = new Date(year, month, day);
                
                // 如果该日期已有排班数据
                if (monthlySchedule[dateKey]) {
                    // 保存原有的请假和备注信息
                    const dayData = monthlySchedule[dateKey];
                    const existingLeaves = {};
                    const existingNotes = dayData.note || "";
                    
                    Object.keys(groups).forEach(groupKey => {
                        existingLeaves[groupKey] = [...dayData.groups[groupKey].leave];
                    });
                    
                    // 检查是否为节假日
                    const dateStr = dateObj.toISOString().split('T')[0];
                    const isHoliday = systemConfig.holidays && systemConfig.holidays[dateStr];
                    
                    if (isHoliday && systemConfig.autoGenerateHolidaySchedule) {
                        // 节假日，重新生成节假日排班
                        dayData.isSpecial = true;
                        dayData.note = isHoliday.name + " (节假日)";
                        generateHolidayScheduleForDate(dateKey, dateObj);
                    } else {
                        // 非节假日，重新生成正常排班
                        dayData.isSpecial = false;
                        generateDailyScheduleForDate(dateKey, dateObj, existingLeaves, existingNotes);
                    }
                }
            }
            
            // 更新显示
            renderCalendar();
            updateStatistics();
            renderGroupOverview();
            
            // 如果当前有选中的日期，重新显示排班详情
            if (selectedDay) {
                showDailyScheduleDetail(selectedDay);
            }
        }

        // 为特定日期生成排班（保持请假和备注）
        function generateDailyScheduleForDate(dateKey, dateObj, existingLeaves = {}, existingNote = "") {
            const dayOfWeek = dateObj.getDay();
            
            monthlySchedule[dateKey] = {
                date: dateObj,
                dayOfWeek: dayOfWeek,
                isWeekend: dayOfWeek === 0 || dayOfWeek === 6,
                isSpecial: false,
                note: existingNote,
                groups: {}
            };
            
            // 为每个组别生成排班
            Object.keys(groups).forEach(groupKey => {
                const group = groups[groupKey];
                monthlySchedule[dateKey].groups[groupKey] = {
                    normal: [],
                    evening: [],
                    off: [],
                    leave: existingLeaves[groupKey] || [],
                    travel: [], // 出差人员
                    replacements: [],
                    originalNormal: [],
                    originalEvening: []
                };
                
                // 获取活跃且未请假、未出差的员工
                const activeMembers = group.members.filter(m => {
                    if (!m.active) return false;
                    if (existingLeaves[groupKey]?.includes(m.id)) return false;
                    
                    // 检查是否出差
                    if (isEmployeeOnTravel(m.id, dateObj)) {
                        monthlySchedule[dateKey].groups[groupKey].travel.push(m.id);
                        m.travelDays++;
                        return false;
                    }
                    
                    return true;
                });
                
                // 正常班安排
                const normalCount = Math.min(group.normalCount, activeMembers.length);
                if (normalCount > 0) {
                    // 按工作天数排序，优先安排工作天数少的员工
                    const sortedMembers = [...activeMembers].sort((a, b) => {
                        return a.workDays - b.workDays;
                    });
                    
                    for (let i = 0; i < normalCount; i++) {
                        const member = sortedMembers[i];
                        monthlySchedule[dateKey].groups[groupKey].normal.push(member.id);
                        member.workDays++;
                        member.lastShift = 'normal';
                    }
                    
                    // 记录原始安排
                    monthlySchedule[dateKey].groups[groupKey].originalNormal = [...monthlySchedule[dateKey].groups[groupKey].normal];
                }
                
                // 晚班安排
                const eveningCount = Math.min(group.eveningCount, activeMembers.length);
                if (eveningCount > 0) {
                    // 排除已经安排正常班的员工
                    const availableMembers = activeMembers.filter(m => 
                        !monthlySchedule[dateKey].groups[groupKey].normal.includes(m.id)
                    );
                    
                    // 按工作天数排序
                    const sortedMembers = [...availableMembers].sort((a, b) => {
                        return a.workDays - b.workDays;
                    });
                    
                    for (let i = 0; i < eveningCount && i < sortedMembers.length; i++) {
                        const member = sortedMembers[i];
                        monthlySchedule[dateKey].groups[groupKey].evening.push(member.id);
                        member.workDays++;
                        member.lastShift = 'evening';
                    }
                    
                    // 记录原始安排
                    monthlySchedule[dateKey].groups[groupKey].originalEvening = [...monthlySchedule[dateKey].groups[groupKey].evening];
                }
                
                // 空闲人员（包括请假人员也会显示在这里）
                const allActiveMembers = group.members.filter(m => m.active);
                allActiveMembers.forEach(member => {
                    if (!monthlySchedule[dateKey].groups[groupKey].normal.includes(member.id) &&
                        !monthlySchedule[dateKey].groups[groupKey].evening.includes(member.id) &&
                        !monthlySchedule[dateKey].groups[groupKey].leave.includes(member.id) &&
                        !monthlySchedule[dateKey].groups[groupKey].travel.includes(member.id)) {
                        monthlySchedule[dateKey].groups[groupKey].off.push(member.id);
                    }
                });
            });
            
            // 检查是否节假日
            if (systemConfig.holidays) {
                const dateStr = dateObj.toISOString().split('T')[0];
                if (systemConfig.holidays[dateStr]) {
                    monthlySchedule[dateKey].isSpecial = true;
                    monthlySchedule[dateKey].note = systemConfig.holidays[dateStr].name + " " + (monthlySchedule[dateKey].note || "");
                }
            }
        }

        // 重置组别配置
        function resetGroupConfigs() {
            showConfirmModal(
                '恢复默认配置',
                '确定要恢复所有组别的默认排班配置吗？这将重置所有修改并重新生成排班。',
                function() {
                    // 恢复默认配置
                    systemConfig.groupConfigs = {
                        leader: { normalCount: 1, eveningCount: 1 },
                        director: { normalCount: 2, eveningCount: 3 },
                        editor: { normalCount: 3, eveningCount: 5 },
                        camera: { normalCount: 3, eveningCount: 3 },
                        flexible: { normalCount: 3, eveningCount: 4 },
                        design: { normalCount: 2, eveningCount: 2 }
                    };
                    
                    // 更新groups对象
                    Object.keys(groups).forEach(groupKey => {
                        if (systemConfig.groupConfigs[groupKey]) {
                            groups[groupKey].normalCount = systemConfig.groupConfigs[groupKey].normalCount;
                            groups[groupKey].eveningCount = systemConfig.groupConfigs[groupKey].eveningCount;
                        }
                    });
                    
                    // 重新渲染配置表单
                    renderGroupScheduleConfigs();
                    
                    // 重新生成排班
                    updateFutureSchedules();
                    
                    // 保存配置
                    saveSystemConfig();
                    
                    showNotification('组别配置已恢复为默认值', 'success');
                }
            );
        }

        // 打开日期详情（编辑模式）
        function openDayDetail(dateKey) {
            selectedDay = dateKey;
            const dayData = monthlySchedule[dateKey];
            const dateObj = new Date(dayData.date);
            
            document.getElementById('dayDetailTitle').textContent = 
                `${dateObj.getFullYear()}年${dateObj.getMonth() + 1}月${dateObj.getDate()}日排班设置`;
            
            document.getElementById('dayBasicInfo').innerHTML = `
                星期${['日','一','二','三','四','五','六'][dateObj.getDay()]} | 
                ${dayData.isWeekend ? '周末' : '工作日'} |
                ${dayData.isSpecial ? '节假日' : '正常工作日'}
            `;
            
            // 显示顶班信息
            renderReplacementInfo(dateKey);
            
            // 显示自定义备注
            document.getElementById('dayNote').value = dayData.note || '';
            
            // 隐藏请假表单
            document.getElementById('leaveFormSection').style.display = 'none';
            selectedEmployeeForLeave = null;
            
            // 渲染部门排班设置
            renderDepartmentStatusList(dateKey);
            
            const modal = new bootstrap.Modal(document.getElementById('dayDetailModal'));
            modal.show();
        }

        function renderReplacementInfo(dateKey) {
            const container = document.getElementById('replacementInfo');
            const dayData = monthlySchedule[dateKey];
            
            let hasReplacements = false;
            let html = '';
            
            Object.keys(groups).forEach(groupKey => {
                const groupSchedule = dayData.groups[groupKey];
                if (groupSchedule.replacements.length > 0) {
                    hasReplacements = true;
                    const group = groups[groupKey];
                    
                    html += `<div class="mb-2"><strong>${group.name}:</strong><br>`;
                    
                    groupSchedule.replacements.forEach(replacement => {
                        const original = getEmployeeById(replacement.original);
                        const replacementE = getEmployeeById(replacement.replacement);
                        if (original && replacementE) {
                            html += `
                                <div class="small">
                                    ${original.name} 请假 → ${replacementE.name} 顶班
                                    <br><small class="text-muted">原因: ${replacement.reason}</small>
                                </div>
                            `;
                        }
                    });
                    
                    html += `</div>`;
                }
            });
            
            if (!hasReplacements) {
                html = '<p class="text-muted small mb-0">无顶班情况</p>';
            }
            
            container.innerHTML = html;
        }

        function renderDepartmentStatusList(dateKey) {
            const container = document.getElementById('departmentStatusList');
            container.innerHTML = '';
            
            const dayData = monthlySchedule[dateKey];
            
            Object.keys(groups).forEach(groupKey => {
                const group = groups[groupKey];
                const groupSchedule = dayData.groups[groupKey];
                
                const groupSection = document.createElement('div');
                groupSection.className = 'group-section mb-3';
                
                let groupContent = `
                    <div class="group-header ${group.color}">${group.name}</div>
                    <div class="group-body">
                `;
                
                group.members.forEach(member => {
                    if (!member.active) return;
                    
                    const isNormal = groupSchedule.normal.includes(member.id);
                    const isEvening = groupSchedule.evening.includes(member.id);
                    const isOff = groupSchedule.off.includes(member.id);
                    const isLeave = groupSchedule.leave.includes(member.id);
                    const isTravel = groupSchedule.travel.includes(member.id);
                    const isOriginalNormal = groupSchedule.originalNormal.includes(member.id);
                    const isOriginalEvening = groupSchedule.originalEvening.includes(member.id);
                    const isReplacement = (isNormal && !isOriginalNormal) || (isEvening && !isOriginalEvening);
                    
                    groupContent += `
                        <div class="group-member mb-2 d-flex align-items-center">
                            <div class="me-2">${member.avatar}</div>
                            <div class="me-auto">${member.name}${isReplacement ? ' <span class="text-danger">(顶)</span>' : ''}</div>
                            <div class="status-toggle">
                                ${isTravel ? 
                                    `<span class="badge bg-travel me-2">出差中</span>` :
                                    isLeave ? 
                                    `<span class="badge bg-warning me-2">已请假</span>
                                     <button class="btn btn-sm btn-outline-secondary" onclick="cancelEmployeeLeave(${member.id}, '${groupKey}')">取消</button>` :
                                    `<select class="form-select form-select-sm employee-role" data-employee="${member.id}" data-group="${groupKey}" style="width: 100px;">
                                        <option value="off" ${isOff ? 'selected' : ''}>空闲</option>
                                        <option value="normal" ${isNormal ? 'selected' : ''}>正常班</option>
                                        <option value="evening" ${isEvening ? 'selected' : ''}>晚班</option>
                                    </select>
                                    <button class="btn btn-sm btn-outline-warning mt-1" onclick="showLeaveForm(${member.id}, '${groupKey}')">请假</button>`
                                }
                            </div>
                        </div>
                    `;
                });
                
                groupContent += `</div></div>`;
                groupSection.innerHTML = groupContent;
                container.appendChild(groupSection);
            });
        }

        // 显示请假表单
        function showLeaveForm(employeeId, groupKey) {
            selectedEmployeeForLeave = { id: employeeId, group: groupKey };
            document.getElementById('leaveFormSection').style.display = 'block';
            document.getElementById('leaveReason').value = '';
            document.getElementById('leaveType').value = '年假';
            
            // 滚动到表单位置
            document.getElementById('leaveFormSection').scrollIntoView({ behavior: 'smooth' });
        }

        function cancelLeave() {
            document.getElementById('leaveFormSection').style.display = 'none';
            selectedEmployeeForLeave = null;
        }

        function cancelEmployeeLeave(employeeId, groupKey) {
            const schedule = monthlySchedule[selectedDay];
            const groupSchedule = schedule.groups[groupKey];
            const leaveIndex = groupSchedule.leave.indexOf(employeeId);
            if (leaveIndex !== -1) {
                groupSchedule.leave.splice(leaveIndex, 1);
                
                // 更新员工请假天数
                const employee = getEmployeeById(employeeId);
                if (employee) {
                    employee.leaveDays = Math.max(0, employee.leaveDays - 1);
                }
                
                // 重新渲染状态列表
                renderDepartmentStatusList(selectedDay);
                
                // 更新统计数据
                updateStatistics();
                
                showNotification('已取消请假状态', 'success');
            }
        }

        function submitLeave() {
            if (!selectedEmployeeForLeave) return;
            
            const reason = document.getElementById('leaveReason').value;
            const type = document.getElementById('leaveType').value;
            
            if (!reason.trim()) {
                showNotification('请输入请假原因', 'warning');
                return;
            }
            
            const schedule = monthlySchedule[selectedDay];
            const groupSchedule = schedule.groups[selectedEmployeeForLeave.group];
            const employee = getEmployeeById(selectedEmployeeForLeave.id);
            
            if (!groupSchedule.leave.includes(selectedEmployeeForLeave.id)) {
                groupSchedule.leave.push(selectedEmployeeForLeave.id);
                
                // 如果该员工原本是正常班或晚班，需要移除
                const normalIndex = groupSchedule.normal.indexOf(selectedEmployeeForLeave.id);
                if (normalIndex !== -1) {
                    groupSchedule.normal.splice(normalIndex, 1);
                }
                
                const eveningIndex = groupSchedule.evening.indexOf(selectedEmployeeForLeave.id);
                if (eveningIndex !== -1) {
                    groupSchedule.evening.splice(eveningIndex, 1);
                }
                
                // 从空闲列表中移除
                const offIndex = groupSchedule.off.indexOf(selectedEmployeeForLeave.id);
                if (offIndex !== -1) {
                    groupSchedule.off.splice(offIndex, 1);
                }
                
                // 从出差列表中移除（如果存在）
                const travelIndex = groupSchedule.travel.indexOf(selectedEmployeeForLeave.id);
                if (travelIndex !== -1) {
                    groupSchedule.travel.splice(travelIndex, 1);
                }
                
                // 记录请假信息
                leaveRecords.push({
                    employeeId: selectedEmployeeForLeave.id,
                    group: selectedEmployeeForLeave.group,
                    date: selectedDay,
                    reason: reason,
                    type: type,
                    timestamp: new Date()
                });
                
                // 更新员工请假天数
                if (employee) {
                    employee.leaveDays++;
                }
                
                // 检查是否需要顶班
                if (systemConfig.autoReplacement && (normalIndex !== -1 || eveningIndex !== -1)) {
                    // 原本是工作人员，需要找人顶班
                    autoArrangeReplacement(selectedDay, selectedEmployeeForLeave.id, selectedEmployeeForLeave.group, reason, 
                                          normalIndex !== -1 ? 'normal' : 'evening');
                }
                
                // 隐藏请假表单
                document.getElementById('leaveFormSection').style.display = 'none';
                selectedEmployeeForLeave = null;
                
                // 重新渲染状态列表
                renderDepartmentStatusList(selectedDay);
                
                // 更新统计数据
                updateStatistics();
                
                // 发送请假通知
                if (systemConfig.autoNotifications) {
                    sendLeaveNotification(selectedDay, employee, reason, type);
                }
                
                showNotification('请假申请已提交', 'success');
            }
        }

        function autoArrangeReplacement(dateKey, leaveEmployeeId, groupKey, reason, role) {
            const schedule = monthlySchedule[dateKey];
            const groupSchedule = schedule.groups[groupKey];
            
            // 查找合适的顶班人员（从空闲人员中选择，排除出差员工）
            const availableEmployees = groups[groupKey].members.filter(e => 
                e.active && 
                e.id !== leaveEmployeeId && 
                groupSchedule.off.includes(e.id) && 
                !groupSchedule.leave.includes(e.id) &&
                !groupSchedule.travel.includes(e.id)
            );
            
            if (availableEmployees.length > 0) {
                // 选择第一个可用员工顶班
                const replacement = availableEmployees[0];
                
                // 根据原角色安排顶班
                if (role === 'normal') {
                    groupSchedule.normal.push(replacement.id);
                } else if (role === 'evening') {
                    groupSchedule.evening.push(replacement.id);
                }
                
                // 从空闲列表中移除
                const offIndex = groupSchedule.off.indexOf(replacement.id);
                if (offIndex !== -1) {
                    groupSchedule.off.splice(offIndex, 1);
                }
                
                // 记录顶班信息
                groupSchedule.replacements.push({
                    original: leaveEmployeeId,
                    replacement: replacement.id,
                    reason: `请假顶班: ${reason}`,
                    role: role
                });
                
                // 记录到全局顶班记录
                replacementRecords.push({
                    original: leaveEmployeeId,
                    replacement: replacement.id,
                    reason: `请假顶班: ${reason}`,
                    group: groupKey,
                    date: dateKey,
                    time: new Date().toLocaleTimeString()
                });
                
                // 发送顶班通知
                const leaveEmployee = getEmployeeById(leaveEmployeeId);
                const replacementEmployee = getEmployeeById(replacement.id);
                
                if (leaveEmployee && replacementEmployee && systemConfig.autoNotifications) {
                    const date = new Date(schedule.date);
                    const dateStr = `${date.getMonth() + 1}月${date.getDate()}日`;
                    const roleText = role === 'normal' ? '正常班' : '晚班';
                    const notificationMessage = `${dateStr}: ${replacementEmployee.name} 将顶替请假的 ${leaveEmployee.name} (${roleText})`;
                    addNotification('自动顶班安排', notificationMessage, 'replacement');
                }
                
                // 更新调整记录
                renderAdjustmentRecords();
            } else {
                showNotification('没有合适的顶班人员可用', 'warning');
            }
        }

        function sendLeaveNotification(dateKey, employee, reason, type) {
            const schedule = monthlySchedule[dateKey];
            const date = new Date(schedule.date);
            const dateStr = `${date.getMonth() + 1}月${date.getDate()}日`;
            
            const notificationMessage = `${dateStr}: ${employee.name} 申请${type}，原因: ${reason}`;
            addNotification('请假申请', notificationMessage, 'leave');
        }

        function saveDayChanges() {
            const dayData = monthlySchedule[selectedDay];
            
            // 保存自定义备注
            dayData.note = document.getElementById('dayNote').value;
            
            // 重置所有角色
            Object.keys(groups).forEach(groupKey => {
                const groupSchedule = dayData.groups[groupKey];
                groupSchedule.normal = [];
                groupSchedule.evening = [];
                groupSchedule.off = [];
            });
            
            // 收集状态更改
            const roleSelects = document.querySelectorAll('.employee-role');
            
            roleSelects.forEach(select => {
                const employeeId = parseInt(select.dataset.employee);
                const groupKey = select.dataset.group;
                const role = select.value;
                
                const groupSchedule = dayData.groups[groupKey];
                
                // 只有当不是请假状态和出差状态时才更新
                if (!groupSchedule.leave.includes(employeeId) && !groupSchedule.travel.includes(employeeId)) {
                    if (role === 'normal') {
                        groupSchedule.normal.push(employeeId);
                    } else if (role === 'evening') {
                        groupSchedule.evening.push(employeeId);
                    } else {
                        groupSchedule.off.push(employeeId);
                    }
                }
            });
            
            // 确保每个组别的排班人数符合要求
            validateDailySchedule(dayData);
            
            // 更新显示
            renderCalendar();
            renderAdjustmentRecords();
            showDailyScheduleDetail(selectedDay);
            
            // 记录历史
            scheduleHistory.push({
                action: '手动调整排班',
                timestamp: new Date(),
                details: `修改了 ${selectedDay} 的排班`
            });
            
            renderScheduleHistory();
            
            // 正确关闭模态框
            const modal = bootstrap.Modal.getInstance(document.getElementById('dayDetailModal'));
            if (modal) {
                modal.hide();
            }
            
            showNotification('排班更改已保存', 'success');
            
            // 更新统计数据
            updateStatistics();
        }

        // 验证每日排班是否符合要求
        function validateDailySchedule(dayData) {
            Object.keys(groups).forEach(groupKey => {
                const group = groups[groupKey];
                const groupSchedule = dayData.groups[groupKey];
                
                // 确保正常班人数符合要求
                if (groupSchedule.normal.length > group.normalCount) {
                    // 如果超过要求人数，保留前n人，其余移到空闲
                    const extra = groupSchedule.normal.splice(group.normalCount);
                    groupSchedule.off.push(...extra);
                } else if (groupSchedule.normal.length < group.normalCount) {
                    // 如果不足要求人数，从空闲人员中补充（排除请假和出差人员）
                    const needed = group.normalCount - groupSchedule.normal.length;
                    for (let i = 0; i < needed && groupSchedule.off.length > 0; i++) {
                        const availableMember = groupSchedule.off.find(id => 
                            !groupSchedule.leave.includes(id) && !groupSchedule.travel.includes(id)
                        );
                        if (availableMember) {
                            const index = groupSchedule.off.indexOf(availableMember);
                            groupSchedule.off.splice(index, 1);
                            groupSchedule.normal.push(availableMember);
                        }
                    }
                }
                
                // 确保晚班人数符合要求
                if (groupSchedule.evening.length > group.eveningCount) {
                    const extra = groupSchedule.evening.splice(group.eveningCount);
                    groupSchedule.off.push(...extra);
                } else if (groupSchedule.evening.length < group.eveningCount) {
                    const needed = group.eveningCount - groupSchedule.evening.length;
                    for (let i = 0; i < needed && groupSchedule.off.length > 0; i++) {
                        const availableMember = groupSchedule.off.find(id => 
                            !groupSchedule.leave.includes(id) && !groupSchedule.travel.includes(id)
                        );
                        if (availableMember) {
                            const index = groupSchedule.off.indexOf(availableMember);
                            groupSchedule.off.splice(index, 1);
                            groupSchedule.evening.push(availableMember);
                        }
                    }
                }
            });
        }

        function saveAndNotifyDayChanges() {
            saveDayChanges();
            
            const dayData = monthlySchedule[selectedDay];
            const date = new Date(dayData.date);
            const dateStr = `${date.getMonth() + 1}月${date.getDate()}日`;
            
            let message = `${dateStr}排班变更通知:\n\n`;
            
            Object.keys(groups).forEach(groupKey => {
                const group = groups[groupKey];
                const groupSchedule = dayData.groups[groupKey];
                
                message += `${group.name}:\n`;
                
                if (groupSchedule.normal.length > 0) {
                    const normalNames = groupSchedule.normal.map(id => {
                        const e = getEmployeeById(id);
                        return e ? e.name : '';
                    }).filter(name => name !== '').join('、');
                    message += `  正常班: ${normalNames}\n`;
                }
                
                if (groupSchedule.evening.length > 0) {
                    const eveningNames = groupSchedule.evening.map(id => {
                        const e = getEmployeeById(id);
                        return e ? e.name : '';
                    }).filter(name => name !== '').join('、');
                    message += `  晚班: ${eveningNames}\n`;
                }
                
                if (groupSchedule.leave.length > 0) {
                    const leaveNames = groupSchedule.leave.map(id => {
                        const e = getEmployeeById(id);
                        return e ? e.name : '';
                    }).filter(name => name !== '').join('、');
                    message += `  请假: ${leaveNames}\n`;
                }
                
                if (groupSchedule.travel.length > 0) {
                    const travelNames = groupSchedule.travel.map(id => {
                        const e = getEmployeeById(id);
                        return e ? e.name : '';
                    }).filter(name => name !== '').join('、');
                    message += `  出差: ${travelNames}\n`;
                }
                
                message += '\n';
            });
            
            // 添加到通知列表
            addNotification('排班变更', message, 'change');
            
            // 发送邮件通知
            if (systemConfig.emailConfig.enabled) {
                sendScheduleChangeEmails(selectedDay);
            }
            
            showNotification('排班已更新并发送通知', 'success');
        }

        // 人员管理功能
        function addEmployee(event) {
            event.preventDefault();
            
            const name = document.getElementById('employeeName').value.trim();
            const groupKey = document.getElementById('employeeGroup').value;
            const phone = document.getElementById('employeePhone').value;
            const email = document.getElementById('employeeEmail').value;
            const active = document.getElementById('employeeActive').checked;
            
            if (!name) {
                showNotification('请输入员工姓名', 'warning');
                return;
            }
            
            // 生成新员工ID
            let maxId = 0;
            Object.keys(groups).forEach(key => {
                groups[key].members.forEach(member => {
                    if (member.id > maxId) maxId = member.id;
                });
            });
            
            const newId = maxId + 1;
            const avatar = name.charAt(0);
            
            // 添加新员工
            groups[groupKey].members.push({
                id: newId,
                name: name,
                avatar: avatar,
                active: active,
                phone: phone,
                email: email,
                workDays: 0,
                leaveDays: 0,
                travelDays: 0,
                lastShift: null
            });
            
            // 重新生成今日及往后的排班
            updateFutureSchedules();
            
            // 更新显示
            renderCalendar();
            renderGroupOverview();
            renderEmployeeList();
            updateStatistics();
            saveAllData();
            
            // 重置表单
            document.getElementById('employeeForm').reset();
            
            showNotification('员工添加成功，排班已自动更新', 'success');
        }

        function renderEmployeeList() {
            const container = document.getElementById('employeeList');
            const filterGroup = document.getElementById('employeeFilterGroup').value;
            
            let html = '';
            
            Object.keys(groups).forEach(groupKey => {
                if (filterGroup !== 'all' && filterGroup !== groupKey) return;
                
                const group = groups[groupKey];
                
                html += `<div class="mb-2"><strong>${group.name}</strong></div>`;
                
                group.members.forEach(member => {
                    html += `
                        <div class="d-flex justify-content-between align-items-center p-2 border-bottom">
                            <div>
                                <span class="badge ${group.color} me-2">${member.avatar}</span>
                                <span>${member.name}</span>
                                <small class="text-muted ms-2">${member.phone}</small>
                            </div>
                            <div>
                                <span class="badge bg-primary me-1">工作${member.workDays}天</span>
                                ${member.travelDays > 0 ? `<span class="badge bg-travel me-1">出差${member.travelDays}天</span>` : ''}
                                <button class="btn btn-sm btn-outline-danger" onclick="deleteEmployee(${member.id}, '${groupKey}')">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    `;
                });
            });
            
            container.innerHTML = html || '<p class="text-muted">没有找到员工</p>';
        }

        function deleteEmployee(employeeId, groupKey) {
            showConfirmModal(
                '删除员工',
                `确定要删除员工 ${getEmployeeById(employeeId).name} 吗？系统将自动调整今日及往后的排班。`,
                function() {
                    const group = groups[groupKey];
                    const index = group.members.findIndex(m => m.id === employeeId);
                    
                    if (index !== -1) {
                        // 标记员工为非激活状态
                        group.members[index].active = false;
                        
                        // 重新生成今日及往后的排班
                        updateFutureSchedules();
                        
                        // 更新显示
                        renderCalendar();
                        renderGroupOverview();
                        renderEmployeeList();
                        updateStatistics();
                        saveAllData();
                        
                        showNotification('员工已删除，排班已自动调整', 'success');
                    }
                }
            );
        }

        // 保存系统设置
        function saveSystemSettings() {
            systemConfig.normalStartTime = document.getElementById('normalStartTime').value;
            systemConfig.normalEndTime = document.getElementById('normalEndTime').value;
            systemConfig.eveningStartTime = document.getElementById('eveningStartTime').value;
            systemConfig.eveningEndTime = document.getElementById('eveningEndTime').value;
            systemConfig.fairnessThreshold = parseInt(document.getElementById('fairnessThreshold').value);
            systemConfig.autoReplacement = document.getElementById('autoReplacement').checked;
            systemConfig.autoNotifications = document.getElementById('autoNotifications').checked;
            systemConfig.conflictDetection = document.getElementById('conflictDetection').checked;
            
            // 保存自动通知设置
            systemConfig.enableAutoNotifications = document.getElementById('enableAutoNotifications').checked;
            systemConfig.autoNotificationTime = document.getElementById('autoNotificationTime').value;
            systemConfig.notificationAdvanceDays = parseInt(document.getElementById('notificationAdvanceDays').value);
            systemConfig.sendSMSAuto = document.getElementById('sendSMSAuto').checked;
            systemConfig.sendEmailAuto = document.getElementById('sendEmailAuto').checked;
            
            // 保存节假日设置
            systemConfig.holidayScheduleMode = document.getElementById('holidayScheduleMode').value;
            systemConfig.autoGenerateHolidaySchedule = document.getElementById('autoGenerateHolidaySchedule').checked;
            systemConfig.excludeHolidayFromFairness = document.getElementById('excludeHolidayFromFairness').checked;
            systemConfig.sendHolidayNotifications = document.getElementById('sendHolidayNotifications').checked;
            
            // 保存邮件配置
            saveEmailConfig();
            
            // 保存到本地存储
            saveSystemConfig();
            
            // 关闭模态框
            const modal = bootstrap.Modal.getInstance(document.getElementById('systemConfigModal'));
            if (modal) {
                modal.hide();
            }
            
            showNotification('系统设置已保存', 'success');
        }

        // 邮件功能相关函数
        // 初始化EmailJS
        function initEmailJS() {
            // 从系统配置加载EmailJS设置
            if (systemConfig.emailConfig.serviceId && systemConfig.emailConfig.userId) {
                emailjs.init(systemConfig.emailConfig.userId);
                return true;
            }
            return false;
        }

        // 发送排班邮件
        async function sendScheduleEmail(employee, scheduleData) {
            if (!systemConfig.emailConfig.enabled || !initEmailJS()) {
                showNotification('邮件功能未配置或未启用', 'warning');
                return false;
            }
            
            const templateParams = {
                to_name: employee.name,
                to_email: employee.email,
                date: scheduleData.date,
                group: scheduleData.group,
                shift: scheduleData.shift,
                time: scheduleData.time,
                employee_name: employee.name
            };
            
            try {
                const result = await emailjs.send(
                    systemConfig.emailConfig.serviceId,
                    systemConfig.emailConfig.templateId,
                    templateParams
                );
                
                console.log('邮件发送成功:', result);
                return true;
            } catch (error) {
                console.error('邮件发送失败:', error);
                showNotification('邮件发送失败: ' + error.text, 'error');
                return false;
            }
        }

        // 发送今日排班邮件给所有员工
        async function sendTodayScheduleEmails() {
            const today = new Date();
            const todayKey = `${today.getFullYear()}-${today.getMonth() + 1}-${today.getDate()}`;
            const todayData = monthlySchedule[todayKey];
            
            if (!todayData) {
                showNotification('今日没有排班数据', 'warning');
                return;
            }
            
            showLoading();
            
            let successCount = 0;
            let failCount = 0;
            
            // 为每个员工发送邮件
            for (const groupKey in groups) {
                const group = groups[groupKey];
                const groupSchedule = todayData.groups[groupKey];
                
                // 获取正常班和晚班员工
                const allScheduledEmployees = [...groupSchedule.normal, ...groupSchedule.evening];
                
                for (const employeeId of allScheduledEmployees) {
                    const employee = getEmployeeById(employeeId);
                    if (employee && employee.email) {
                        const shiftType = groupSchedule.normal.includes(employeeId) ? '正常班' : '晚班';
                        const timeRange = shiftType === '正常班' 
                            ? `${systemConfig.normalStartTime}-${systemConfig.normalEndTime}`
                            : `${systemConfig.eveningStartTime}-${systemConfig.eveningEndTime}`;
                        
                        const scheduleData = {
                            date: `${today.getMonth() + 1}月${today.getDate()}日`,
                            group: group.name,
                            shift: shiftType,
                            time: timeRange
                        };
                        
                        const success = await sendScheduleEmail(employee, scheduleData);
                        if (success) successCount++;
                        else failCount++;
                        
                        // 延迟发送，避免请求过快
                        await new Promise(resolve => setTimeout(resolve, 500));
                    }
                }
            }
            
            hideLoading();
            
            if (successCount > 0) {
                showNotification(`成功发送 ${successCount} 封邮件，失败 ${failCount} 封`, 'success');
            } else {
                showNotification('邮件发送失败，请检查配置', 'error');
            }
        }

        // 发送指定日期的排班邮件
        async function sendEmailForSelectedDay() {
            if (!selectedDay) {
                showNotification('请先选择日期', 'warning');
                return;
            }
            
            await sendScheduleChangeEmails(selectedDay);
        }

        // 发送排班变更邮件
        async function sendScheduleChangeEmails(dateKey) {
            const scheduleData = monthlySchedule[dateKey];
            if (!scheduleData) {
                showNotification('没有排班数据', 'warning');
                return;
            }
            
            showLoading();
            
            let successCount = 0;
            let failCount = 0;
            
            const date = new Date(scheduleData.date);
            const dateStr = `${date.getMonth() + 1}月${date.getDate()}日`;
            
            // 为每个有排班的员工发送邮件
            for (const groupKey in groups) {
                const group = groups[groupKey];
                const groupSchedule = scheduleData.groups[groupKey];
                
                // 获取正常班和晚班员工
                const allScheduledEmployees = [...groupSchedule.normal, ...groupSchedule.evening];
                
                for (const employeeId of allScheduledEmployees) {
                    const employee = getEmployeeById(employeeId);
                    if (employee && employee.email) {
                        const shiftType = groupSchedule.normal.includes(employeeId) ? '正常班' : '晚班';
                        const timeRange = shiftType === '正常班' 
                            ? `${systemConfig.normalStartTime}-${systemConfig.normalEndTime}`
                            : `${systemConfig.eveningStartTime}-${systemConfig.eveningEndTime}`;
                        
                        const scheduleData = {
                            date: dateStr,
                            group: group.name,
                            shift: shiftType,
                            time: timeRange
                        };
                        
                        const success = await sendScheduleEmail(employee, scheduleData);
                        if (success) successCount++;
                        else failCount++;
                        
                        // 延迟发送，避免请求过快
                        await new Promise(resolve => setTimeout(resolve, 500));
                    }
                }
            }
            
            hideLoading();
            
            if (successCount > 0) {
                showNotification(`成功发送 ${successCount} 封排班变更邮件，失败 ${failCount} 封`, 'success');
            } else {
                showNotification('邮件发送失败，请检查配置', 'error');
            }
        }

        // 发送单个员工排班邮件
        async function sendEmployeeScheduleEmail(employeeId, dateKey) {
            const employee = getEmployeeById(employeeId);
            if (!employee || !employee.email) {
                showNotification('员工邮箱不存在', 'warning');
                return false;
            }
            
            const scheduleData = monthlySchedule[dateKey];
            if (!scheduleData) {
                showNotification('没有排班数据', 'warning');
                return false;
            }
            
            // 查找员工所在的组和班次
            for (const groupKey in groups) {
                const groupSchedule = scheduleData.groups[groupKey];
                
                if (groupSchedule.normal.includes(employeeId) || groupSchedule.evening.includes(employeeId)) {
                    const shiftType = groupSchedule.normal.includes(employeeId) ? '正常班' : '晚班';
                    const timeRange = shiftType === '正常班' 
                        ? `${systemConfig.normalStartTime}-${systemConfig.normalEndTime}`
                        : `${systemConfig.eveningStartTime}-${systemConfig.eveningEndTime}`;
                    
                    const scheduleData = {
                        date: `${new Date(scheduleData.date).getMonth() + 1}月${new Date(scheduleData.date).getDate()}日`,
                        group: groups[groupKey].name,
                        shift: shiftType,
                        time: timeRange
                    };
                    
                    return await sendScheduleEmail(employee, scheduleData);
                }
            }
            
            showNotification('员工今日无排班', 'info');
            return false;
        }

        // 加载邮件配置到表单
        function loadEmailConfig() {
            document.getElementById('emailServiceId').value = systemConfig.emailConfig.serviceId || '';
            document.getElementById('emailTemplateId').value = systemConfig.emailConfig.templateId || '';
            document.getElementById('emailUserId').value = systemConfig.emailConfig.userId || '';
            document.getElementById('emailEnabled').checked = systemConfig.emailConfig.enabled || false;
        }

        // 保存邮件配置
        function saveEmailConfig() {
            systemConfig.emailConfig.serviceId = document.getElementById('emailServiceId').value.trim();
            systemConfig.emailConfig.templateId = document.getElementById('emailTemplateId').value.trim();
            systemConfig.emailConfig.userId = document.getElementById('emailUserId').value.trim();
            systemConfig.emailConfig.enabled = document.getElementById('emailEnabled').checked;
            
            saveSystemConfig();
            showNotification('邮件配置已保存', 'success');
        }

        // 发送测试邮件
        async function sendTestEmail() {
            if (!systemConfig.emailConfig.serviceId || !systemConfig.emailConfig.userId) {
                showNotification('请先配置邮件服务', 'warning');
                return;
            }
            
            try {
                // 查找管理员邮箱
                const adminEmail = getAdminEmail();
                
                showLoading();
                
                emailjs.init(systemConfig.emailConfig.userId);
                
                const result = await emailjs.send(
                    systemConfig.emailConfig.serviceId,
                    systemConfig.emailConfig.templateId,
                    {
                        to_name: '管理员',
                        to_email: adminEmail || 'test@example.com',
                        date: new Date().toLocaleDateString('zh-CN'),
                        group: '测试组',
                        shift: '正常班',
                        time: '10:00-19:00',
                        employee_name: '测试用户'
                    }
                );
                
                hideLoading();
                showNotification('测试邮件发送成功', 'success');
            } catch (error) {
                hideLoading();
                showNotification('测试邮件发送失败: ' + error.text, 'error');
            }
        }

        // 获取管理员邮箱
        function getAdminEmail() {
            // 这里可以返回固定的管理员邮箱，或者从配置中读取
            return systemConfig.adminEmail || 'admin@company.com';
        }

        // 通知系统功能
        function openSendNotificationModal() {
            document.getElementById('notificationForm').reset();
            
            const modal = new bootstrap.Modal(document.getElementById('sendNotificationModal'));
            modal.show();
        }

        function confirmSendNotification() {
            const type = document.getElementById('notificationType').value;
            const recipients = document.getElementById('notificationRecipients').value;
            const message = document.getElementById('notificationMessage').value.trim();
            const sendSMS = document.getElementById('sendSMS').checked;
            const sendEmail = document.getElementById('sendEmail').checked;
            
            if (!message) {
                showNotification('请输入通知内容', 'warning');
                return;
            }
            
            let recipientNames = [];
            if (recipients === 'all') {
                Object.keys(groups).forEach(groupKey => {
                    recipientNames = recipientNames.concat(groups[groupKey].members.map(m => m.name));
                });
            } else {
                recipientNames = groups[recipients].members.map(m => m.name);
            }
            
            const notificationMessage = `[${type}] ${message}\n接收人: ${recipientNames.join(', ')}`;
            addNotification('手动通知', notificationMessage, 'manual');
            
            // 模拟发送
            if (sendSMS) {
                console.log('发送短信给:', recipientNames);
            }
            if (sendEmail) {
                console.log('发送邮件给:', recipientNames);
            }
            
            // 关闭模态框
            const modal = bootstrap.Modal.getInstance(document.getElementById('sendNotificationModal'));
            if (modal) {
                modal.hide();
            }
            
            showNotification('通知已发送', 'success');
        }

        function filterNotifications(filter) {
            const container = document.getElementById('notificationList');
            let filteredNotifications = [...notifications];
            
            if (filter === 'unread') {
                filteredNotifications = filteredNotifications.filter(n => !n.read);
            } else if (filter === 'read') {
                filteredNotifications = filteredNotifications.filter(n => n.read);
            }
            
            renderNotificationList(filteredNotifications);
        }

        function renderNotificationList(notificationsToRender) {
            const container = document.getElementById('notificationList');
            
            if (notificationsToRender.length === 0) {
                container.innerHTML = '<div class="text-center py-4"><i class="fas fa-bell-slash text-muted fa-2x mb-2"></i><p class="text-muted">暂无消息</p></div>';
                return;
            }
            
            let html = '';
            notificationsToRender.reverse().forEach(notification => {
                const timeStr = notification.timestamp.toLocaleString('zh-CN');
                const isUnread = !notification.read;
                
                html += `
                    <div class="notification-item border rounded p-3 mb-2 ${isUnread ? 'border-primary bg-light' : ''}">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <h6 class="mb-1">${notification.title}</h6>
                                <p class="mb-1 small">${notification.message}</p>
                                <div class="small text-muted">${timeStr}</div>
                            </div>
                            <div class="ms-2">
                                ${isUnread ? 
                                    `<button class="btn btn-sm btn-outline-primary mark-as-read" data-id="${notification.id}">
                                        <i class="fas fa-check"></i>
                                    </button>` : 
                                    `<span class="badge bg-success">已读</span>`
                                }
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
            
            // 添加标记为已读的事件监听
            document.querySelectorAll('.mark-as-read').forEach(btn => {
                btn.addEventListener('click', function() {
                    const notificationId = parseInt(this.getAttribute('data-id'));
                    const notification = notifications.find(n => n.id === notificationId);
                    if (notification) {
                        notification.read = true;
                        updateNotificationCount();
                        renderNotificationList(notifications);
                    }
                });
            });
        }

        function clearNotifications() {
            showConfirmModal(
                '清空消息',
                '确定要清空所有消息吗？此操作不可恢复。',
                function() {
                    notifications = [];
                    updateNotificationCount();
                    renderNotificationList([]);
                    showNotification('消息已清空', 'success');
                }
            );
        }

        // 确认操作功能
        function showConfirmModal(title, message, callback) {
            document.getElementById('confirmModalTitle').textContent = title;
            document.getElementById('confirmModalMessage').textContent = message;
            pendingAction = callback;
            
            const modal = new bootstrap.Modal(document.getElementById('confirmModal'));
            modal.show();
        }

        function executePendingAction() {
            if (pendingAction) {
                pendingAction();
                pendingAction = null;
            }
            
            const modal = bootstrap.Modal.getInstance(document.getElementById('confirmModal'));
            if (modal) {
                modal.hide();
            }
        }

        // 批量操作功能
        function toggleBatchActions() {
            const batchActions = document.getElementById('batchActions');
            if (batchActions.style.display === 'none') {
                batchActions.style.display = 'block';
            } else {
                batchActions.style.display = 'none';
            }
        }

        function cancelBatchAction() {
            document.getElementById('batchActions').style.display = 'none';
        }

        function applyBatchAction() {
            const startDate = document.getElementById('batchStartDate').value;
            const endDate = document.getElementById('batchEndDate').value;
            const action = document.getElementById('batchAction').value;
            const groupOption = document.getElementById('batchGroup').value;
            
            if (!startDate || !endDate) {
                document.getElementById('batchDateError').textContent = '请选择完整的日期范围';
                document.getElementById('batchStartDate').classList.add('is-invalid');
                document.getElementById('batchEndDate').classList.add('is-invalid');
                return;
            }
            
            // 清除验证错误
            document.getElementById('batchStartDate').classList.remove('is-invalid');
            document.getElementById('batchEndDate').classList.remove('is-invalid');
            
            let groupKeys = [];
            if (groupOption === 'all') {
                groupKeys = Object.keys(groups);
            } else {
                groupKeys = [groupOption];
            }
            
            showLoading();
            
            setTimeout(() => {
                let modifiedDays = 0;
                for (let date = new Date(startDate); date <= new Date(endDate); date.setDate(date.getDate() + 1)) {
                    const dateKey = `${date.getFullYear()}-${date.getMonth() + 1}-${date.getDate()}`;
                    if (monthlySchedule[dateKey]) {
                        const dayData = monthlySchedule[dateKey];
                        
                        groupKeys.forEach(groupKey => {
                            const groupSchedule = dayData.groups[groupKey];
                            
                            // 重置排班（保留请假和出差人员）
                            const leaves = [...groupSchedule.leave];
                            const travels = [...groupSchedule.travel];
                            
                            groupSchedule.normal = [];
                            groupSchedule.evening = [];
                            groupSchedule.off = [];
                            groupSchedule.leave = leaves;
                            groupSchedule.travel = travels;
                            
                            // 根据操作类型设置排班
                            if (action === 'set_normal') {
                                // 安排正常班（排除请假和出差人员）
                                const activeMembers = groups[groupKey].members.filter(m => 
                                    m.active && 
                                    !leaves.includes(m.id) && 
                                    !travels.includes(m.id)
                                );
                                
                                const count = Math.min(groups[groupKey].normalCount, activeMembers.length);
                                for (let i = 0; i < count; i++) {
                                    groupSchedule.normal.push(activeMembers[i].id);
                                }
                                
                                // 安排晚班
                                const remainingMembers = activeMembers.filter(m => !groupSchedule.normal.includes(m.id));
                                const eveningCount = Math.min(groups[groupKey].eveningCount, remainingMembers.length);
                                for (let i = 0; i < eveningCount; i++) {
                                    groupSchedule.evening.push(remainingMembers[i].id);
                                }
                                
                                // 其余为空闲
                                activeMembers.forEach(member => {
                                    if (!groupSchedule.normal.includes(member.id) && !groupSchedule.evening.includes(member.id)) {
                                        groupSchedule.off.push(member.id);
                                    }
                                });
                            } else if (action === 'set_evening') {
                                // 只安排晚班（排除请假和出差人员）
                                const activeMembers = groups[groupKey].members.filter(m => 
                                    m.active && 
                                    !leaves.includes(m.id) && 
                                    !travels.includes(m.id)
                                );
                                
                                const count = Math.min(groups[groupKey].eveningCount, activeMembers.length);
                                for (let i = 0; i < count; i++) {
                                    groupSchedule.evening.push(activeMembers[i].id);
                                }
                                
                                // 其余为空闲
                                activeMembers.forEach(member => {
                                    if (!groupSchedule.evening.includes(member.id)) {
                                        groupSchedule.off.push(member.id);
                                    }
                                });
                            } else if (action === 'set_off') {
                                // 全部设为空闲（排除请假和出差人员）
                                const activeMembers = groups[groupKey].members.filter(m => 
                                    m.active && 
                                    !leaves.includes(m.id) && 
                                    !travels.includes(m.id)
                                );
                                
                                groupSchedule.off = activeMembers.map(m => m.id);
                            }
                        });
                        
                        validateDailySchedule(dayData);
                        modifiedDays++;
                    }
                }
                
                renderCalendar();
                updateStatistics();
                
                scheduleHistory.push({
                    action: '批量操作',
                    timestamp: new Date(),
                    details: `修改了 ${modifiedDays} 天的排班，操作类型: ${getActionName(action)}`
                });
                
                renderScheduleHistory();
                saveAllData();
                
                document.getElementById('batchActions').style.display = 'none';
                
                hideLoading();
                showNotification(`批量操作完成，修改了 ${modifiedDays} 天的排班`, 'success');
            }, 100);
        }

        function getActionName(action) {
            const actions = {
                'set_off': '设为空闲',
                'set_normal': '设为正常班',
                'set_evening': '设为晚班'
            };
            return actions[action] || action;
        }

        // 数据备份功能
        function backupAllData() {
            showLoading();
            
            setTimeout(() => {
                const employees = [];
                Object.keys(groups).forEach(groupKey => {
                    employees.push(...groups[groupKey].members);
                });
                
                const backupData = {
                    employees: employees,
                    monthlySchedule: monthlySchedule,
                    replacementRecords: replacementRecords,
                    leaveRecords: leaveRecords,
                    travelRecords: travelRecords,
                    notifications: notifications,
                    scheduleHistory: scheduleHistory,
                    systemConfig: systemConfig,
                    backupTime: new Date().toISOString()
                };
                
                const result = saveAllData();
                if (result) {
                    systemConfig.lastBackupTime = new Date().toISOString();
                    saveSystemConfig();
                    
                    hideLoading();
                    showNotification('数据备份成功', 'success');
                    updateSystemStatus();
                } else {
                    hideLoading();
                    showNotification('数据备份失败', 'error');
                }
            }, 500);
        }

        // 数据导出功能
        function exportData() {
            const employees = [];
            Object.keys(groups).forEach(groupKey => {
                employees.push(...groups[groupKey].members);
            });
            
            const backupData = {
                employees: employees,
                monthlySchedule: monthlySchedule,
                replacementRecords: replacementRecords,
                leaveRecords: leaveRecords,
                travelRecords: travelRecords,
                notifications: notifications,
                scheduleHistory: scheduleHistory,
                systemConfig: systemConfig,
                exportTime: new Date().toISOString()
            };
            
            const dataStr = JSON.stringify(backupData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `department_schedule_backup_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            showNotification('数据导出成功', 'success');
        }

        // 触发数据导入
        function triggerImportData() {
            document.getElementById('importDataFile').click();
        }

        // 数据导入功能
        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    
                    // 验证导入数据格式
                    if (!importedData.employees || !importedData.monthlySchedule) {
                        throw new Error('导入文件格式不正确');
                    }
                    
                    showConfirmModal(
                        '导入数据',
                        '确定要导入数据吗？这将覆盖当前所有数据。',
                        function() {
                            // 更新员工数据
                            Object.keys(groups).forEach(groupKey => {
                                groups[groupKey].members.forEach(member => {
                                    const savedMember = importedData.employees.find(e => e.id === member.id);
                                    if (savedMember) {
                                        member.workDays = savedMember.workDays || 0;
                                        member.leaveDays = savedMember.leaveDays || 0;
                                        member.travelDays = savedMember.travelDays || 0;
                                        member.lastShift = savedMember.lastShift || null;
                                    }
                                });
                            });
                            
                            monthlySchedule = importedData.monthlySchedule;
                            replacementRecords = importedData.replacementRecords || [];
                            leaveRecords = importedData.leaveRecords || [];
                            travelRecords = importedData.travelRecords || [];
                            notifications = importedData.notifications || [];
                            scheduleHistory = importedData.scheduleHistory || [];
                            systemConfig = {...systemConfig, ...importedData.systemConfig};
                            
                            // 重新初始化系统
                            initializeSystem();
                            showNotification('数据导入成功', 'success');
                        }
                    );
                } catch (error) {
                    showNotification('导入失败: ' + error.message, 'error');
                }
            };
            reader.readAsText(file);
            
            // 清空文件输入
            event.target.value = '';
        }

        // 工具函数
        function getEmployeeById(id) {
            for (const groupKey in groups) {
                const employee = groups[groupKey].members.find(e => e.id === id);
                if (employee) return employee;
            }
            return null;
        }

        function previousMonth() {
            // 修改：限制不能导航到2026年1月之前
            const newDate = new Date(currentDate);
            newDate.setMonth(currentDate.getMonth() - 1);
            
            // 检查是否早于2026年1月
            if (newDate.getFullYear() < 2026 || 
                (newDate.getFullYear() === 2026 && newDate.getMonth() < 0)) {
                showNotification('无法查看2026年1月之前的排班', 'warning');
                return;
            }
            
            currentDate = newDate;
            generateMonthlySchedule();
            renderCalendar();
            updateStatistics();
            
            // 隐藏当日排班详情
            document.getElementById('dailyScheduleDetail').style.display = 'none';
        }

        function nextMonth() {
            currentDate.setMonth(currentDate.getMonth() + 1);
            generateMonthlySchedule();
            renderCalendar();
            updateStatistics();
            
            // 隐藏当日排班详情
            document.getElementById('dailyScheduleDetail').style.display = 'none';
        }

        function updateCurrentMonthDisplay() {
            const monthNames = ['1月', '2月', '3月', '4月', '5月', '6月', '7月', '8月', '9月', '10月', '11月', '12月'];
            const monthName = monthNames[currentDate.getMonth()];
            const year = currentDate.getFullYear();
            document.getElementById('currentMonth').textContent = `${year}年${monthName}`;
        }

        function startRealTimeUpdates() {
            updateDateTime();
            setInterval(updateDateTime, 1000);
        }

        function updateDateTime() {
            const now = new Date();
            const year = now.getFullYear();
            const month = now.getMonth() + 1;
            const date = now.getDate();
            const day = now.getDay();
            const weekdays = ['星期日', '星期一', '星期二', '星期三', '星期四', '星期五', '星期六'];
            const hours = now.getHours().toString().padStart(2, '0');
            const minutes = now.getMinutes().toString().padStart(2, '0');
            const seconds = now.getSeconds().toString().padStart(2, '0');
            const dateTimeStr = `${year}年${month}月${date}日 ${weekdays[day]} ${hours}:${minutes}:${seconds}`;
            document.getElementById('currentDateTime').textContent = dateTimeStr;
        }

        function showNotification(message, type = 'info') {
            const toastContainer = document.querySelector('.toast-container');
            const toastId = 'toast-' + Date.now();
            
            const bgClass = type === 'success' ? 'bg-success' : 
                           type === 'error' ? 'bg-danger' : 
                           type === 'warning' ? 'bg-warning' : 'bg-info';
            
            const toastHTML = `
                <div id="${toastId}" class="toast align-items-center text-white ${bgClass} border-0" role="alert">
                    <div class="d-flex">
                        <div class="toast-body">
                            ${message}
                        </div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                    </div>
                </div>
            `;
            
            toastContainer.insertAdjacentHTML('beforeend', toastHTML);
            
            const toastElement = document.getElementById(toastId);
            const toast = new bootstrap.Toast(toastElement, { delay: 3000 });
            toast.show();
            
            // 自动移除DOM元素
            toastElement.addEventListener('hidden.bs.toast', function() {
                toastElement.remove();
            });
        }

        function addNotification(title, message, type) {
            const notification = {
                id: Date.now(),
                type: type,
                title: title,
                message: message,
                timestamp: new Date(),
                read: false
            };
            
            notifications.push(notification);
            renderPendingNotifications();
            updateNotificationCount();
            
            // 如果消息中心是打开的，更新显示
            if (document.getElementById('notificationModal').classList.contains('show')) {
                renderNotificationList(notifications);
            }
        }

        function sendDailyNotifications() {
            const today = new Date();
            const todayKey = `${today.getFullYear()}-${today.getMonth() + 1}-${today.getDate()}`;
            const todayData = monthlySchedule[todayKey];
            
            if (!todayData) return;
            
            const dateStr = `${today.getMonth() + 1}月${today.getDate()}日`;
            
            // 发送邮件通知
            if (systemConfig.emailConfig.enabled && systemConfig.sendEmailAuto) {
                sendTodayScheduleEmails();
            }
            
            let message = `今日排班通知 (${dateStr}):\n\n`;
            
            Object.keys(groups).forEach(groupKey => {
                const group = groups[groupKey];
                const groupSchedule = todayData.groups[groupKey];
                
                message += `${group.name}:\n`;
                
                // 正常班
                if (groupSchedule.normal.length > 0) {
                    const normal = groupSchedule.normal.map(id => {
                        const e = getEmployeeById(id);
                        return groupSchedule.originalNormal.includes(id) ? e.name : `${e.name}(顶班)`;
                    }).join('、');
                    message += `  正常班: ${normal} (${systemConfig.normalStartTime}-${systemConfig.normalEndTime})\n`;
                }
                
                // 晚班
                if (groupSchedule.evening.length > 0) {
                    const evening = groupSchedule.evening.map(id => {
                        const e = getEmployeeById(id);
                        return groupSchedule.originalEvening.includes(id) ? e.name : `${e.name}(顶班)`;
                    }).join('、');
                    message += `  晚班: ${evening} (${systemConfig.eveningStartTime}-${systemConfig.eveningEndTime})\n`;
                }
                
                // 请假人员
                if (groupSchedule.leave.length > 0) {
                    const leave = groupSchedule.leave.map(id => getEmployeeById(id).name).join('、');
                    message += `  请假: ${leave}\n`;
                }
                
                // 出差人员
                if (groupSchedule.travel.length > 0) {
                    const travel = groupSchedule.travel.map(id => {
                        const e = getEmployeeById(id);
                        const travelInfo = getEmployeeTravelInfo(id, today);
                        return travelInfo ? `${e.name} (${travelInfo.destination || '出差'})` : e.name;
                    }).join('、');
                    message += `  出差: ${travel}\n`;
                }
                
                message += '\n';
            });
            
            const notification = {
                id: Date.now(),
                type: 'daily_schedule',
                title: '今日排班通知',
                message: message,
                timestamp: new Date(),
                read: false
            };
            
            notifications.push(notification);
            
            // 模拟发送给所有员工
            if (systemConfig.sendSMSAuto) {
                Object.keys(groups).forEach(groupKey => {
                    groups[groupKey].members.forEach(member => {
                        console.log(`发送今日排班通知给 ${member.name}: ${member.phone}`);
                    });
                });
            }
            
            renderPendingNotifications();
            updateNotificationCount();
            showNotification('今日排班通知已发送给所有员工', 'success');
        }

        function renderAdjustmentRecords() {
            const container = document.getElementById('adjustmentRecords');
            if (replacementRecords.length === 0) {
                container.innerHTML = '<p class="text-muted small mb-0">暂无调整记录</p>';
            } else {
                let html = '';
                replacementRecords.slice(-5).reverse().forEach(record => {
                    const original = getEmployeeById(record.original);
                    const replacement = getEmployeeById(record.replacement);
                    if (original && replacement) {
                        html += `
                            <div class="small mb-2">
                                <div>${record.date} ${record.time}</div>
                                <div class="text-muted">${replacement.name} 顶替 ${original.name}</div>
                        </div>
                        `;
                    }
                });
                container.innerHTML = html;
            }
        }

        function renderPendingNotifications() {
            const container = document.getElementById('pendingNotifications');
            const unreadNotifications = notifications.filter(n => !n.read);
            
            if (unreadNotifications.length === 0) {
                container.innerHTML = '<p class="text-muted small mb-0">暂无待发送通知</p>';
            } else {
                let html = '';
                unreadNotifications.slice(-3).reverse().forEach(notification => {
                    html += `
                        <div class="small mb-2">
                            <div class="fw-bold">${notification.title}</div>
                            <div class="text-muted">${notification.message.substring(0, 50)}...</div>
                        </div>
                    `;
                });
                container.innerHTML = html;
            }
        }

        function updateNotificationCount() {
            const unreadCount = notifications.filter(n => !n.read).length;
            document.getElementById('notificationCount').textContent = unreadCount;
        }

        function updateStatistics() {
            // 计算总工作日（节假日不计入）
            let totalWorkDays = 0;
            let validDaysCount = 0;
            let totalTravelCount = 0;
            
            // 计算总出差人次
            Object.values(travelRecords).forEach(record => {
                const startDate = new Date(record.startDate);
                const endDate = new Date(record.endDate);
                const daysDiff = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24)) + 1;
                totalTravelCount += daysDiff;
            });
            
            Object.entries(monthlySchedule).forEach(([dateKey, day]) => {
                // 如果启用了节假日不计入，且是节假日，则跳过
                if (systemConfig.excludeHolidayFromFairness && day.isSpecial) {
                    return;
                }
                
                validDaysCount++;
                Object.keys(groups).forEach(groupKey => {
                    totalWorkDays += day.groups[groupKey].normal.length;
                    totalWorkDays += day.groups[groupKey].evening.length;
                });
            });
            
            document.getElementById('totalWorkDays').textContent = totalWorkDays;
            
            // 计算顶班次数
            document.getElementById('totalReplacements').textContent = replacementRecords.length;
            
            // 计算请假次数
            document.getElementById('totalLeaves').textContent = leaveRecords.length;
            
            // 计算出差人次
            document.getElementById('totalTravels').textContent = totalTravelCount;
            
            // 计算公平度（排除节假日）
            const allEmployees = [];
            Object.keys(groups).forEach(groupKey => {
                allEmployees.push(...groups[groupKey].members);
            });
            
            const workDaysArray = allEmployees.filter(e => e.active).map(e => e.workDays);
            const maxWorkDays = Math.max(...workDaysArray);
            const minWorkDays = Math.min(...workDaysArray);
            
            let fairness = 100;
            if (maxWorkDays > 0) {
                fairness = Math.round((1 - (maxWorkDays - minWorkDays) / maxWorkDays) * 100);
            }
            
            document.getElementById('fairnessScore').textContent = `${fairness}%`;
            
            // 如果公平度低于阈值，显示警告
            if (fairness < systemConfig.fairnessThreshold) {
                document.getElementById('fairnessScore').parentElement.classList.add('text-warning');
            } else {
                document.getElementById('fairnessScore').parentElement.classList.remove('text-warning');
            }
        }

        function renderScheduleHistory() {
            const container = document.getElementById('scheduleHistory');
            
            if (scheduleHistory.length === 0) {
                container.innerHTML = '<p class="text-muted small mb-0">暂无历史记录</p>';
                return;
            }
            
            let html = '';
            scheduleHistory.slice(-5).reverse().forEach(record => {
                const timeStr = record.timestamp.toLocaleString('zh-CN');
                html += `
                    <div class="history-item p-2 border-start border-primary bg-light mb-2">
                        <div class="small">
                            <strong>${record.action}</strong>
                            <div class="text-muted">${timeStr}</div>
                            <div>${record.details}</div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function updateSystemStatus() {
            const integrityStatus = document.getElementById('dataIntegrityStatus');
            const lastBackupTime = document.getElementById('lastBackupTime');
            const emailStatus = document.getElementById('emailStatus');
            
            // 简化数据完整性检查
            let issues = 0;
            Object.keys(groups).forEach(groupKey => {
                groups[groupKey].members.forEach(member => {
                    if (!member.name || member.name.trim() === '') {
                        issues++;
                    }
                });
            });
            
            if (issues === 0) {
                integrityStatus.textContent = '正常';
                integrityStatus.className = 'badge bg-success';
            } else {
                integrityStatus.textContent = `${issues}个问题`;
                integrityStatus.className = 'badge bg-warning';
            }
            
            if (systemConfig.lastBackupTime) {
                lastBackupTime.textContent = new Date(systemConfig.lastBackupTime).toLocaleString('zh-CN');
            } else {
                lastBackupTime.textContent = '从未备份';
            }
            
            // 更新邮件状态
            if (systemConfig.emailConfig.enabled && 
                systemConfig.emailConfig.serviceId && 
                systemConfig.emailConfig.userId) {
                emailStatus.textContent = '已启用';
                emailStatus.className = 'badge bg-success';
            } else {
                emailStatus.textContent = '未配置';
                emailStatus.className = 'badge bg-secondary';
            }
        }

        function renderNextDaySchedulePreview() {
            const container = document.getElementById('nextDaySchedulePreview');
            
            // 获取明天的日期
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            const tomorrowKey = `${tomorrow.getFullYear()}-${tomorrow.getMonth() + 1}-${tomorrow.getDate()}`;
            
            // 获取排班数据
            const schedule = monthlySchedule[tomorrowKey];
            if (!schedule) {
                container.innerHTML = '<div class="text-center py-2"><i class="fas fa-calendar-times text-muted fa-2x mb-2"></i><p class="text-muted small">暂无明日排班数据</p></div>';
                return;
            }
            
            const dateStr = `${tomorrow.getMonth() + 1}月${tomorrow.getDate()}日`;
            let html = `
                <div class="next-day-schedule">
                    <h6 class="mb-3">${dateStr} 排班预览</h6>
            `;
            
            // 工作人员
            let normalCount = 0;
            let eveningCount = 0;
            let travelCount = 0;
            
            Object.keys(groups).forEach(groupKey => {
                const groupSchedule = schedule.groups[groupKey];
                normalCount += groupSchedule.normal.length;
                eveningCount += groupSchedule.evening.length;
                travelCount += groupSchedule.travel.length;
            });
            
            html += `<div class="mb-2"><strong>正常班:</strong> ${normalCount}人</div>`;
            html += `<div class="mb-2"><strong>晚班:</strong> ${eveningCount}人</div>`;
            html += `<div class="mb-2"><strong>出差:</strong> ${travelCount}人</div>`;
            
            // 显示有排班的组别
            html += `<div class="mt-3"><strong>有排班的组别:</strong></div>`;
            Object.keys(groups).forEach(groupKey => {
                const groupSchedule = schedule.groups[groupKey];
                if (groupSchedule.normal.length > 0 || groupSchedule.evening.length > 0 || groupSchedule.travel.length > 0) {
                    html += `<div class="small">${groups[groupKey].name}: 正常班${groupSchedule.normal.length}人, 晚班${groupSchedule.evening.length}人, 出差${groupSchedule.travel.length}人</div>`;
                }
            });
            
            html += `</div>`;
            container.innerHTML = html;
        }
    </script>
</body>
</html>
